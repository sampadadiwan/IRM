<%= render FormCard.new(title: "User") do %>

  <%= form_with(model: user, data: {"turbo": "false"}, validate: true) do |form| %>
    <% if user.errors.any? %>
      <div class="alert alert-danger">
        <h2><%= pluralize(user.errors.count, "error") %> prohibited this user from being saved:</h2>

        <ul>
          <% user.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= form.label :first_name %>
      <%= form.text_field :first_name, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= form.label :last_name %>
      <%= form.text_field :last_name, class: "form-control" %>
    </div>

    <% disabled = !user.new_record?  %>
    <div class="form-group">
      <%= form.label :email %>
      <%= form.text_field :email, class: "form-control", autocomplete: "nope", disabled:  %>
    </div>

    <div class="row">
      <div class="form-group col-5">
        <%= form.label "Country Code" %>
        <%= form.number_field :call_code, class: "form-control" %>
      </div>
      <div class="form-group col-7">
        <%= form.label :phone %>
        <%= form.number_field :phone, class: "form-control"  %>
      </div>
    </div>



    <div class="form-group">
      <%= render "layouts/single_upload", form: form, field_label: "Upload Signature Image (jpg or png only)",
                              for_model: "user", field_name: "signature",
                              model: user, allowed_types: ['image/*'].freeze %>

    </div>

    <div class="form-group">
      <%= form.label :dept, "Department" %>
      <%= form.text_field :dept, class: "form-control" %>
    </div>


    <% if !user.id.present? %>
      <div class="form-group">
        <%= form.label :password %>
        <%= form.password_field :password, class: "form-control", autocomplete: "new-password", required: true %>
      </div>

      <div class="form-group">
        <%= form.label :password_confirmation %>
        <%= form.password_field :password_confirmation, class: "form-control", autocomplete: "new-password", required: true %>
      </div>
    <% end %>

    <% if current_user.has_cached_role?(:company_admin) %>

      <% if user.id.present? %>
      <div class="form-group">
        <%= form.label :roles %>
        <%= form.select :roles, ["company_admin"], {selected: user.roles.collect(&:name), include_hidden: false}, class: "form-control select2", multiple: true, name: "user[role_name][]" %>
      </div>
      <% end %>

          
      <% unless user.has_cached_role?(:company_admin) %>
        <div class="associated_entity row">
        <% User.extended_permissions.pairs.each do |key, val| %>
          <div class="form-group col">
              <%= form.label :extended_permissions, key.titleize, class: "no-wrap" %>
              <%= form.check_box :extended_permissions, {name: "user[extended_permissions][]",
                  val: val, id: "extended_permissions#{val}", class: "form-check-input"}, val, nil   %>
          </div>      
        <% end %>
        </div>
      <% end %>

    <% end %>

    <div class="form-group">
      <%= form.label :whatsapp_enabled %>
      <%= form.check_box :whatsapp_enabled, class: "form-check-input" %>
    </div>

    <div class="form-group">
      <%= form.label :enable_support %>
      <%= form.check_box :enable_support, class: "form-check-input" %>
    </div>

    <%= custom_form_fields(user, form) %>


    <%= form.text_field :entity_id, class: "form-control", hidden: true %>

    <% if current_user.has_cached_role?(:company_admin) %>
    
      <div class="associated_entity row">

        <% User.permissions.pairs.each do |key, val| %>
          <% if user.entity.permissions.send("#{val}?") %>
            <div class="form-group col-6">
              <%= form.label :permissions, key.titleize, class: "no-wrap" %>
              <%= form.check_box :permissions, {name: "user[permissions][]",
                  val: val, id: "permissions_#{val}", class: "form-check-input"}, val, nil   %>
            </div>
            <% end %>
        <% end %>
      </div>

    <% end %>

    <div class="form-group">
      <%= form.submit "Save", {class: "btn btn-outline-primary"} %>
    </div>
  <% end %>

<% end %>
