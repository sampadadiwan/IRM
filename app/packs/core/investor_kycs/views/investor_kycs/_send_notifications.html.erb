<% email_actions = {
  "notify_kyc_required" => {
    label: "Send KYC Required Notification",
    policy: :notify_kyc_required?,
    path_helper: :notify_kyc_required_investor_kyc_path
  },
  "kyc_required_reminder" => {
    label: "Send KYC Reminder",
    policy: :send_kyc_reminder?,
    path_helper: :send_kyc_reminder_investor_kyc_path
  }
} %>

<% custom_notifications_map = current_user.entity.custom_notifications
                             .for_type("InvestorKyc")
                             .group_by(&:email_method) %>

<% email_actions.each do |email_method, config| %>
  <% if policy(@investor_kyc).public_send(config[:policy]) %>

    <% notifications = custom_notifications_map[email_method] %>

    <% if notifications.present? %>
      <% notifications.each_with_index do |custom_notification, i| %>
        <%= button_to send(config[:path_helper],@investor_kyc, email_method: email_method, custom_notification_id: custom_notification.id),
            id: "investor_kyc_#{email_method}_custom_#{i}_btn", method: :post, class: "dropdown-item", form_class: "deleteButton",
            data: {
              action: "click->confirm#popup", turbo: false, method: :post,
              msg: "This will generate a notification to all users associated with this investor"
            } do %>
          <i class="ti ti-mail"></i><%= "#{config[:label]} (#{custom_notification.tag || notification.id})" %>
        <% end %>
      <% end %>
    <% else %>
      <%= button_to send(config[:path_helper], @investor_kyc),
          id: "investor_kyc_#{email_method}_default_btn", method: :post, class: "dropdown-item", form_class: "deleteButton",
          data: {
            action: "click->confirm#popup", turbo: false, method: :post,
            msg: "This will generate a notification to all users associated with this investor"
          } do %>
        <i class="ti ti-bell"></i><%= config[:label] %>
      <% end %>
    <% end %>

  <% end %>
<% end %>
