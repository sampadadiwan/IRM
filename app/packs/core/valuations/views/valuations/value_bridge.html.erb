
<%= turbo_frame_tag "value_bridge_frame" do %>


<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Value Bridge for <%= @initial_valuation.investment_instrument.name%> : <%= l @initial_valuation.valuation_date %> - <%= l @final_valuation.valuation_date %></h1>
    
    <span>
    
    </span>
</div>

<div class="table-responsive" data-controller="datatable">
<% 
    bridge_fields = ["Entry"] + ValueBridgeService::VALUE_BRIDGE_FIELDS 
    waterfall_chart_data = []
%>
<table class="table table-bordered dataTable">

    <!-- Header row -->
    <thead>
    <tr>
        <th>
        </th>
        <% bridge_fields.each_with_index do |bridge_field, idx| %>
            <th>
                <%= bridge_field %>
            </th>
            <% 
                value = idx == 0 ? @bridge[bridge_field].json_fields["enterprise_value"]  : @bridge[bridge_field].json_fields["enterprise_value_change"] 
                
                if idx == 0
                    color = "#212529"
                else
                    color = value && value > 0 ? "#198754" : "#dc3545"
                end

                waterfall_chart_data << { name: bridge_field, y: value, color: color } 
            %>
        <% end %>

        <% waterfall_chart_data << { name: "Exit", y: @bridge["Exit"].json_fields["enterprise_value"], isSum: true, color: "#212529" } %>
    </tr>
    </thead>

    <!-- Body rows -->
    <tbody>
    <% ValueBridgeService::KEY_FIELDS.each do |key| %>    
        
        <tr>
            <td>
                <span class="text-primary"><%= key %></span>
            </td>
            <% bridge_fields.each_with_index do |bridge_field, idx| %>    
                <td>
                    <% 
                        bridge_field_name = FormCustomField.to_name(bridge_field) 
                        key_name = FormCustomField.to_name(key)                        
                    %>
                    <%= @bridge[bridge_field].json_fields[key_name] %>

                </td>                
            <% end %>
        </tr>
        
    <% end %>
    </tbody>
</table>


</div>

<div class="associated_entity" data-controller="valuebridge">
    <div id="waterfall-chart" 
        data-chart-values="<%= json_escape(waterfall_chart_data.map(&:to_h).to_json) %>
"></div>
</div>

<% end %>