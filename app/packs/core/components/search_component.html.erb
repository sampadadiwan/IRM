<div class="nested-fields">  
  <%= form_with(method: :get, url: @data_source,  data: { turbo_frame: @turbo_frame}, class: "d-flex justify-content-between align-items-center") do |form| %>
    <div class="d-flex align-items-center" style="max-width: 160px;">
      <% current_per_page = params.dig("per_page").presence || 10 %>
      <%= form.number_field "per_page", { id: "per_page_input", class: "form-control", style: "width: 90px;", data: { target: "search.perPageInput", toggle: "tooltip", title: "Items per page" }, value: current_per_page } %>
      <small class="ms-2">per page</small>
    </div>

    <div class="d-flex align-items-center" style="max-width: 400px; width: 100%;">
      <% current_input = params.dig("search", "value").presence || nil %>
      <%= form.text_field "search[value]", { id: "search_input", class: "form-control", data: { target: "search.searchInput", action: "keydown->search#debouncedSearchInput", toggle: "tooltip", title: "Type to search" }, value: current_input, placeholder: "Search..." } %>

      <div id="search_spinner" class="spinner-border spinner-border-sm text-primary search_spinner ms-2" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <!-- Add hidden fields for the query params in the data_source passed -->
    <% 
      query_string = URI.parse(@data_source).query

      # Parse the query string into a hash
      params_hash = Rack::Utils.parse_nested_query(query_string)
    %>
    <% params_hash.each do |key, value| %>
      <% if key != "controller" && key != "action" && key != "utf8" && key != "commit" && key != "per_page" && key != "search" %>
        <%= form.hidden_field key, value: value %>
      <% end %>
    <% end %>

    <%= form.submit "Submit", { hidden: true, id: "submit", data: { target: "search.submit" } } %>
  <% end %>
</div>
