<% pi_turbo_frame = "portfolio_investments_frame"%>

<%
  aggregate_portfolio_investment ||= nil
  if params[:aggregate_portfolio_investment_id].present?
    aggregate_portfolio_investment ||= AggregatePortfolioInvestment.find_by(id: params[:aggregate_portfolio_investment_id])
  end
  fund_id ||= params[:fund_id].presence || aggregate_portfolio_investment&.fund_id
  fund ||= Fund.find_by(id: fund_id) if fund_id.present?
  import_upload_id ||= nil
%>

<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800"><%= params[:title] || "Portfolio Investments" %></h1>

  <div class="d-flex flex-wrap align-items-center gap-2">

    <% if fund && policy(fund).update? %>

      <%= link_to new_portfolio_investment_path(
                    "portfolio_investment[entity_id]": current_user.entity_id,
                    "portfolio_investment[fund_id]": fund_id,
                    "portfolio_investment[aggregate_portfolio_investment_id]": aggregate_portfolio_investment&.id,
                    "portfolio_investment[investment_instrument_id]": aggregate_portfolio_investment&.investment_instrument_id,
                    "portfolio_investment[portfolio_company_id]": aggregate_portfolio_investment&.portfolio_company_id),
                  class: "btn btn-outline-primary d-inline-flex align-items-center",
                  data: { turbo: false } do %>
        <i class="ti ti-plus"></i> New Investment
      <% end %>

      <%= link_to new_import_upload_path(
                    "import_upload[owner_id]": fund_id,
                    "import_upload[owner_type]": "Fund",
                    "import_upload[import_type]": "PortfolioInvestment",
                    "sample_upload": "PORTFOLIO_SAMPLE"),
                  class: "btn btn-outline-primary d-inline-flex align-items-center",
                  data: { turbo: false } do %>
        <i class="ti ti-upload"></i> <%= t_common(:upload) %>
      <% end %>


    <% end %>

      <% xl_link = "#{request.path}.xlsx?#{request.query_string}" %>
      <div class="btn-group">
        <button class="btn btn-outline-success dropdown-toggle d-inline-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="ti ti-download"></i> <%= t_common(:download) %>
        </button>
        <ul class="dropdown-menu">
          <li>
            <%= link_to xl_link, class: "dropdown-item", data: { turbo: false } do %>
              <i class="ti ti-file-spreadsheet"></i> <%= t_common(:export_all) %>
            <% end %>
          </li>
          <li>
            <button class="dropdown-item" data-controller="export-xl"
                    data-action="click->export-xl#export"
                    data-tableid="portfolio_investments"
                    data-filename="Portfolio Investments">
              <i class="ti ti-table-export"></i> <%= t_common(:export_visible) %>
            </button>
          </li>
          <% if params[:report_id].present? && params[:custom_xls_report].present? %>
            <li>
              <%= link_to xl_link + "&custom_xls_report=true", class: "dropdown-item", data: { turbo: false } do %>
                <i class="ti ti-file-spreadsheet"></i> Custom Report
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>

  </div>

</div>

<% if params[:ag].present? %>
  <div class="table-responsive">
    <%

      ransack_table_header = RansackTableHeader.new(PortfolioInvestment, q: @q, current_user: current_user, records: portfolio_investments, report_id: params["report_id"], turbo_frame: pi_turbo_frame, referrer: request.referrer, snapshot: params[:snapshot])


      custom_grid_columns = ransack_table_header.ag_selected_columns

      if params[:show_fund_name].present?
        fund_params = { key: "fund_name", label: "Fund Name", data_type: "String" }
        # add fund name to the front of the custom grid columns
        custom_grid_columns.unshift(fund_params)
      end
    %>

    <% table_suffix = rand(100000) %>
    <div class="portfolio_investment_ag_grid" data-controller="ag"
      data-ag-grid-div-name-value="portfolio_investment_ag_grid"
      data-ag-lazy-load-data-value=<%= false %>
      data-custom-columns='<%= custom_grid_columns.to_json %>'
      data-group-by-column='<%= params[:group_by_column] %>'
      data-ag-table-name-value="#portfolio_investments_table<%=table_suffix%>" data-ag-custom-fields-value="" >

      <div id="portfolio_investments_table<%=table_suffix%>" class="<%= get_ag_theme %>" data-source="<%= portfolio_investments_path(params: params.to_unsafe_h, import_upload_id:, format: :json) %>">
      </div>

      </div>
  </div>

<% else %>



  <div class="table-responsive">

    <%=render SearchComponent.new(data_source: portfolio_investments_path(params: params.to_unsafe_h, import_upload_id:), turbo_frame: pi_turbo_frame) %>

    <%= render RansackTable.new(PortfolioInvestment, q: @q, current_user: current_user, records: portfolio_investments, report_id: params["report_id"], turbo_frame: pi_turbo_frame, referrer: request.referrer, snapshot: params[:snapshot], pagy: @pagy) %>

  </div>

<% end %>
