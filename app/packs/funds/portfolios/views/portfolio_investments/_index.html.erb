<%
  aggregate_portfolio_investment ||= nil
  import_upload_id ||= nil
%>

<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800"><%= params[:title] || "Portfolio Investments" %></h1>

  <span>
    <% if aggregate_portfolio_investment && policy(aggregate_portfolio_investment).add_investment? %>

      <%= link_to "New Portfolio Investment",
          new_portfolio_investment_path("portfolio_investment[entity_id]": current_user.entity_id,
          "portfolio_investment[fund_id]": params[:fund_id],
          "portfolio_investment[portfolio_company_id]": params[:portfolio_company_id]),
          {class: "btn btn-outline-primary"} if params[:fund_id].present? %>


      <%= link_to "Upload",
          new_import_upload_path("import_upload[owner_id]": params[:fund_id],
          "import_upload[owner_type]": "Fund",
          "import_upload[import_type]": "PortfolioInvestment",
          "sample_upload": "PORTFOLIO_SAMPLE"),
          { class: "btn btn-outline-primary"}   %>


      <%= link_to "Download", portfolio_investments_path(fund_id: params[:fund_id], aggregate_portfolio_investment_id: aggregate_portfolio_investment&.id, format: "xlsx", all: true),  {class: "btn btn-outline-primary" } %>

    <% else %>
      <% xl_link = "#{request.path}.xlsx?#{request.query_string}" %>
      <%= link_to "Download", xl_link,  {class: "btn btn-outline-success" } %>
    <% end %>

  </span>
</div>

<% if params[:ag].present? %>

  <div class="table-responsive">

    <div data-controller="portfolio-investment-ag" data-portfolio-investment-ag-lazy-load-data-value=<%= false %>   
      data-portfolio-investment-ag-table-name-value="#portfolio_investments_table" data-portfolio-investment-ag-custom-fields-value="" >
      
      <div id="portfolio_investments_table" class="<%= get_ag_theme %>" data-source="<%= portfolio_investments_path(params: params.to_unsafe_h, import_upload_id:, format: :json) %>">
      </div>

      </div>
  </div>

<% else %>

  <% pi_turbo_frame = "portfolio_investments_frame"%>
  <%=render SearchComponent.new(data_source: portfolio_investments_path(params: params.to_unsafe_h, import_upload_id:), turbo_frame: pi_turbo_frame) %>

  <div class="table-responsive">
      <table id="portfolio_investments" class="table table-bordered dataTable action_table hover">
          <% ransack_table_header = RansackTableHeader.new(PortfolioInvestment, q: @q, current_user: current_user, records: portfolio_investments, report_id: params["report_id"], turbo_frame: pi_turbo_frame) %>
          <%= render ransack_table_header %>
        <tbody>
          <% portfolio_investments.each do |portfolio_investment| %>
            <%= render "portfolio_investments/portfolio_investment",  portfolio_investment: portfolio_investment.decorate, columns: ransack_table_header.columns%>
          <% end %>
        </tbody>
      </table>
      <% if portfolio_investments.present? %>
        <%= page_entries_info portfolio_investments, entry_name: 'item' %>
        <%= paginate portfolio_investments, data: { turbo_frame: pi_turbo_frame } %>
      <% end %>
  </div>

<% end %>