<%
  show_fund_name ||= false
  fund = params[:fund_id].present? ? Fund.find(params[:fund_id]) : nil
%>
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">Aggregate Portfolio Investments</h1>

  <span>
    <% if fund && policy(fund).update? %>
      <%= link_to "New Investment",
          new_portfolio_investment_path("portfolio_investment[entity_id]": current_user.entity_id,
          "portfolio_investment[fund_id]": fund.id),
          {class: "btn btn-outline-primary"}  %>

      <%= link_to "Generate Portfolio Reports",
          generate_reports_fund_path(fund, report_type: "AggregatePortfolioInvestment"), { class: "btn btn-outline-success"} %>

      <%= link_to "Scenarios", portfolio_scenarios_path(fund_id: fund.id), { class: "btn btn-outline-success"}  %>

      <%= link_to "Conversions", stock_conversions_path(fund_id: fund.id), { class: "btn btn-outline-success"} %>


        <div class="btn-group">
          <div class="dropdown">
            <button class="btn btn-outline-success dropdown-toggle upload_download_btn" type="button"
                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Upload / Download
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">


              <%= link_to "Download Investments", aggregate_portfolio_investments_path(fund_id: fund.id, format: "xlsx", all: true), { class: "dropdown-item"}  %>

              <%#= link_to "Individual Investments", portfolio_investments_path(fund_id: params[:fund_id], format: "xlsx", all: true), { class: "dropdown-item"}  %>

              <div class="dropdown-divider"></div>

              <%= link_to "Upload",
                  new_import_upload_path("import_upload[owner_id]": fund.id,
                  "import_upload[owner_type]": "Fund",
                  "import_upload[import_type]": "PortfolioInvestment",
                  "sample_upload": "PORTFOLIO_SAMPLE"),
                  { class: "dropdown-item"}   %>

            </div>
          </div>
        </div>
    <% end %>
  </span>

</div>

<%= render "aggregate_portfolio_investments/stats",  aggregate_portfolio_investments:, fund: fund unless params[:grid_only].present? %>

<% api_turbo_frame = "aggregate_portfolio_investments_frame" %>
<%=render SearchComponent.new(data_source: aggregate_portfolio_investments_path(params: params.to_unsafe_h, fund_id: params[:fund_id]), turbo_frame: api_turbo_frame) %>
<div class="table-responsive">
    <table id="aggregate_portfolio_investments" class="table table-bordered dataTable action_table hover">
      <!-- Table Header with our without fund -->
      <% default_columns_map = if params[:fund_id].present?
          AggregatePortfolioInvestment::STANDARD_COLUMNS
        else
          if params.include? "investor_id"
            AggregatePortfolioInvestment::INVESTOR_TAB_STANDARD_COLUMNS
          else
            AggregatePortfolioInvestment::STANDARD_COLUMNS_WITH_FUND
          end
        end
      %>
      <% ransack_table_header = RansackTableHeader.new(AggregatePortfolioInvestment, q: @q, default_columns_map:, current_user: current_user, records: aggregate_portfolio_investments, report_id: params["report_id"], turbo_frame: api_turbo_frame, referrer: request.referrer) %>

      <%= render ransack_table_header %>

      <tbody>
        <% aggregate_portfolio_investments.each do |aggregate_portfolio_investment| %>
          <%= render "aggregate_portfolio_investments/aggregate_portfolio_investment",  aggregate_portfolio_investment: aggregate_portfolio_investment.decorate, columns: ransack_table_header.columns%>
        <% end %>
      </tbody>
    </table>
    <% if aggregate_portfolio_investments.present? %>
      <%= page_entries_info aggregate_portfolio_investments, entry_name: 'item' %>
      <%= paginate aggregate_portfolio_investments, data: {turbo_frame: api_turbo_frame}  %>
    <% end %>
</div>

<div class="associated_entity">
  <%= render "aggregate_portfolio_investments/index_charts" unless params[:grid_only].present? %>
</div>
