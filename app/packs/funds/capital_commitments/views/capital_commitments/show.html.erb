<%= render "/layouts/alerts" %>
<%= render "/capital_commitments/capital_commitment_stats", capital_commitment: @capital_commitment %>

<% if current_user.entity_id == @capital_commitment.entity_id %>

<div class="card shadow mb-4">
  <div class="card-header py-3 d-sm-flex align-items-center justify-content-between">
      <h6 class="m-0 font-weight-bold text-primary">Commitment: <%= @capital_commitment.investor_name %></h6>
      <span>
        <a class="btn btn-outline-primary show_details_link" data-bs-toggle="collapse" href=".show_details"><i class="fa-solid fa-caret-down"></i></a>
      </span>
  </div>
  <div class="card-body collapse show_details">

  <table class="table table-bordered dataTable">
    <tr class="">
      <td>
        Entity
      </td>
      <td>
        <%= @capital_commitment.entity.name %>
      </td>
    </tr>

    <tr class="">
      <td>
        Fund
      </td>
      <td>
        <%= link_to @capital_commitment.fund.name, @capital_commitment.fund %>
      </td>
    </tr>

    <tr class="">
      <td>
        Type
      </td>
      <td>
        <%= @capital_commitment.commitment_type %>
        <% if @capital_commitment.feeder_fund %>
          <br>
          <span class="badge bg-success">Feeder Fund</span>
        <% end %>
      </td>
    </tr>

    
    <tr class="">
      <td>
        Investor
      </td>
      <td>
        <%= link_to @capital_commitment.investor_name, investor_path(id: @capital_commitment.investor_id) %>
      </td>
    </tr>
    
    <% if @capital_commitment.commitment_date %>
      <tr class="">
        <td>
          Date
        </td>
        <td>
          <%= l @capital_commitment.commitment_date %>
        </td>
      </tr>
    <% end %>
    
      <tr class="">
        <td>
          Folio Id
        </td>
        <td>
          <%= @capital_commitment.folio_id %>
        </td>
      </tr>
    
    <% if @capital_commitment.virtual_bank_account.present? %>
      <tr class="">
        <td>
          Virtual Bank Account
        </td>
        <td>
          <%= @capital_commitment.virtual_bank_account %>
        </td>
      </tr>
    <% end %>

    <tr class="">
      <td>
        Fund Close
      </td>
      <td>
        <%= @capital_commitment.fund_close %>
      </td>
    </tr>
    
    <tr class="">
      <td>
        Linked KYC
      </td>
      <td>
        <% if @capital_commitment.investor_kyc %>
          <%= link_to @capital_commitment.investor_kyc.full_name, @capital_commitment.investor_kyc %>
          <br>
          <% if @capital_commitment.investor_kyc.verified %>
            <span class="badge bg-success">Verified</span>
          <% else %>
            <span class="badge bg-warning">Not Verified</span>
          <% end %>
        <% else %>
          <span class="badge bg-danger">No KYC</span>
        <% end %>
      </td>
    </tr>

    
    <% if @capital_commitment.fund.unit_types.present? %>
    
    <tr class="">
      <td>
        Unit Type
      </td>
      <td>
        <%= @capital_commitment.unit_type %>
      </td>
    </tr>

    <tr class="">
      <td>
        Total Units
      </td>
      <td>
        <%= @capital_commitment.total_fund_units_quantity %>
      </td>
    </tr>

    <% end %>

    <% if @capital_commitment.adjustment_amount_cents > 0 || @capital_commitment.foreign_currency? %>
    
      <tr class="">
        <td>
          Folio Currency
        </td>
        <td>
          <%= @capital_commitment.folio_currency %>
        </td>
      </tr>

      <tr class="">
        <td>
          Folio Committed Amount
        </td>
        <td>
          <%= money_to_currency @capital_commitment.folio_committed_amount, params %>
        </td>
      </tr>
      
      <% if @capital_commitment.adjustment_amount_cents != 0 %>

        <tr class="">
          <td>
            Original Folio Committed Amount
          </td>
          <td>
            <%= money_to_currency @capital_commitment.orig_folio_committed_amount, params %>
          </td>
        </tr>

        <tr class="">
          <td>
            Adjustment Folio Amount
          </td>
          <td>
            <%= money_to_currency @capital_commitment.adjustment_folio_amount, params %>
          </td>
        </tr>

        <tr class="">
          <td>
            Adjustment Amount
          </td>
          <td>
            <%= money_to_currency @capital_commitment.adjustment_amount, params %>
          </td>
        </tr>

      <% end %>

    <% end %>

    <tr class="">
      <td>
        Committed Amount
      </td>
      <td>
        <%= money_to_currency @capital_commitment.committed_amount, params %>
        <% if @capital_commitment.foreign_currency? %>
          <br>
          Adjustments + Original
          <br>
          <%= money_to_currency(@capital_commitment.adjustment_amount, params) %> + 
          <%= money_to_currency(@capital_commitment.orig_committed_amount, params) %> 
        <% end %>
      </td>
    </tr>


    <tr class="">
      <td>
        Called Amount
      </td>
      <td>
        <%= money_to_currency @capital_commitment.call_amount, params %>
      </td>
    </tr>

    <tr class="">
      <td>
        Collected Amount
      </td>
      <td>
        <%= money_to_currency @capital_commitment.collected_amount, params %>      
      </td>
    </tr>


    <tr class="">
      <td>
        Called - Collected
      </td>
      <td>
        <span class="<%= @capital_commitment.pending_call_amount != 0 ? 'text-danger': '' %>"><%= money_to_currency @capital_commitment.pending_call_amount, params %></span>

        <div class="progress">
          <div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" style="width: <%= @capital_commitment.percentage_pending_call %>%" aria-valuenow="<%=@capital_commitment.percentage_pending_call%>" aria-valuemin="0" aria-valuemax="100">
            <%= @capital_commitment.percentage_pending_call %> % Paid
          </div>
        </div>
      </td>
    </tr>

    <tr class="">
      <td>
        Committed - Collected
      </td>
      <td>
        <%= money_to_currency @capital_commitment.pending_committed_amount, params %>

        <div class="progress">
          <div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" style="width: <%= @capital_commitment.percentage_pending_committed %>%" aria-valuenow="<%=@capital_commitment.percentage_pending_committed%>" aria-valuemin="0" aria-valuemax="100">
            <%= @capital_commitment.percentage_pending_committed %> % Collected
          </div>
        </div>

      </td>
    </tr>

    <tr class="">
      <td>
        Distributed Amount
      </td>
      <td>
        <%= money_to_currency @capital_commitment.distribution_amount, params %>
      </td>
    </tr>

    <tr class="">
      <td>
        Onboarding Complete
      </td>
      <td>
        <%= display_boolean @capital_commitment.onboarding_completed %>
      </td>
    </tr>


    <% if @capital_commitment.entity.permissions.enable_account_entries? %>
      <tr class="">
        <td>
          Total Allocated Expense
        </td>
        <td>
          <%= money_to_currency @capital_commitment.total_allocated_expense, params %>
        </td>
      </tr>

      <tr class="">
        <td>
          Total Allocated Income
        </td>
        <td>
          <%= money_to_currency @capital_commitment.total_allocated_income, params %>
        </td>
      </tr>
    <% end %>
    
    
    <%= display_custom_fields(@capital_commitment, collapsed: true) if current_user %>

    <tr class="">
      <td>
        Investor Signatory
      </td>
      <td>
        <%= @capital_commitment.investor_signatory.full_name if @capital_commitment.investor_signatory %>
      </td>
    </tr>

    
    <tr  class="">
      <td>
        Notes
      </td>
      <td>
        <%= @capital_commitment.notes.html_safe if @capital_commitment.notes %>
      </td>
    </tr>

    <% if params[:debug].present? %>
    <tr class=" btn-outline-primary">
      <td colspan="2">
      </td>
    </tr>
    
    <% 
      end_date = params[:end_date].present? ? Date.parse(params[:end_date]) : Time.zone.today 
      cc_calcs = CapitalCommitmentCalcs.new(@capital_commitment, end_date)
    %>

          <tr class="">
            <td>
              Cash In Hand
            </td>
            <td>
              <%= currency_from_cents cc_calcs.cash_in_hand_cents, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          <tr class="">
            <td>
              Net Current Assets
            </td>
            <td>
              <%= currency_from_cents cc_calcs.net_current_assets_cents, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          <tr class="">
            <td>
              Esitmated Carry
            </td>
            <td>
              <%= currency_from_cents cc_calcs.estimated_carry_cents, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          

          <tr class="">
            <td>
              Collected
            </td>
            <td>
              <%= currency_from_cents cc_calcs.collected_cents, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          <tr class="">
            <td>
              DPI
            </td>
            <td>
              <%= currency_from_cents cc_calcs.dpi, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          <tr class="">
            <td>
              RVPI
            </td>
            <td>
              <%= currency_from_cents cc_calcs.rvpi, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          <tr class="">
            <td>
              TVPI
            </td>
            <td>
              <%= currency_from_cents cc_calcs.tvpi, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          <tr class="">
            <td>
              FMV
            </td>
            <td>
              <%= currency_from_cents cc_calcs.fmv_on_date, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          
          <tr class="">
            <td>
              Gross XIRR
            </td>
            <td>
              <%= currency_from_cents cc_calcs.xirr, @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

          <tr class="">
            <td>
              Net XIRR
            </td>
            <td>
              <%= currency_from_cents cc_calcs.xirr(net_irr: true), @capital_commitment.fund.currency, params  %>
            </td>
          </tr>

    <% end %>

  </table>

  </div>
</div>

<% end %>

<div>

  <% if policy(@capital_commitment).update? %>
    <%= link_to "Edit" , edit_capital_commitment_path(@capital_commitment), {class: "btn btn-outline-primary" } %>
    <%= button_to "Delete" , @capital_commitment, method: :delete, class: "btn btn-outline-danger" ,
            form_class: "deleteButton" , data: {action: "click->confirm#popup" , turbo:false} %>

                
  <% end %>

  <% if policy(@capital_commitment).update? %>
    <div class="btn-group">
      <div class="dropdown">
        <button class="btn btn-outline-success dropdown-toggle" type="button" 
                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Actions
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">

          <%= link_to "LP Account Statement" , report_capital_commitment_path(@capital_commitment, report: "lp_statement"), {class: "dropdown-item" } %>
      
          <%= button_to "Generate Documents", 
          generate_documentation_capital_commitment_path(@capital_commitment), 
          method: :patch, class: "dropdown-item" , 
          form_class: "deleteButton",data: {action: "click->confirm#popup", method: :patch,
          msg: "Generate Documents for this capital commitment from kyc and fund info. This will delete any previously generated documentation for this capital commitment. Proceed?"} if policy(@capital_commitment).generate_documentation? %>


          <%= link_to "Generate SOA", 
          generate_soa_form_capital_commitment_path(@capital_commitment), 
          class: "dropdown-item" if policy(@capital_commitment).generate_soa? %>
          
        </div>
      </div>
    </div>
  <% end %>
  
  
</div>
<%= render "capital_commitments/details", capital_commitment: @capital_commitment %>
