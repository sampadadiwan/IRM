<% 
  lazy_load_data ||= false
  search ||= "Yes"
  capital_call ||= nil 
  capital_commitment ||= nil 
  capital_call_id ||= params[:capital_call_id] || capital_call&.id 
  capital_commitment_id ||= params[:capital_commitment_id] || capital_commitment&.id 
  import_upload_id ||= params[:import_upload_id]
%>

<% data_source ||= capital_remittances_path(q: params.to_unsafe_h[:q], format: :json, all: true, 
        capital_call_id: params[:capital_call_id], capital_commitment_id: params[:capital_commitment_id],  
        fund_id: params[:fund_id], status: "", verified: "", import_upload_id:) %>

<% xl_link = download_xl_link(data_source) %>
              
<div data-controller="remittances"
     data-remittances-lazy-load-data-value=<%= lazy_load_data %>
     data-remittances-table-name-value="#capital_remittances">

  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Capital Remittances</h1>
    <span>
      

      <% if capital_call %>
        <%= button_to "Capital Call Reminder", reminder_capital_call_path(id: capital_call.id),
                        class: "btn btn-outline-primary",
                        data: {action: "click->confirm#popup", turbo:false,
                        msg: "Send reminder for pending payments?",
                        method: "post"} if policy(capital_call).reminder? %>


        <div class="btn-group">
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button"
                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Upload / Download
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">


              <%= link_to "Download", xl_link,  {class: "dropdown-item" } %>


              <%= link_to "Upload Remittances",
                  new_import_upload_path("import_upload[owner_id]": capital_call.id,
                  "import_upload[owner_type]": "CapitalCall",
                  "import_upload[import_type]": "CapitalRemittance",
                  "sample_upload": "CAPITAL_REMITTANCE_SAMPLE"),
                  { class: "dropdown-item"}  if policy(capital_call).update? %>

              <%= link_to "Upload Payments",
                  new_import_upload_path("import_upload[owner_id]": capital_call.id,
                  "import_upload[owner_type]": "CapitalCall",
                  "import_upload[import_type]": "CapitalRemittancePayment",
                  "sample_upload": "CAPITAL_REMITTANCE_PAYMENT_SAMPLE"),
                  { class: "dropdown-item"}  if policy(capital_call).update? %>

            </div>
          </div>
        </div>
        <%= render "capital_remittances/filter", capital_call_id: capital_call.id %>
      <% else %>
        <%= link_to "Download", xl_link, {class: "btn btn-outline-primary" } %>
      <% end %>

      <%#= render "/funds/search_bar", model_name: "capital_remittance" unless search == "No" %>
    </span>
  </div>

  

  

  <div class="table-responsive">
    <% if lazy_load_data %>
      <a class="load_data_link" data-action="click->remittances#loadData"><span>Load Data</span></a>
    <% end %>

    <% if capital_call_id.blank? && capital_commitment_id.blank? %>        
      <input type="text" id="capital_remittance_cols" hidden value="all">
    <% end %>

    <table id="capital_remittances" class="table table-bordered dataTable action_table"
        data-source="<%= data_source %>" style="width:100%" >

      <thead>
        <tr>
          <% if capital_call_id.blank? && capital_commitment_id.blank? %>        
          <th>
            Fund
          </th>
          <% end %>
          <th>
            Investor
          </th>
          <th>
            Capital Call
          </th>
          <th>
            Folio No
          </th>
          <th>
            Status
          </th>
          <th>
            Created By
          </th>
          <th>
            Verified
          </th>
          <th>
            Due Amount
          </th>
          <th>
            Collected Amount
          </th>
          <th>
            Payment Date
          </th>
          <th>
          </th>
        </tr>
      </thead>

      <tbody>
      </tbody>

    </table>

  </div>
</div>
