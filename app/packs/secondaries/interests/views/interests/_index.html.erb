<% secondary_sale = @secondary_sale %>
<% secondary_sale_id = @secondary_sale&.id || params[secondary_sale_id] %>

<% if @secondary_sale && policy(@secondary_sale).owner?  %>
    <%= render "/interests/charts", secondary_sale: @secondary_sale %>
    <%= render "/interests/stats", secondary_sale: @secondary_sale %>    
<% end %>

<%= render "/layouts/filter", associations: [:interest_entity, :secondary_sale], hidden_fields: {secondary_sale_id:} %>

<% if params[:card].present? %>
    <div class="row">
        <% @interests.each do |interest| %>
            <%= render "/interests/card", interest:  %>
        <% end %>
    </div>
    <%= paginate @interests %>
<% else %>

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Interests</h1>
        
        <span>

            <% if @secondary_sale %>
                <% if policy(@secondary_sale).update? || policy(@secondary_sale).import_interests? %>
                    
                    <%= link_to "New Interest" , new_interest_path("interest[secondary_sale_id]": @secondary_sale.id), {class: "btn btn-outline-primary" } %>

                    <%= link_to "Upload Interests", 
                        new_import_upload_path("import_upload[owner_id]": @secondary_sale.id, 
                        "import_upload[owner_type]": "SecondarySale", 
                        "import_upload[import_type]": "Interest", 
                        "sample_upload": "INTERESTS_SAMPLE"), 
                        { class: "btn btn-outline-primary"}  %> 

                <% elsif policy(@secondary_sale).buyer? %>
                    <%= link_to "New Interest" , new_interest_path("interest[secondary_sale_id]": @secondary_sale.id), {class: "btn btn-outline-primary" } %>
                <% end %>

            <% end %>

            <%= link_to "Download", interests_path(secondary_sale_id: @secondary_sale&.id, format: :xlsx), {class: "btn btn-outline-success"} %>

            <%= button_to "Shortlist All", short_list_interests_secondary_sale_path(@secondary_sale), 
                                    method: :patch, class: "btn btn-outline-success", form_class: "deleteButton", data: {action: "click->confirm#popup", method: :patch, msg: "This will shortlist all interests. Proceed?"} if @secondary_sale && policy(@secondary_sale).short_list_interests? %>
        </span>
    </div>

    <div class="table-responsive">
        <table id="interests" class="table table-bordered dataTable">

            <thead>
                <tr>
                    <th>
                        <%= sort_link @q, "buyer_entity_name", "Buyer Entity" %>
                    </th>

                    <th>
                        <%= sort_link @q, "investor_investor_name", "Stakeholder" %>
                    </th>

                    <th>
                        <%= sort_link @q, :user_first_name, "User" %>
                    </th>
                    
                    <th>
                        <%= sort_link @q, :quantity %>
                    </th>
                    <th>
                        <%= sort_link @q, :price, "Price" %>
                    </th>

                    <th>                        
                        <%= sort_link @q, "allocation_quantity" %>
                    </th>
                                        
                    <th>                        
                        <%= sort_link @q, :allocation_amount, "Allocation Amount" %>
                    </th>

                    <th>
                        <%= sort_link @q, "short_listed_status", "Status" %>
                    </th>
                    <th>
                        <%= sort_link @q, :escrow_deposited, "Escrow Deposited" %>
                    </th>
                    <th>
                        <%= sort_link @q, :created_at %>
                    </th>

                    <th>
                    </th>
                </tr>
            </thead>

            <tbody>
                <% interests.each do |interest| %>
                    <%= render "/interests/interest", interest:, secondary_sale: %>
                <% end %>
            </tbody>
        </table>

        <%= paginate interests %>
    </div>

<% end %>

