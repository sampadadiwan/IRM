<%
    steps = []
    params[:force_units] = offer.entity.default_currency_units
    if params[:force_units] == "Crores" && offer.amount.to_d < 100_00000
        # If committed_amount is less than a crore, then show in lakhs
        params[:force_units] = "Lakhs"
    end
%>

<% if policy(offer).update? && offer.approved %>

  <%

  steps = ["#{link_to 'Review', offer_path(offer)} your offer details below".html_safe,
          "Please #{link_to 'Add', edit_offer_path(offer)} the required details".html_safe,
          "You may need to upload documents to complete the offer.",
          "Wait for communication from #{offer.secondary_sale.entity.name}"].freeze

  %>


<% elsif policy(offer).show? && offer.verified %>


  <%
    spas = []
    offer.documents.where(owner_tag: "Generated", approved: true).each do |spa|
      spas << link_to(spa.name, spa.file.url, target: "_blank", class: "btn btn-outline-success")
    end

    accept_spa = button_to("Accept" , accept_spa_offer_path(offer), method: :patch,
        class: "btn btn-outline-primary" , id: 'accept_spa_btn',
        form_class: "deleteButton",data: {action: "click->confirm#popup", method: :patch,
        msg: "This will mark your acceptance of the Transaction Document(s). Proceed?"}) if policy(offer).accept_spa?
    step2 = if policy(offer).accept_spa? && offer.documents&.where(owner_tag: "Generated", approved: true)&.present?
            "Accept the Transaction Document(s) #{accept_spa}".html_safe
            else
            "Accept the Transaction Document(s)".html_safe
            end
    steps = ["Please #{link_to 'Review', offer_path(offer)} the Transaction Document(s) </br> #{spas.join(' ')}".html_safe,
            (step2),
            ("Your acceptance of the Transaction Document(s) has already been recorded".html_safe unless policy(offer).accept_spa? ),
            "Wait for communication from #{offer.secondary_sale.entity.name}"].compact
  %>

<% end %>


  <div class="col-lg-12">
    <div class="card w-100">
      <div class="card-body">
        <div class="mb-9">
          <div class="mb-3 mb-sm-0">
            <div class="row">
              <%= image_tag offer.entity.logo.url(expires_in: 60*60*24*7), class: "col cc-card-logo" if offer.entity.logo %>
              <div class="col">
                <h4 class="card-title fw-semibold">
                  <%= link_to "#{offer.secondary_sale.name}: #{offer.entity.name}", offer %>
                </h4>
                <span class="fs3 mb-1">
                  <%= offer.investor.investor_name if offer.investor %>
                </span>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col">
                <%= render "/layouts/steps", steps:, progressbar: true %>
              </div>
            </div>

            <div class="row align-items-center">
              <div class="col-md-4">
                <div class="hstack mb-4 pb-1">
                  <div class="p-8 bg-primary-subtle rounded-1 me-3 d-flex align-items-center justify-content-center">
                    <i class="ti ti-user text-primary fs-6"></i>
                  </div>
                  <div class="text-wrap" >
                    <h4 class="mb-0 fs-6"><%= offer.user.full_name %></h4>
                    <p class="fs-3 mb-0">User</p>
                  </div>
                </div>
                <div class="hstack mb-4 pb-1">
                  <div class="p-8 bg-primary-subtle rounded-1 me-3 d-flex align-items-center justify-content-center">
                    <i class="ti ti-mail text-primary fs-6"></i>
                  </div>
                  <div class="text-wrap" >
                    <h4 class="mb-0 fs-6"><%= offer.user.email %></h4>
                    <p class="fs-3 mb-0">Email</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="hstack mb-4 pb-1">
                  <div class="p-8 bg-primary-subtle rounded-1 me-3 d-flex align-items-center justify-content-center">
                    <i class="ti ti-currency-dollar text-primary fs-6"></i>
                  </div>
                  <div class="text-wrap" >
                    <h4 class="mb-0 fs-6"><%= offer.bank_account_number %></h4>
                    <p class="fs-3 mb-0">Account Number</p>
                  </div>
                </div>
                <div class="hstack mb-4 pb-1">
                  <div class="p-8 bg-primary-subtle rounded-1 me-3 d-flex align-items-center justify-content-center">
                    <i class="ti ti-building-bank text-primary fs-6"></i>
                  </div>
                  <div class="text-wrap" >
                    <h4 class="mb-0 fs-6"><%= offer.ifsc_code %></h4>
                    <p class="fs-3 mb-0">IFSC Code</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="hstack mb-4 pb-1">
                  <div class="p-8 bg-primary-subtle rounded-1 me-3 d-flex align-items-center justify-content-center">
                    <i class="ti ti-grid-dots text-primary fs-6"></i>
                  </div>
                  <div class="text-wrap" >
                    <h4 class="mb-0 fs-6"><%= offer.allocation_quantity %></h4>
                    <p class="fs-3 mb-0">Allocation Quantity</p>
                  </div>
                </div>
                <div class="hstack mb-4 pb-1">
                  <div class="p-8 bg-primary-subtle rounded-1 me-3 d-flex align-items-center justify-content-center">
                    <i class="ti ti-grid-dots text-primary fs-6"></i>
                  </div>
                  <div class="text-wrap" >
                    <h4 class="mb-0 fs-6"><%= money_to_currency(offer.allocation_amount, params) %></h4>
                    <p class="fs-3 mb-0">Allocation Amount</p>
                  </div>
                </div>
              </div>

            </div>

            <div class="row align-items-center">
              <div class="col">
                <%= link_to "Show" , offer_path(offer), {class: "btn btn-outline-primary" } %>
                <% if policy(offer).update? %>
                  <%= link_to "Edit" , edit_offer_path(offer), {class: "btn btn-outline-primary" } if !offer.approved %>
                  <%= link_to "Complete Offer Details", edit_offer_path(offer) , {class: "btn btn-outline-warning" } if offer.approved %>
                <% end %>

                <%= button_to "Accept SPA" , accept_spa_offer_path(offer), method: :patch,
                    class: "btn btn-outline-success" , id: 'accept_spa_btn',
                    form_class: "deleteButton",data: {action: "click->confirm#popup", method: :patch,
                    msg: "This will mark your acceptance of the SPA. Proceed?"} if policy(offer).accept_spa? && offer.documents&.where(owner_tag: "Generated", approved: true)&.present? %>

              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

<% params[:force_units] = nil %>
