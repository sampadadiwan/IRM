<%= render "/layouts/alerts" %>

<% if policy(@offer).update? && @offer.approved %>
    <%= render "/layouts/steps", steps: ["Review your offer details below", 
            "Please #{link_to 'Add', edit_offer_path(@offer)} the required documentation & details to finalize the sale".html_safe, 
            "You will need the follwing docs #{@offer.secondary_sale.seller_doc_list}",
            "Wait for communication from #{@offer.secondary_sale.entity.name}"].freeze %>
<% end %>

  <%= render "/offers/show" %>


  <div>
    <% if policy(@offer).update? %>
      <%= link_to "Edit" , edit_offer_path(@offer), {class: "btn btn-primary" } if !@offer.approved %>
      <%= link_to "Complete Offer Details", edit_offer_path(@offer) , {class: "btn btn-warning" } if @offer.approved %>    
    <% end %>

    <% label = @offer.approved ?  "UnApprove" : "Approve" %>
    <%= button_to label , approve_offer_path(@offer), method: :patch, class: "btn btn-success" , 
      form_class: "deleteButton" if Pundit.policy(current_user, @offer).approve? %>


      <%= button_to "Generate Esign Link", 
        generate_esign_link_offer_path(@offer), 
        method: :patch, class: "btn btn-success" , 
        form_class: "deleteButton",data: {action: "click->confirm#popup", method: :patch,
        msg: "Generate esign link for this Offer. This will trigger the eSign process. Proceed?"} if policy(@offer).generate_esign_link? %>


      <% if @offer.esign_required && 
            !@offer.esign_completed && 
            params[:signature_completed].blank? %>
            
        
        <% @offer.signature_link(current_user).each do |esign| %>
          <%= link_to "eSign #{esign.document.name}", esign.link, 
                    class: "btn btn-success" %>
        <% end %>

      <% else %>
        <%= button_to "Accept SPA" , accept_spa_offer_path(@offer), method: :patch, class: "btn btn-success" , 
            form_class: "deleteButton",data: {action: "click->confirm#popup", method: :patch,
            msg: "This will mark your acceptance of the SPA. Proceed?"} if policy(@offer).accept_spa? %>

      <% end %>

    
    <%= link_to "Secondary Sale" , secondary_sale_path(@offer.secondary_sale), {class: "btn btn-primary" } %>
  </div>

  <%= render "offers/offer_details", offer: @offer if @offer.approved %> 