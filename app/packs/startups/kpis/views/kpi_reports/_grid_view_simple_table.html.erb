<div class="table-responsive" data-controller="datatable">
    <table id="kpi_reports_grid" class="table table-bordered table-striped dataTable table-grey" data-controller="row-toggle">
        <thead>
            <tr>
                <th></th>
                <% kpi_reports.each do |kpi_report| %>
                    <th>
                        <%= link_to kpi_report.as_of.strftime("%b %Y"), show_performance_kpi_reports_path(as_of: kpi_report:as_of) %>
                        <span class="d-block">
                        <% if kpi_report.tag_list.present? %>
                            <small class="badge badge-pill bg-success-subtle text-success"><%= kpi_report.tag_list %></small>
                        <% end %>
                        <% if kpi_report.owner.present? %>
                            <small class="badge badge-pill bg-info-subtle text-info"><%= kpi_report.owner %></small>
                        <% end %>
                        </span>
                    </th>
                <% end %>
            </tr>
        </thead>
        <tbody>



            <% investor_kpi_mappings.each do |ikm| %>
                <% row_class = ikm.parent_id.blank? ? 'parent' : 'child' %>
                <tr class="<%= row_class %>">
                    <td data-action="click->row-toggle#toggle" data-row-toggle-target="control">
                        <% if ikm.parent_id.present? %>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            <i class="ti ti-chevron-right"></i>
                        <% elsif ikm.child_count > 0 %>
                            <span class="expand">+</span>
                        <% else %>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <% end %>
                        <%= ikm.standard_kpi_name %>
                    </td>


                    <% kpi_reports.each do |kpi_report| %>
                        <!-- Create a hash of the kpis with the name as the key -->
                        <%
                            kpis = kpi_report.kpis
                            kpis = kpis.map{|kpi| [kpi.name.downcase, kpi]}.to_h
                        %>

                        <!-- Find the kpi with the name or an alias for the name and show its value-->
                        <% kpi = kpis[ikm.standard_kpi_name.downcase].presence %>
                        <td class="value_<%=kpi&.id%>">
                            <% if kpi %>
                                <%= display_kpi(kpi, ikm) %>
                            <% else %>
                                N/A
                            <% end %>
                        </td>
                    <% end %>

                </tr>
            <% end %>


        </tbody>
    </table>
</div>