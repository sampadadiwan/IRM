
<%= turbo_frame_tag "performance_table_frame", target: "_top" do %>
  <div class="card table-responsive">
    <div class="card-header">
      <%= content_tag :h3, "KPI Performance: #{@as_of.strftime('%d-%b-%Y')}", class: "card-title mb-0" %>
    </div>
    <div class="card-body">
      <% if @kpi_report.present? %>
      <div class="table-responsive">
        <table class="table table-bordered text-end align-middle">
          <thead class="table-dark">
            <tr>
              <th rowspan="2" class="text-start">Metric</th>
              <th colspan="4">Monthly</th>
              <th colspan="3">Quarterly</th>
              <th colspan="3">YTD</th>
              <th colspan="3">TTM</th>
            </tr>
            <tr>
              <th><%= l @as_of.prev_month.end_of_month %></th>
              <th><%= l @as_of %></th>
              <th>Growth MoM</th>
              <th>Growth 12Mo</th>
              <th>Previous</th>
              <th>Current</th>
              <th>Growth QoQ</th>
              <th>Previous</th>
              <th>Current</th>
              <th>vs&nbsp;PY</th>
              <th>Previous</th>
              <th>Current</th>
              <th>vs&nbsp;PY</th>
            </tr>
          </thead>

          <tbody>
            <% @rows.each do |r| %>
              <tr>
                <td class="text-start fw-semibold"><%= r.metric %></td>

                <td><%= r.monthly_prev_kpi ? link_to(number_with_delimiter(r.monthly_prev_kpi.value, delimiter: ','), r.monthly_prev_kpi) : nil %></td>
                <td><%= r.monthly_curr_kpi ? link_to(number_with_delimiter(r.monthly_curr_kpi.value, delimiter: ','), r.monthly_curr_kpi) : nil %></td>
                <td><%= content_tag(:span, number_to_percentage(r.growth_monthly, precision: 1), class: (r.growth_monthly.negative? ? 'text-danger' : 'text-success')) if r.growth_monthly %></td>
                <td><%= content_tag(:span, number_to_percentage(r.growth_monthly_py, precision: 1), class: (r.growth_monthly_py.negative? ? 'text-danger' : 'text-success')) if r.growth_monthly_py %></td>
         
                <td><%= r.quarterly_prev_kpi ? number_with_delimiter(r.quarterly_prev_kpi.value, delimiter: ',') : nil %></td>
                <td><%= r.quarterly_curr_kpi ? number_with_delimiter(r.quarterly_curr_kpi.value, delimiter: ',') : nil %></td>
                <td><%= content_tag(:span, number_to_percentage(r.growth_quarterly, precision: 1), class: (r.growth_quarterly.negative? ? 'text-danger' : 'text-success')) if r.growth_quarterly %></td>

                <td><%= r.ytd_prev_kpi ? number_with_delimiter(r.ytd_prev_kpi.value, delimiter: ',') : nil %></td>
                <td><%= r.ytd_curr_kpi ? number_with_delimiter(r.ytd_curr_kpi.value, delimiter: ',') : nil %></td>
                <td><%= content_tag(:span, number_to_percentage(r.growth_ytd_py, precision: 1), class: (r.growth_ytd_py.negative? ? 'text-danger' : 'text-success')) if r.growth_ytd_py %></td>

                <td><%= r.ttm_prev_kpi ? number_with_delimiter(r.ttm_prev_kpi.value, delimiter: ',') : nil %></td>
                <td><%= r.ttm_curr_kpi ? number_with_delimiter(r.ttm_curr_kpi.value, delimiter: ',') : nil %></td>
                <td><%= content_tag(:span, number_to_percentage(r.growth_ttm_py, precision: 1), class: (r.growth_ttm_py.negative? ? 'text-danger' : 'text-success')) if r.growth_ttm_py %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <% else %>
        <p class="text-muted">No KPI report found for the specified date.</p>
        <!-- Optionally, you can add a link to show for prev dates -->
      <% end %>
    </div>
  </div>
<% end %>