<%
    investor = Investor.where(id: params[:portfolio_company_id]).first

    if ["Investment Fund", "Angel Fund"].include? current_user.entity.entity_type
        # Create dummy mappings for the startup, which has all the kpi names
        investor_kpi_mappings = investor.investor_kpi_mappings
    else
        investor_kpi_mappings = Kpi.where(kpi_report_id: kpi_reports.pluck(:id)).pluck(:name).uniq.map{|kpi_name| InvestorKpiMapping.new(standard_kpi_name: kpi_name, standard_kpi_name: kpi_name, category: "General")}
    end

    # Filter investor_kpi_mappings based on the category if provided
    if params[:category].present?
        investor_kpi_mappings = investor_kpi_mappings.select{|ikm| ikm.category == params[:category]}
    end
%>

<%= turbo_frame_tag "kpi_reports_budget", target: "_top" do %>

    <%= render "/kpi_reports/budget_filter", entity: @entity %>

    <div class="table-responsive" data-controller="datatable">
        <table id="kpi_reports_budget_grid" class="table table-bordered table-striped dataTable table-grey">


            <%
                num_periods_to_display = (params[:num_periods] &.to_i || 1)
                tag_lists_to_display = @tag_list

                # Determine if the Achievement % column should be shown
                show_achievement_column = @tag_list.include?('Actual') && @tag_list.include?('Budget')

                # Separate kpi_reports into Quarterly and YTD groups
                primary_tag_for_filtering = @tag_list.find { |tag| tag != 'Actual' } || 'Actual'

                quarterly_reports_base = kpi_reports.filter { |r| r.period == 'Quarter' && r.tag_list == primary_tag_for_filtering }.sort_by(&:as_of).last(num_periods_to_display)
                year_reports_base = kpi_reports.filter { |r| r.period == 'Year' && r.tag_list == primary_tag_for_filtering }.sort_by(&:as_of).last(num_periods_to_display)

                # Get unique as_of dates from the base reports
                quarterly_as_of_dates = quarterly_reports_base.map(&:as_of).uniq
                year_as_of_dates = year_reports_base.map(&:as_of).uniq

                # Now, filter all kpi_reports to include all tags for these specific as_of dates
                quarterly_reports = kpi_reports.filter { |r| r.period == 'Quarter' && r.as_of.present? && quarterly_as_of_dates.include?(r.as_of) }
                year_reports = kpi_reports.filter { |r| r.period == 'Year' && r.as_of.present? && year_as_of_dates.include?(r.as_of) }

                # Group kpi_reports by as_of date and tag_list
                grouped_quarterly_reports = quarterly_reports.group_by(&:as_of).transform_values do |reports_for_date|
                    tag_lists_to_display.map do |tag|
                        [tag, reports_for_date.find { |r| r.tag_list == tag }]
                    end.to_h
                end
                grouped_yearly_reports = year_reports.group_by(&:as_of).transform_values do |reports_for_date|
                    tag_lists_to_display.map do |tag|
                        [tag, reports_for_date.find { |r| r.tag_list == tag }]
                    end.to_h
                end

            %>
            <thead>
                <tr>
                    <th rowspan="3">Particulars</th>
                    <% if quarterly_reports.present? %>
                        <th colspan="<%= quarterly_reports.map(&:as_of).uniq.count * (tag_lists_to_display.count + (show_achievement_column ? 1 : 0)) %>" class="text-center">
                            Quarter
                        </th>
                    <% end %>
                    <% if year_reports.present? %>
                        <th colspan="<%= year_reports.map(&:as_of).uniq.count * (tag_lists_to_display.count + (show_achievement_column ? 1 : 0)) %>" class="text-center">
                            Year
                        </th>
                    <% end %>
                </tr>
                <tr>
                    <% quarterly_reports.map { |r| r.as_of.is_a?(String) ? Date.parse(r.as_of) : r.as_of }.compact.uniq.sort.each do |as_of_date| %>
                        <th colspan="<%= tag_lists_to_display.count %>" class="text-center">
                            <%= as_of_date.strftime("%b-%y") %>
                        </th>
                        <% if show_achievement_column %>
                            <th rowspan="2" class="text-center">Actual / Budget</th>
                        <% end %>
                    <% end %>
                    <% year_reports.map { |r| r.as_of.is_a?(String) ? Date.parse(r.as_of) : r.as_of }.compact.uniq.sort.each do |as_of_date| %>
                        <th colspan="<%= tag_lists_to_display.count %>" class="text-center">
                            <%= as_of_date.strftime("%b-%y") %>
                        </th>
                        <% if show_achievement_column %>
                            <th rowspan="2" class="text-center">Actual / Budget</th>
                        <% end %>
                    <% end %>
                </tr>
                <tr>
                    <% quarterly_reports.map(&:as_of).uniq.sort.each do |as_of_date| %>
                        <% tag_lists_to_display.each do |tag| %>
                            <th><%= tag %></th>
                        <% end %>
                    <% end %>
                    <% year_reports.map(&:as_of).uniq.sort.each do |as_of_date| %>
                        <% tag_lists_to_display.each do |tag| %>
                            <th><%= tag %></th>
                        <% end %>
                    <% end %>
                </tr>
            </thead>
            <tbody>

                <% investor_kpi_mappings.each do |ikm| %>
                    <tr>
                        <td>
                            <%= ikm.id ? link_to(ikm.standard_kpi_name, investor_kpi_mapping_path(ikm.id)) : ikm.standard_kpi_name %>
                        </td>
                        <% # Render quarterly reports %>
                        <% quarterly_reports.map(&:as_of).uniq.sort.each do |as_of_date| %>
                            <% tag_lists_to_display.each do |tag| %>
                                <% kpi_report = grouped_quarterly_reports[as_of_date][tag] %>
                                <td class="value_<%= kpi_report&.kpis&.find{|k| k.name.downcase == ikm.standard_kpi_name.downcase}&.id %>">
                                    <% if kpi_report %>
                                        <% kpis = kpi_report.kpis.map{|kpi| [kpi.name.downcase, kpi]}.to_h %>
                                        <% kpi = kpis[ikm.standard_kpi_name.downcase].presence %>
                                        <% if kpi %>
                                            <%= link_to display_kpi(kpi, ikm, params: params), kpi %>
                                        <% else %>
                                            N/A
                                        <% end %>
                                    <% else %>
                                        N/A
                                    <% end %>
                                </td>
                            <% end %>
                            <% if show_achievement_column %>
                                <!-- Achievement % Column -->
                                <td>
                                    <%
                                        actual_kpi_report = grouped_quarterly_reports[as_of_date]['Actual']
                                        budget_kpi_report = grouped_quarterly_reports[as_of_date]['Budget']
                                        actual_kpi_value = actual_kpi_report&.kpis&.find{|k| k.name.downcase == ikm.standard_kpi_name.downcase}&.value
                                        budget_kpi_value = budget_kpi_report&.kpis&.find{|k| k.name.downcase == ikm.standard_kpi_name.downcase}&.value
                                    %>
                                    <% if actual_kpi_value.present? && budget_kpi_value.present? && budget_kpi_value != 0 %>
                                        <%= number_to_percentage((actual_kpi_value.to_f / budget_kpi_value.to_f) * 100, precision: 2) %>
                                    <% else %>
                                        N/A
                                    <% end %>
                                </td>
                            <% end %>
                        <% end %>

                        <% # Render yearly reports %>
                        <% year_reports.map(&:as_of).uniq.sort.each do |as_of_date| %>
                            <% tag_lists_to_display.each do |tag| %>
                                <% kpi_report = grouped_yearly_reports[as_of_date][tag] %>
                                <td class="value_<%= kpi_report&.kpis&.find{|k| k.name.downcase == ikm.standard_kpi_name.downcase}&.id %>">
                                    <% if kpi_report %>
                                        <% kpis = kpi_report.kpis.map{|kpi| [kpi.name.downcase, kpi]}.to_h %>
                                        <% kpi = kpis[ikm.standard_kpi_name.downcase].presence %>
                                        <% if kpi %>
                                            <%= link_to display_kpi(kpi, ikm, params: params), kpi %>
                                        <% else %>
                                            N/A
                                        <% end %>
                                    <% else %>
                                        N/A
                                    <% end %>
                                </td>
                            <% end %>
                            <% if show_achievement_column %>
                                <!-- Achievement % Column -->
                                <td>
                                    <%
                                        actual_kpi_report = grouped_yearly_reports[as_of_date]['Actual']
                                        budget_kpi_report = grouped_yearly_reports[as_of_date]['Budget']
                                        actual_kpi_value = actual_kpi_report&.kpis&.find{|k| k.name.downcase == ikm.standard_kpi_name.downcase}&.value
                                        budget_kpi_value = budget_kpi_report&.kpis&.find{|k| k.name.downcase == ikm.standard_kpi_name.downcase}&.value
                                    %>
                                    <% if actual_kpi_value.present? && budget_kpi_value.present? && budget_kpi_value != 0 %>
                                        <%= number_to_percentage((actual_kpi_value.to_f / budget_kpi_value.to_f) * 100, precision: 2) %>
                                    <% else %>
                                        N/A
                                    <% end %>
                                </td>
                            <% end %>
                        <% end %>
                    </tr>
                <% end %>
            </tbody>
        </table>
    </div>
<% end %>