<%= render "/layouts/steps", steps: ["This is the closing process for the sale", "Once completed the saleprice is frozen", "Please review the allocations post this step"].freeze if current_user.has_cached_role?(:startup) %>

<%= form_with(model: @secondary_sale, validate: true, id: "spa_upload") do |form| %>
  <% if @secondary_sale.errors.any? %>
    <div class="alert alert-danger">
      <h2><%= pluralize(@secondary_sale.errors.count, "error") %> prohibited this @secondary_sale from being saved:</h2>

      <ul>
        <% @secondary_sale.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>


  <div class="form-group fixed_price_group">
    <%= form.label :final_price %>
    <%= form.number_field :final_price, class: "form-control"  %>
    <small class="text-muted"> The final price at which the sale will be done. </small>
  </div>

  <div class="field" class="form-group" data-controller="directuploads" >
    <%= form.label :final_allocation %>
    <%= form.file_field :final_allocation, class: "form-control", direct_upload: true, multiple:false %>
    <small class="text-muted"> Upload final allocation for audit and to close out the sale. </small>
  </div>

  <div class="field" class="form-group" data-controller="directuploads" >
    <%= form.label :spa, "Share Purchase Agreement" %>
    <%= form.file_field :spa, class: "form-control", direct_upload: true, multiple:false %>
    <small class="text-muted"> Upload SPA for audit and to close out the sale. </small>
  </div>

  <% if @secondary_sale.sale_type != "FundRaise" %>
    <div class="form-group fixed_price_group">
      <%= form.label :seller_doc_list, "Seller Documents" %>
      <%= form.text_field :seller_doc_list, class: "form-control", placeholder: "PAN, Tax Certificate,Share Certificate / DEMAT Certificate"  %>
      <small class="text-muted"> Comma separated list of documents needed from each seller. </small>
    </div>
  <% end %>

  <div class="form-group fixed_price_group">
    <%= form.label :buyer_doc_list, "Buyer Documents" %>
    <%= form.text_field :buyer_doc_list, class: "form-control", placeholder: "PAN, Tax Certificate,Share Certificate / DEMAT Certificate"  %>
    <small class="text-muted"> Comma separated list of documents needed from each buyer. </small>
  </div>


  <div class="form-group">
    <%= form.submit "Save", class: "btn btn-lg btn-primary",
        data: { action: "click->confirm#popup", turbo:false, method: "post", "submit-form": "#spa_upload",
                msg: "This will freeze the final price for the sale. Post this You will need to start verifying the offers and finalizing the allocations."} %>

    <%= link_to "Review Allocations",offers_path(secondary_sale_id: @secondary_sale.id, finalize_allocation: true), 
                {class: "btn btn-lg btn-success" } if policy(@secondary_sale).view_allocations? %> 
  
  </div>
<% end %>
