# Pull Request: V9.1.11

### 1. Overview
This release introduces support for tracking currency in portfolio scenarios, allowing for financial metrics like IRR and MOIC to be calculated and displayed in a secondary currency, alongside several bug fixes and improvements.

### 2. Motivation
The primary motivation was to provide multi-currency support for fund performance analysis, which is a critical feature for funds operating across different currency zones. Additionally, several bugs were identified and fixed to improve the stability and accuracy of calculations.

### 3. What Changed
- **Portfolio Scenarios with Tracking Currency**:
    - `PortfolioScenarioJob` now calculates IRR and MOIC in both the fund's default currency and its tracking currency.
    - The UI has been updated to display these new metrics and to allow running scenarios with cash flows in the tracking currency.
    - `FinalizePortfolioScenario` service now saves `FundRatio` records for both currencies.
- **Bug Fixes**:
    - Fixed an issue in `FundRatiosJob` where IRR maps were not being reset, leading to incorrect calculations.
    - Corrected a bug in `FundUnitTransferService` where timestamps were not being set on new payments.
    - Prevented potential errors in `IncomingEmailsController` by truncating the `to` address.
    - Improved file deletion safety in `ChartAgentService` by using `FileUtils.rm_f`.
- **UI/UX Improvements**:
    - Improved JSON display in the agent charts view.
    - Correctly format calculated custom fields as currency.
- **Testing**:
    - Added a new feature test for portfolio scenarios with tracking currency.

### 4. Refactoring / Behavior Changes
- The `FundPortfolioCalcs` service was refactored to handle currency conversion for portfolio company metrics.
- The `PortfolioScenarioJob` was significantly refactored to accommodate the dual-currency calculations.

### 5. Testing
- Added a comprehensive feature test for the new tracking currency functionality in portfolio scenarios.
- Existing tests were passed.

### 6. Impact
- This change enhances the financial analysis capabilities of the platform by adding multi-currency support.
- There should be no negative performance impact.

### 7. Review Focus
- Please pay close attention to the currency conversion logic in `FundPortfolioCalcs` and the dual-currency calculations in `PortfolioScenarioJob`.
- Review the new feature test to ensure it covers the core functionality correctly.