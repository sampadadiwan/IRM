# PR for V9.1.08 to main

## Overview
This PR introduces significant enhancements to the Valuations module, refactors AI chart generation, and standardizes investor-related notification parameters across various modules, alongside minor bug fixes and deployment updates.

## Motivation
The changes aim to improve the usability and functionality of the Valuations module by integrating advanced filtering and display capabilities. The AI chart generation has been refactored for better maintainability. Standardization of investor IDs in mailers ensures consistent data passing for notifications. Deployment instructions have been updated for clarity and correctness.

## What Changed
*   **Valuations Module Enhancements**:
    *   Introduced Ransack for advanced filtering on `Valuation` records, including searching by `portfolio_company_name` and `per_share_value`.
    *   Refactored the Valuations index view to utilize `SearchComponent` and `RansackTable` for a more dynamic and filterable display.
    *   Added a new `ValuationDecorator` to handle display logic for investment instrument names and action buttons.
    *   Modified `valuations_chart` helper to accept pre-filtered valuations, improving flexibility.
    *   Included "Valuation" in the list of form types that can configure grids.
*   **AI Chart Generation Refactoring**:
    *   Extracted `build_system_msg` and `build_user_msg` methods in `ChartAgentService` for clearer separation of concerns and improved readability.
*   **Standardization of Investor IDs in Mailers**:
    *   Added `investor_id` to `default_params` in `AccessRightNotifier`, `InvestorAccessNotifier`, `InvestorKycNotifier`, `CapitalDistributionPaymentNotifier`, `CapitalRemittanceNotifier`, `CapitalRemittancePaymentNotifier`, `ExpressionOfInterestNotifier`, `InvestmentOpportunityNotifier`, `ApprovalNotifier`, `InterestNotifier`, `OfferNotifier`, and `SecondarySaleNotifier`. This ensures consistent passing of investor context for notifications.
*   **Mailer Logic Improvements**:
    *   Modified `ApplicationMailer#setup_cc` to consider `investor_id` when looking up investor-specific CCs.
    *   Updated `InvestorAdvisor#notify_investor_team` to notify only `active.company_admins`.
    *   Modified `InvestmentOpportunity#notify_open_for_interests` and `notify_allocation` to pass `investor_id` to the notifier.
*   **Minor Fixes and Enhancements**:
    *   Removed `super` call in `AgentChart#document_ids=` for direct assignment.
    *   Added Rubocop disable comments for complexity metrics in `WithFilterParams#ransack_has_attr?`.
    *   Added debug logging for `NameError` in `SqlTracer`.
    *   Added 'Valuations' to `REPORT_TYPES` in `Report` model.
    *   Changed "Show Help" `<a>` tag to `<button>` in `_breadcrumbs.html.erb`.
    *   Updated Clarity tracking script in `modernize.html.erb` to be conditional on `ENV["CLARITY_CODE"]` and include user/entity properties.
    *   Normalized `title` attribute in `CapitalDistribution` model to strip and squeeze spaces.
    *   Added `STANDARD_COLUMNS` constant to `InvestmentInstrument`.
*   **Deployment Updates**:
    *   Added prerequisites for deployment in `config/deploy/deploy.md`.
    *   Corrected the `rake packer` command for building AMIs to use `RAILS_ENV=production` and `prod` environment.

## Refactoring / Behavior Changes
*   The AI chart generation service has been refactored for better modularity.
*   The Valuations index page now uses a more dynamic and filterable table component, changing its behavior for data display and interaction.
*   Mailer notifications now consistently include `investor_id` in their parameters, which might affect how notifications are processed or logged if dependent systems rely on this context.

## Testing
*   Unit and integration tests for the Valuations module, mailers, and AI services should be reviewed to ensure continued functionality.
*   Manual testing of the Valuations index page, filtering, and chart display is recommended.
*   Verify that all investor-related notifications are sent correctly and contain the appropriate `investor_id`.
*   Confirm that the updated deployment commands work as expected in a staging environment.

## Impact
*   **User Interface**: The Valuations index page will have a new look and feel with enhanced filtering capabilities.
*   **Notifications**: Investor-related notifications will carry more context, potentially improving downstream processing.
*   **Deployment**: Deployment procedures for AMIs have been updated, requiring adherence to the new `RAILS_ENV=production` setting.
*   **Performance**: The new Ransack integration for Valuations might have minor performance implications depending on query complexity, which should be monitored.

## Review Focus
*   **Valuations Module**: Review the new `ValuationDecorator`, `RansackTable` integration, and the `Valuation` model's new scopes and ransackers for correctness and efficiency.
*   **Mailer Parameters**: Verify that the `investor_id` parameter is correctly passed and utilized across all modified notifiers and mailers.
*   **Clarity Tracking**: Ensure the new Clarity tracking script in `modernize.html.erb` functions as intended and correctly sets user/entity properties without introducing errors.
*   **Deployment Documentation**: Confirm the updated `config/deploy/deploy.md` accurately reflects the current deployment process.