import{e,a as t}from"../../../_/BQl9DXdy.js";import{e as r,a as s,b as n}from"../../../_/DTPuL17R.js";import*as i from"urlpattern-polyfill";import*as o from"crypto";import a from"buffer";import"mitt";var c={};var d;Object.defineProperty(c,"__esModule",{value:true});c.ProcessingQueue=void 0;const u=e;class ProcessingQueue{static LOGGER_PREFIX=`${u.LogType.debug}:queue`;#e;#t;#r=[];#s=false;constructor(e,t){this.#t=e;this.#e=t}add(e,t){this.#r.push([e,t]);void this.#n()}async#n(){if(!this.#s){this.#s=true;while(this.#r.length>0){const e=this.#r.shift();if(!e)continue;const[t,r]=e;this.#e?.(d.LOGGER_PREFIX,"Processing event:",r);await t.then((e=>{if(e.kind!=="error")return this.#t(e.value);this.#e?.(u.LogType.debugError,"Event threw before sending:",e.error.message,e.error.stack)})).catch((e=>{this.#e?.(u.LogType.debugError,"Event was not processed:",e?.message)}))}this.#s=false}}}c.ProcessingQueue=ProcessingQueue;d=ProcessingQueue;var l={};Object.defineProperty(l,"__esModule",{value:true});l.BidiNoOpParser=void 0;class BidiNoOpParser{parseHandleRequestDevicePromptParams(e){return e}parseSimulateAdapterParameters(e){return e}parseSimulateAdvertisementParameters(e){return e}parseSimulatePreconnectedPeripheralParameters(e){return e}parseRemoveUserContextParams(e){return e}parseActivateParams(e){return e}parseCaptureScreenshotParams(e){return e}parseCloseParams(e){return e}parseCreateParams(e){return e}parseGetTreeParams(e){return e}parseHandleUserPromptParams(e){return e}parseLocateNodesParams(e){return e}parseNavigateParams(e){return e}parsePrintParams(e){return e}parseReloadParams(e){return e}parseSetViewportParams(e){return e}parseTraverseHistoryParams(e){return e}parseGetSessionParams(e){return e}parseResolveRealmParams(e){return e}parseSendCommandParams(e){return e}parseAddPreloadScriptParams(e){return e}parseCallFunctionParams(e){return e}parseDisownParams(e){return e}parseEvaluateParams(e){return e}parseGetRealmsParams(e){return e}parseRemovePreloadScriptParams(e){return e}parsePerformActionsParams(e){return e}parseReleaseActionsParams(e){return e}parseSetFilesParams(e){return e}parseAddInterceptParams(e){return e}parseContinueRequestParams(e){return e}parseContinueResponseParams(e){return e}parseContinueWithAuthParams(e){return e}parseFailRequestParams(e){return e}parseProvideResponseParams(e){return e}parseRemoveInterceptParams(e){return e}parseSetCacheBehavior(e){return e}parseSetPermissionsParams(e){return e}parseSubscribeParams(e){return e}parseDeleteCookiesParams(e){return e}parseGetCookiesParams(e){return e}parseSetCookieParams(e){return e}}l.BidiNoOpParser=BidiNoOpParser;var h={};Object.defineProperty(h,"__esModule",{value:true});h.BrowserProcessor=void 0;const p=r;class BrowserProcessor{#i;constructor(e){this.#i=e}close(){setTimeout((()=>this.#i.sendCommand("Browser.close")),0);return{}}async createUserContext(e){const t={proxyServer:e["goog:proxyServer"]??void 0};const r=e["goog:proxyBypassList"]??void 0;r&&(t.proxyBypassList=r.join(","));const s=await this.#i.sendCommand("Target.createBrowserContext",t);return{userContext:s.browserContextId}}async removeUserContext(e){const t=e.userContext;if(t==="default")throw new p.InvalidArgumentException("`default` user context cannot be removed");try{await this.#i.sendCommand("Target.disposeBrowserContext",{browserContextId:t})}catch(e){if(e.message.startsWith("Failed to find context with id"))throw new p.NoSuchUserContextException(e.message);throw e}return{}}async getUserContexts(){const e=await this.#i.sendCommand("Target.getBrowserContexts");return{userContexts:[{userContext:"default"},...e.browserContextIds.map((e=>({userContext:e})))]}}}h.BrowserProcessor=BrowserProcessor;var g={};Object.defineProperty(g,"__esModule",{value:true});g.CdpProcessor=void 0;const m=r;class CdpProcessor{#o;#a;#c;#i;constructor(e,t,r,s){this.#o=e;this.#a=t;this.#c=r;this.#i=s}getSession(e){const t=e.context;const r=this.#o.getContext(t).cdpTarget.cdpSessionId;return r===void 0?{}:{session:r}}resolveRealm(e){const t=e.realm;const r=this.#a.getRealm({realmId:t});if(r===void 0)throw new m.UnknownErrorException(`Could not find realm ${e.realm}`);return{executionContextId:r.executionContextId}}async sendCommand(e){const t=e.session?this.#c.getCdpClient(e.session):this.#i;const r=await t.sendCommand(e.method,e.params);return{result:r,session:e.session}}}g.CdpProcessor=CdpProcessor;var w={};Object.defineProperty(w,"__esModule",{value:true});w.BrowsingContextProcessor=void 0;const f=r;class BrowsingContextProcessor{#i;#o;#d;constructor(e,t,r){this.#i=e;this.#o=t;this.#d=r;this.#d.addSubscribeHook(f.ChromiumBidi.BrowsingContext.EventNames.ContextCreated,this.#u.bind(this))}getTree(e){const t=e.root===void 0?this.#o.getTopLevelContexts():[this.#o.getContext(e.root)];return{contexts:t.map((t=>t.serializeToBidiValue(e.maxDepth??Number.MAX_VALUE)))}}async create(e){let t;let r="default";if(e.referenceContext!==void 0){t=this.#o.getContext(e.referenceContext);if(!t.isTopLevelContext())throw new f.InvalidArgumentException("referenceContext should be a top-level context");r=t.userContext}e.userContext!==void 0&&(r=e.userContext);const s=this.#o.getAllContexts().filter((e=>e.userContext===r));let n=false;switch(e.type){case"tab":n=false;break;case"window":n=true;break}s.length||(n=true);let i;try{i=await this.#i.sendCommand("Target.createTarget",{url:"about:blank",newWindow:n,browserContextId:r==="default"?void 0:r,background:e.background===true})}catch(e){if(e.message.startsWith("Failed to find browser context with id")||e.message==="browserContextId")throw new f.NoSuchUserContextException(`The context ${r} was not found`);throw e}const o=await this.#o.waitForContext(i.targetId);await o.lifecycleLoaded();return{context:o.id}}navigate(e){const t=this.#o.getContext(e.context);return t.navigate(e.url,e.wait??"none")}reload(e){const t=this.#o.getContext(e.context);return t.reload(e.ignoreCache??false,e.wait??"none")}async activate(e){const t=this.#o.getContext(e.context);if(!t.isTopLevelContext())throw new f.InvalidArgumentException("Activation is only supported on the top-level context");await t.activate();return{}}async captureScreenshot(e){const t=this.#o.getContext(e.context);return await t.captureScreenshot(e)}async print(e){const t=this.#o.getContext(e.context);return await t.print(e)}async setViewport(e){const t=this.#o.getContext(e.context);if(!t.isTopLevelContext())throw new f.InvalidArgumentException("Emulating viewport is only supported on the top-level context");await t.setViewport(e.viewport,e.devicePixelRatio);return{}}async traverseHistory(e){const t=this.#o.getContext(e.context);if(!t)throw new f.InvalidArgumentException(`No browsing context with id ${e.context}`);if(!t.isTopLevelContext())throw new f.InvalidArgumentException("Traversing history is only supported on the top-level context");await t.traverseHistory(e.delta);return{}}async handleUserPrompt(e){const t=this.#o.getContext(e.context);try{await t.handleUserPrompt(e.accept,e.userText)}catch(e){if(e.message?.includes("No dialog is showing"))throw new f.NoSuchAlertException("No dialog is showing");throw e}return{}}async close(e){const t=this.#o.getContext(e.context);if(!t.isTopLevelContext())throw new f.InvalidArgumentException(`Non top-level browsing context ${t.id} cannot be closed.`);const r=t.cdpTarget.parentCdpClient;try{const s=new Promise((t=>{const onContextDestroyed=s=>{if(s.targetId===e.context){r.off("Target.detachedFromTarget",onContextDestroyed);t()}};r.on("Target.detachedFromTarget",onContextDestroyed)}));try{e.promptUnload?await t.close():await r.sendCommand("Target.closeTarget",{targetId:e.context})}catch(e){if(!r.isCloseError(e))throw e}await s}catch(e){if(!(e.code===-32e3&&e.message==="Not attached to an active page"))throw e}return{}}async locateNodes(e){const t=this.#o.getContext(e.context);return await t.locateNodes(e)}#u(e){const t=this.#o.getContext(e);const r=[t,...this.#o.getContext(e).allChildren];r.forEach((e=>{this.#d.registerEvent({type:"event",method:f.ChromiumBidi.BrowsingContext.EventNames.ContextCreated,params:e.serializeToBidiValue()},e.id)}));return Promise.resolve()}}w.BrowsingContextProcessor=BrowsingContextProcessor;var v={};Object.defineProperty(v,"__esModule",{value:true});v.assert=assert;function assert(e,t){if(!e)throw new Error(t??"Internal assertion failed.")}var C={};Object.defineProperty(C,"__esModule",{value:true});C.isSingleComplexGrapheme=isSingleComplexGrapheme;C.isSingleGrapheme=isSingleGrapheme;function isSingleComplexGrapheme(e){return isSingleGrapheme(e)&&e.length>1}function isSingleGrapheme(e){const t=new Intl.Segmenter("en",{granularity:"grapheme"});return[...t.segment(e)].length===1}var b={};Object.defineProperty(b,"__esModule",{value:true});b.WheelSource=b.PointerSource=b.KeySource=b.NoneSource=void 0;class NoneSource{type="none"}b.NoneSource=NoneSource;class KeySource{type="key";pressed=new Set;#l=0;get modifiers(){return this.#l}get alt(){return(this.#l&1)===1}set alt(e){this.#h(e,1)}get ctrl(){return(this.#l&2)===2}set ctrl(e){this.#h(e,2)}get meta(){return(this.#l&4)===4}set meta(e){this.#h(e,4)}get shift(){return(this.#l&8)===8}set shift(e){this.#h(e,8)}#h(e,t){e?this.#l|=t:this.#l&=~t}}b.KeySource=KeySource;class PointerSource{type="pointer";subtype;pointerId;pressed=new Set;x=0;y=0;radiusX;radiusY;force;constructor(e,t){this.pointerId=e;this.subtype=t}get buttons(){let e=0;for(const t of this.pressed)switch(t){case 0:e|=1;break;case 1:e|=4;break;case 2:e|=2;break;case 3:e|=8;break;case 4:e|=16;break}return e}static ClickContext=class ClickContext{static#p=500;static#g=2;count=0;#m;#w;#f;constructor(e,t,r){this.#m=e;this.#w=t;this.#f=r}compare(e){return e.#f-this.#f>ClickContext.#p||Math.abs(e.#m-this.#m)>ClickContext.#g||Math.abs(e.#w-this.#w)>ClickContext.#g}};#v=new Map;setClickCount(e,t){let r=this.#v.get(e);r&&!r.compare(t)||(r=t);++r.count;this.#v.set(e,r);return r.count}getClickCount(e){return this.#v.get(e)?.count??0}}b.PointerSource=PointerSource;PointerSource;class WheelSource{type="wheel"}b.WheelSource=WheelSource;var x={};Object.defineProperty(x,"__esModule",{value:true});x.getNormalizedKey=getNormalizedKey;x.getKeyCode=getKeyCode;x.getKeyLocation=getKeyLocation;function getNormalizedKey(e){switch(e){case"":return"Unidentified";case"":return"Cancel";case"":return"Help";case"":return"Backspace";case"":return"Tab";case"":return"Clear";case"":case"":return"Enter";case"":return"Shift";case"":return"Control";case"":return"Alt";case"":return"Pause";case"":return"Escape";case"":return" ";case"":return"PageUp";case"":return"PageDown";case"":return"End";case"":return"Home";case"":return"ArrowLeft";case"":return"ArrowUp";case"":return"ArrowRight";case"":return"ArrowDown";case"":return"Insert";case"":return"Delete";case"":return";";case"":return"=";case"":return"0";case"":return"1";case"":return"2";case"":return"3";case"":return"4";case"":return"5";case"":return"6";case"":return"7";case"":return"8";case"":return"9";case"":return"*";case"":return"+";case"":return",";case"":return"-";case"":return".";case"":return"/";case"":return"F1";case"":return"F2";case"":return"F3";case"":return"F4";case"":return"F5";case"":return"F6";case"":return"F7";case"":return"F8";case"":return"F9";case"":return"F10";case"":return"F11";case"":return"F12";case"":return"Meta";case"":return"ZenkakuHankaku";case"":return"Shift";case"":return"Control";case"":return"Alt";case"":return"Meta";case"":return"PageUp";case"":return"PageDown";case"":return"End";case"":return"Home";case"":return"ArrowLeft";case"":return"ArrowUp";case"":return"ArrowRight";case"":return"ArrowDown";case"":return"Insert";case"":return"Delete";default:return e}}function getKeyCode(e){switch(e){case"`":case"~":return"Backquote";case"\\":case"|":return"Backslash";case"":return"Backspace";case"[":case"{":return"BracketLeft";case"]":case"}":return"BracketRight";case",":case"<":return"Comma";case"0":case")":return"Digit0";case"1":case"!":return"Digit1";case"2":case"@":return"Digit2";case"3":case"#":return"Digit3";case"4":case"$":return"Digit4";case"5":case"%":return"Digit5";case"6":case"^":return"Digit6";case"7":case"&":return"Digit7";case"8":case"*":return"Digit8";case"9":case"(":return"Digit9";case"=":case"+":return"Equal";case">":return"IntlBackslash";case"a":case"A":return"KeyA";case"b":case"B":return"KeyB";case"c":case"C":return"KeyC";case"d":case"D":return"KeyD";case"e":case"E":return"KeyE";case"f":case"F":return"KeyF";case"g":case"G":return"KeyG";case"h":case"H":return"KeyH";case"i":case"I":return"KeyI";case"j":case"J":return"KeyJ";case"k":case"K":return"KeyK";case"l":case"L":return"KeyL";case"m":case"M":return"KeyM";case"n":case"N":return"KeyN";case"o":case"O":return"KeyO";case"p":case"P":return"KeyP";case"q":case"Q":return"KeyQ";case"r":case"R":return"KeyR";case"s":case"S":return"KeyS";case"t":case"T":return"KeyT";case"u":case"U":return"KeyU";case"v":case"V":return"KeyV";case"w":case"W":return"KeyW";case"x":case"X":return"KeyX";case"y":case"Y":return"KeyY";case"z":case"Z":return"KeyZ";case"-":case"_":return"Minus";case".":return"Period";case"'":case'"':return"Quote";case";":case":":return"Semicolon";case"/":case"?":return"Slash";case"":return"AltLeft";case"":return"AltRight";case"":return"ControlLeft";case"":return"ControlRight";case"":return"Enter";case"":return"Pause";case"":return"MetaLeft";case"":return"MetaRight";case"":return"ShiftLeft";case"":return"ShiftRight";case" ":case"":return"Space";case"":return"Tab";case"":return"Delete";case"":return"End";case"":return"Help";case"":return"Home";case"":return"Insert";case"":return"PageDown";case"":return"PageUp";case"":return"ArrowDown";case"":return"ArrowLeft";case"":return"ArrowRight";case"":return"ArrowUp";case"":return"Escape";case"":return"F1";case"":return"F2";case"":return"F3";case"":return"F4";case"":return"F5";case"":return"F6";case"":return"F7";case"":return"F8";case"":return"F9";case"":return"F10";case"":return"F11";case"":return"F12";case"":return"NumpadEqual";case"":case"":return"Numpad0";case"":case"":return"Numpad1";case"":case"":return"Numpad2";case"":case"":return"Numpad3";case"":case"":return"Numpad4";case"":return"Numpad5";case"":case"":return"Numpad6";case"":case"":return"Numpad7";case"":case"":return"Numpad8";case"":case"":return"Numpad9";case"":return"NumpadAdd";case"":return"NumpadComma";case"":case"":return"NumpadDecimal";case"":return"NumpadDivide";case"":return"NumpadEnter";case"":return"NumpadMultiply";case"":return"NumpadSubtract";default:return}}function getKeyLocation(e){switch(e){case"":case"":case"":case"":case"":return 1;case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":case"":return 3;case"":case"":case"":case"":return 2;default:return 0}}var y={};Object.defineProperty(y,"__esModule",{value:true});y.KeyToKeyCode=void 0;y.KeyToKeyCode={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,Abort:3,Help:6,Backspace:8,Tab:9,Numpad5:12,NumpadEnter:13,Enter:13,"\\r":13,"\\n":13,ShiftLeft:16,ShiftRight:16,ControlLeft:17,ControlRight:17,AltLeft:18,AltRight:18,Pause:19,CapsLock:20,Escape:27,Convert:28,NonConvert:29,Space:32,Numpad9:33,PageUp:33,Numpad3:34,PageDown:34,End:35,Numpad1:35,Home:36,Numpad7:36,ArrowLeft:37,Numpad4:37,Numpad8:38,ArrowUp:38,ArrowRight:39,Numpad6:39,Numpad2:40,ArrowDown:40,Select:41,Open:43,PrintScreen:44,Insert:45,Numpad0:45,Delete:46,NumpadDecimal:46,Digit0:48,Digit1:49,Digit2:50,Digit3:51,Digit4:52,Digit5:53,Digit6:54,Digit7:55,Digit8:56,Digit9:57,KeyA:65,KeyB:66,KeyC:67,KeyD:68,KeyE:69,KeyF:70,KeyG:71,KeyH:72,KeyI:73,KeyJ:74,KeyK:75,KeyL:76,KeyM:77,KeyN:78,KeyO:79,KeyP:80,KeyQ:81,KeyR:82,KeyS:83,KeyT:84,KeyU:85,KeyV:86,KeyW:87,KeyX:88,KeyY:89,KeyZ:90,MetaLeft:91,MetaRight:92,ContextMenu:93,NumpadMultiply:106,NumpadAdd:107,NumpadSubtract:109,NumpadDivide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumLock:144,ScrollLock:145,AudioVolumeMute:173,AudioVolumeDown:174,AudioVolumeUp:175,MediaTrackNext:176,MediaTrackPrevious:177,MediaStop:178,MediaPlayPause:179,Semicolon:186,Equal:187,NumpadEqual:187,Comma:188,Minus:189,Period:190,Slash:191,Backquote:192,BracketLeft:219,Backslash:220,BracketRight:221,Quote:222,AltGraph:225,Props:247,Cancel:3,Clear:12,Shift:16,Control:17,Alt:18,Accept:30,ModeChange:31," ":32,Print:42,Execute:43,"\\u0000":46,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,Meta:91,"*":106,"+":107,"-":109,"/":111,";":186,"=":187,",":188,".":190,"`":192,"[":219,"\\\\":220,"]":221,"'":222,Attn:246,CrSel:247,ExSel:248,EraseEof:249,Play:250,ZoomOut:251,")":48,"!":49,"@":50,"#":51,$:52,"%":53,"^":54,"&":55,"(":57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,":":186,"<":188,_:189,">":190,"?":191,"~":192,"{":219,"|":220,"}":221,'"':222,Camera:44,EndCall:95,VolumeDown:182,VolumeUp:183};var S={};Object.defineProperty(S,"__esModule",{value:true});S.ActionDispatcher=void 0;const P=r;const I=v;const E=C;const k=b;const T=x;const M=y;const N=(e=>{const t=e.getClientRects()[0],r=Math.max(0,Math.min(t.x,t.x+t.width)),s=Math.min(window.innerWidth,Math.max(t.x,t.x+t.width)),n=Math.max(0,Math.min(t.y,t.y+t.height)),i=Math.min(window.innerHeight,Math.max(t.y,t.y+t.height));return[r+(s-r>>1),n+(i-n>>1)]}).toString();const R=(()=>navigator.platform.toLowerCase().includes("mac")).toString();async function getElementCenter(e,t){const r=await e.getOrCreateSandbox(void 0);const s=await r.callFunction(N,false,{type:"undefined"},[t]);if(s.type==="exception")throw new P.NoSuchElementException(`Origin element ${t.sharedId} was not found`);(0,I.assert)(s.result.type==="array");(0,I.assert)(s.result.value?.[0]?.type==="number");(0,I.assert)(s.result.value?.[1]?.type==="number");const{result:{value:[{value:n},{value:i}]}}=s;return{x:n,y:i}}class ActionDispatcher{static isMacOS=async e=>{const t=await(await e.getOrCreateSandbox(void 0)).callFunction(R,false);(0,I.assert)(t.type!=="exception");(0,I.assert)(t.result.type==="boolean");return t.result.value};#C=0;#b=0;#x;#y;#S;constructor(e,t,r){this.#x=e;this.#y=t;this.#S=r}async dispatchActions(e){await this.#x.queue.run((async()=>{for(const t of e)await this.dispatchTickActions(t)}))}async dispatchTickActions(e){this.#C=performance.now();this.#b=0;for(const{action:t}of e)"duration"in t&&t.duration!==void 0&&(this.#b=Math.max(this.#b,t.duration));const t=[new Promise((e=>setTimeout(e,this.#b)))];for(const r of e)t.push(this.#P(r));await Promise.all(t)}async#P({id:e,action:t}){const r=this.#x.get(e);const s=this.#x.getGlobalKeyState();switch(t.type){case"keyDown":await this.#I(r,t);this.#x.cancelList.push({id:e,action:{...t,type:"keyUp"}});break;case"keyUp":await this.#E(r,t);break;case"pause":break;case"pointerDown":await this.#k(r,s,t);this.#x.cancelList.push({id:e,action:{...t,type:"pointerUp"}});break;case"pointerMove":await this.#T(r,s,t);break;case"pointerUp":await this.#M(r,s,t);break;case"scroll":await this.#N(r,s,t);break}}async#k(e,t,r){const{button:s}=r;if(e.pressed.has(s))return;e.pressed.add(s);const{x:n,y:i,subtype:o}=e;const{width:a,height:c,pressure:d,twist:u,tangentialPressure:l}=r;const{tiltX:h,tiltY:p}=getTilt(r);const{modifiers:g}=t;const{radiusX:m,radiusY:w}=getRadii(a??1,c??1);switch(o){case"mouse":case"pen":await this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchMouseEvent",{type:"mousePressed",x:n,y:i,modifiers:g,button:getCdpButton(s),buttons:e.buttons,clickCount:e.setClickCount(s,new k.PointerSource.ClickContext(n,i,performance.now())),pointerType:o,tangentialPressure:l,tiltX:h,tiltY:p,twist:u,force:d});break;case"touch":await this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchTouchEvent",{type:"touchStart",touchPoints:[{x:n,y:i,radiusX:m,radiusY:w,tangentialPressure:l,tiltX:h,tiltY:p,twist:u,force:d,id:e.pointerId}],modifiers:g});break}e.radiusX=m;e.radiusY=w;e.force=d}#M(e,t,r){const{button:s}=r;if(!e.pressed.has(s))return;e.pressed.delete(s);const{x:n,y:i,force:o,radiusX:a,radiusY:c,subtype:d}=e;const{modifiers:u}=t;switch(d){case"mouse":case"pen":return this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchMouseEvent",{type:"mouseReleased",x:n,y:i,modifiers:u,button:getCdpButton(s),buttons:e.buttons,clickCount:e.getClickCount(s),pointerType:d});case"touch":return this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchTouchEvent",{type:"touchEnd",touchPoints:[{x:n,y:i,id:e.pointerId,force:o,radiusX:a,radiusY:c}],modifiers:u})}}async#T(e,t,r){const{x:s,y:n,subtype:i}=e;const{width:o,height:a,pressure:c,twist:d,tangentialPressure:u,x:l,y:h,origin:p="viewport",duration:g=this.#b}=r;const{tiltX:m,tiltY:w}=getTilt(r);const{radiusX:f,radiusY:v}=getRadii(o??1,a??1);const{targetX:C,targetY:b}=await this.#R(p,l,h,s,n);if(C<0||b<0)throw new P.MoveTargetOutOfBoundsException(`Cannot move beyond viewport (x: ${C}, y: ${b})`);let x;do{const r=g>0?(performance.now()-this.#C)/g:1;x=r>=1;let o;let a;if(x){o=C;a=b}else{o=Math.round(r*(C-s)+s);a=Math.round(r*(b-n)+n)}if(e.x!==o||e.y!==a){const{modifiers:r}=t;switch(i){case"mouse":await this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchMouseEvent",{type:"mouseMoved",x:o,y:a,modifiers:r,clickCount:0,button:getCdpButton(e.pressed.values().next().value??5),buttons:e.buttons,pointerType:i,tangentialPressure:u,tiltX:m,tiltY:w,twist:d,force:c});break;case"pen":e.pressed.size!==0&&await this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchMouseEvent",{type:"mouseMoved",x:o,y:a,modifiers:r,clickCount:0,button:getCdpButton(e.pressed.values().next().value??5),buttons:e.buttons,pointerType:i,tangentialPressure:u,tiltX:m,tiltY:w,twist:d,force:c??.5});break;case"touch":e.pressed.size!==0&&await this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchTouchEvent",{type:"touchMove",touchPoints:[{x:o,y:a,radiusX:f,radiusY:v,tangentialPressure:u,tiltX:m,tiltY:w,twist:d,force:c,id:e.pointerId}],modifiers:r});break}e.x=o;e.y=a;e.radiusX=f;e.radiusY=v;e.force=c}}while(!x)}async#B(){try{const{backendNodeId:e}=await this.#y.cdpTarget.cdpClient.sendCommand("DOM.getFrameOwner",{frameId:this.#y.id});const{model:t}=await this.#y.cdpTarget.cdpClient.sendCommand("DOM.getBoxModel",{backendNodeId:e});return{x:t.content[0],y:t.content[1]}}catch(e){if(e.code===-32e3&&e.message==="Frame with the given id does not belong to the target.")return{x:0,y:0};throw e}}async#R(e,t,r,s,n){let i;let o;const a=await this.#B();switch(e){case"viewport":i=t+a.x;o=r+a.y;break;case"pointer":i=s+t+a.x;o=n+r+a.y;break;default:{const{x:s,y:n}=await getElementCenter(this.#y,e.element);i=s+t+a.x;o=n+r+a.y;break}}return{targetX:i,targetY:o}}async#N(e,t,r){const{deltaX:s,deltaY:n,x:i,y:o,origin:a="viewport",duration:c=this.#b}=r;if(a==="pointer")throw new P.InvalidArgumentException('"pointer" origin is invalid for scrolling.');const{targetX:d,targetY:u}=await this.#R(a,i,o,0,0);if(d<0||u<0)throw new P.MoveTargetOutOfBoundsException(`Cannot move beyond viewport (x: ${d}, y: ${u})`);let l=0;let h=0;let p;do{const e=c>0?(performance.now()-this.#C)/c:1;p=e>=1;let r;let i;if(p){r=s-l;i=n-h}else{r=Math.round(e*s-l);i=Math.round(e*n-h)}if(r!==0||i!==0){const{modifiers:e}=t;await this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchMouseEvent",{type:"mouseWheel",deltaX:r,deltaY:i,x:d,y:u,modifiers:e});l+=r;h+=i}}while(!p)}async#I(e,t){const r=t.value;if(!(0,E.isSingleGrapheme)(r))throw new P.InvalidArgumentException(`Invalid key value: ${r}`);const s=(0,E.isSingleComplexGrapheme)(r);const n=(0,T.getNormalizedKey)(r);const i=e.pressed.has(n);const o=(0,T.getKeyCode)(r);const a=(0,T.getKeyLocation)(r);switch(n){case"Alt":e.alt=true;break;case"Shift":e.shift=true;break;case"Control":e.ctrl=true;break;case"Meta":e.meta=true;break}e.pressed.add(n);const{modifiers:c}=e;const d=getKeyEventUnmodifiedText(n,e,s);const u=getKeyEventText(o??"",e)??d;let l;if(this.#S&&e.meta)switch(o){case"KeyA":l="SelectAll";break;case"KeyC":l="Copy";break;case"KeyV":l=e.shift?"PasteAndMatchStyle":"Paste";break;case"KeyX":l="Cut";break;case"KeyZ":l=e.shift?"Redo":"Undo";break;default:}const h=[this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchKeyEvent",{type:u?"keyDown":"rawKeyDown",windowsVirtualKeyCode:M.KeyToKeyCode[n],key:n,code:o,text:u,unmodifiedText:d,autoRepeat:i,isSystemKey:e.alt||void 0,location:a<3?a:void 0,isKeypad:a===3,modifiers:c,commands:l?[l]:void 0})];n==="Escape"&&(e.alt||(!this.#S||e.ctrl||e.meta)&&this.#S||h.push(this.#y.cdpTarget.cdpClient.sendCommand("Input.cancelDragging")));await Promise.all(h)}#E(e,t){const r=t.value;if(!(0,E.isSingleGrapheme)(r))throw new P.InvalidArgumentException(`Invalid key value: ${r}`);const s=(0,E.isSingleComplexGrapheme)(r);const n=(0,T.getNormalizedKey)(r);if(!e.pressed.has(n))return;const i=(0,T.getKeyCode)(r);const o=(0,T.getKeyLocation)(r);switch(n){case"Alt":e.alt=false;break;case"Shift":e.shift=false;break;case"Control":e.ctrl=false;break;case"Meta":e.meta=false;break}e.pressed.delete(n);const{modifiers:a}=e;const c=getKeyEventUnmodifiedText(n,e,s);const d=getKeyEventText(i??"",e)??c;return this.#y.cdpTarget.cdpClient.sendCommand("Input.dispatchKeyEvent",{type:"keyUp",windowsVirtualKeyCode:M.KeyToKeyCode[n],key:n,code:i,text:d,unmodifiedText:c,location:o<3?o:void 0,isSystemKey:e.alt||void 0,isKeypad:o===3,modifiers:a})}}S.ActionDispatcher=ActionDispatcher;const getKeyEventUnmodifiedText=(e,t,r)=>r?e:e==="Enter"?"\r":[...e].length===1?t.shift?e.toLocaleUpperCase("en-US"):e:void 0;const getKeyEventText=(e,t)=>{if(t.ctrl){switch(e){case"Digit2":if(t.shift)return"\0";break;case"KeyA":return"";case"KeyB":return"";case"KeyC":return"";case"KeyD":return"";case"KeyE":return"";case"KeyF":return"";case"KeyG":return"";case"KeyH":return"\b";case"KeyI":return"\t";case"KeyJ":return"\n";case"KeyK":return"\v";case"KeyL":return"\f";case"KeyM":return"\r";case"KeyN":return"";case"KeyO":return"";case"KeyP":return"";case"KeyQ":return"";case"KeyR":return"";case"KeyS":return"";case"KeyT":return"";case"KeyU":return"";case"KeyV":return"";case"KeyW":return"";case"KeyX":return"";case"KeyY":return"";case"KeyZ":return"";case"BracketLeft":return"";case"Backslash":return"";case"BracketRight":return"";case"Digit6":if(t.shift)return"";break;case"Minus":return""}return""}if(t.alt)return""};function getCdpButton(e){switch(e){case 0:return"left";case 1:return"middle";case 2:return"right";case 3:return"back";case 4:return"forward";default:return"none"}}function getTilt(e){const t=e.altitudeAngle??Math.PI/2;const r=e.azimuthAngle??0;let s=0;let n=0;if(t===0){r!==0&&r!==2*Math.PI||(s=Math.PI/2);r===Math.PI/2&&(n=Math.PI/2);r===Math.PI&&(s=-Math.PI/2);r===3*Math.PI/2&&(n=-Math.PI/2);if(r>0&&r<Math.PI/2){s=Math.PI/2;n=Math.PI/2}if(r>Math.PI/2&&r<Math.PI){s=-Math.PI/2;n=Math.PI/2}if(r>Math.PI&&r<3*Math.PI/2){s=-Math.PI/2;n=-Math.PI/2}if(r>3*Math.PI/2&&r<2*Math.PI){s=Math.PI/2;n=-Math.PI/2}}if(t!==0){const e=Math.tan(t);s=Math.atan(Math.cos(r)/e);n=Math.atan(Math.sin(r)/e)}const i=180/Math.PI;return{tiltX:Math.round(s*i),tiltY:Math.round(n*i)}}function getRadii(e,t){return{radiusX:e?e/2:.5,radiusY:t?t/2:.5}}var B={};Object.defineProperty(B,"__esModule",{value:true});B.Mutex=void 0;class Mutex{#D=false;#F=[];acquire(){const e={resolved:false};if(this.#D)return new Promise((t=>{this.#F.push((()=>t(this.#O.bind(this,e))))}));this.#D=true;return Promise.resolve(this.#O.bind(this,e))}#O(e){if(e.resolved)throw new Error("Cannot release more than once.");e.resolved=true;const t=this.#F.shift();t?t():this.#D=false}async run(e){const t=await this.acquire();try{const t=await e();return t}finally{t()}}}B.Mutex=Mutex;var D={};Object.defineProperty(D,"__esModule",{value:true});D.InputState=void 0;const F=r;const O=B;const A=b;class InputState{cancelList=[];#A=new Map;#q=new O.Mutex;getOrCreate(e,t,r){let s=this.#A.get(e);if(!s){switch(t){case"none":s=new A.NoneSource;break;case"key":s=new A.KeySource;break;case"pointer":{let e=r==="mouse"?0:2;const t=new Set;for(const[,e]of this.#A)e.type==="pointer"&&t.add(e.pointerId);while(t.has(e))++e;s=new A.PointerSource(e,r);break}case"wheel":s=new A.WheelSource;break;default:throw new F.InvalidArgumentException(`Expected "none", "key", "pointer", or "wheel". Found unknown source type ${t}.`)}this.#A.set(e,s);return s}if(s.type!==t)throw new F.InvalidArgumentException(`Input source type of ${e} is ${s.type}, but received ${t}.`);return s}get(e){const t=this.#A.get(e);if(!t)throw new F.UnknownErrorException("Internal error.");return t}getGlobalKeyState(){const e=new A.KeySource;for(const[,t]of this.#A)if(t.type==="key"){for(const r of t.pressed)e.pressed.add(r);e.alt||=t.alt;e.ctrl||=t.ctrl;e.meta||=t.meta;e.shift||=t.shift}return e}get queue(){return this.#q}}D.InputState=InputState;var q={};Object.defineProperty(q,"__esModule",{value:true});q.InputStateManager=void 0;const L=v;const U=D;class InputStateManager extends WeakMap{get(e){(0,L.assert)(e.isTopLevelContext());this.has(e)||this.set(e,new U.InputState);return super.get(e)}}q.InputStateManager=InputStateManager;var j={};Object.defineProperty(j,"__esModule",{value:true});j.InputProcessor=void 0;const K=r;const H=v;const _=S;const z=q;class InputProcessor{#o;#L=new z.InputStateManager;constructor(e){this.#o=e}async performActions(e){const t=this.#o.getContext(e.context);const r=this.#L.get(t.top);const s=this.#U(e,r);const n=new _.ActionDispatcher(r,t,await _.ActionDispatcher.isMacOS(t).catch((()=>false)));await n.dispatchActions(s);return{}}async releaseActions(e){const t=this.#o.getContext(e.context);const r=t.top;const s=this.#L.get(r);const n=new _.ActionDispatcher(s,t,await _.ActionDispatcher.isMacOS(t).catch((()=>false)));await n.dispatchTickActions(s.cancelList.reverse());this.#L.delete(r);return{}}async setFiles(e){const t=this.#o.getContext(e.context);const r=await t.getOrCreateSandbox(void 0);let s;try{s=await r.callFunction(String((function getFiles(e){return this instanceof HTMLInputElement?this.type!=="file"?2:this.disabled?3:e>1&&!this.multiple?4:void 0:this instanceof Element?1:0})),false,e.element,[{type:"number",value:e.files.length}])}catch{throw new K.NoSuchNodeException(`Could not find element ${e.element.sharedId}`)}(0,H.assert)(s.type==="success");if(s.result.type==="number")switch(s.result.value){case 0:throw new K.NoSuchElementException(`Could not find element ${e.element.sharedId}`);case 1:throw new K.UnableToSetFileInputException(`Element ${e.element.sharedId} is not a input`);case 2:throw new K.UnableToSetFileInputException(`Input element ${e.element.sharedId} is not a file type`);case 3:throw new K.UnableToSetFileInputException(`Input element ${e.element.sharedId} is disabled`);case 4:throw new K.UnableToSetFileInputException("Cannot set multiple files on a non-multiple input element")}if(e.files.length===0){await r.callFunction(String((function dispatchEvent(){if(this.files?.length!==0){this.files=(new DataTransfer).files;this.dispatchEvent(new Event("input",{bubbles:true,composed:true}));this.dispatchEvent(new Event("change",{bubbles:true}))}else this.dispatchEvent(new Event("cancel",{bubbles:true}))})),false,e.element);return{}}const n=[];for(let t=0;t<e.files.length;++t){const t=await r.callFunction(String((function getFiles(e){return this.files?.item(e)})),false,e.element,[{type:"number",value:0}],"root");(0,H.assert)(t.type==="success");if(t.result.type!=="object")break;const{handle:s}=t.result;(0,H.assert)(s!==void 0);const{path:i}=await r.cdpClient.sendCommand("DOM.getFileInfo",{objectId:s});n.push(i);void r.disown(s).catch(void 0)}n.sort();const i=[...e.files].sort();if(n.length!==e.files.length||i.some(((e,t)=>n[t]!==e))){const{objectId:t}=await r.deserializeForCdp(e.element);(0,H.assert)(t!==void 0);await r.cdpClient.sendCommand("DOM.setFileInputFiles",{files:e.files,objectId:t})}else await r.callFunction(String((function dispatchEvent(){this.dispatchEvent(new Event("cancel",{bubbles:true}))})),false,e.element);return{}}#U(e,t){const r=[];for(const s of e.actions){switch(s.type){case"pointer":{s.parameters??={pointerType:"mouse"};s.parameters.pointerType??="mouse";const e=t.getOrCreate(s.id,"pointer",s.parameters.pointerType);if(e.subtype!==s.parameters.pointerType)throw new K.InvalidArgumentException(`Expected input source ${s.id} to be ${e.subtype}; got ${s.parameters.pointerType}.`);break}default:t.getOrCreate(s.id,s.type)}const e=s.actions.map((e=>({id:s.id,action:e})));for(let t=0;t<e.length;t++){r.length===t&&r.push([]);r[t].push(e[t])}}return r}}j.InputProcessor=InputProcessor;var $=i;try{"default"in i&&($=i.default)}catch(e){}var V={};Object.defineProperty(V,"__esModule",{value:true});V.URLPattern=void 0;const W=$;let G=W.URLPattern;V.URLPattern=G;"URLPattern"in globalThis&&(V.URLPattern=G=globalThis.URLPattern);var X={};Object.defineProperty(X,"__esModule",{value:true});X.NetworkProcessor=void 0;const Y=r;const J=V;class NetworkProcessor{#o;#j;constructor(e,t){this.#o=e;this.#j=t}async addIntercept(e){this.#o.verifyTopLevelContextsList(e.contexts);const t=e.urlPatterns??[];const r=NetworkProcessor.parseUrlPatterns(t);const s=this.#j.addIntercept({urlPatterns:r,phases:e.phases,contexts:e.contexts});await Promise.all(this.#o.getAllContexts().map((e=>e.cdpTarget.toggleNetwork())));return{intercept:s}}async continueRequest(e){e.url!==void 0&&NetworkProcessor.parseUrlString(e.url);if(e.method!==void 0&&!NetworkProcessor.isMethodValid(e.method))throw new Y.InvalidArgumentException(`Method '${e.method}' is invalid.`);e.headers&&NetworkProcessor.validateHeaders(e.headers);const t=this.#K(e.request,["beforeRequestSent"]);try{await t.continueRequest(e)}catch(e){throw NetworkProcessor.wrapInterceptionError(e)}return{}}async continueResponse(e){e.headers&&NetworkProcessor.validateHeaders(e.headers);const t=this.#K(e.request,["authRequired","responseStarted"]);try{await t.continueResponse(e)}catch(e){throw NetworkProcessor.wrapInterceptionError(e)}return{}}async continueWithAuth(e){const t=e.request;const r=this.#K(t,["authRequired"]);await r.continueWithAuth(e);return{}}async failRequest({request:e}){const t=this.#H(e);if(t.interceptPhase==="authRequired")throw new Y.InvalidArgumentException(`Request '${e}' in 'authRequired' phase cannot be failed`);if(!t.interceptPhase)throw new Y.NoSuchRequestException(`No blocked request found for network id '${e}'`);await t.failRequest("Failed");return{}}async provideResponse(e){e.headers&&NetworkProcessor.validateHeaders(e.headers);const t=this.#K(e.request,["beforeRequestSent","responseStarted","authRequired"]);try{await t.provideResponse(e)}catch(e){throw NetworkProcessor.wrapInterceptionError(e)}return{}}async removeIntercept(e){this.#j.removeIntercept(e.intercept);await Promise.all(this.#o.getAllContexts().map((e=>e.cdpTarget.toggleNetwork())));return{}}async setCacheBehavior(e){const t=this.#o.verifyTopLevelContextsList(e.contexts);if(t.size===0){this.#j.defaultCacheBehavior=e.cacheBehavior;await Promise.all(this.#o.getAllContexts().map((e=>e.cdpTarget.toggleSetCacheDisabled())));return{}}const r=e.cacheBehavior==="bypass";await Promise.all([...t.values()].map((e=>e.cdpTarget.toggleSetCacheDisabled(r))));return{}}#H(e){const t=this.#j.getRequestById(e);if(!t)throw new Y.NoSuchRequestException(`Network request with ID '${e}' doesn't exist`);return t}#K(e,t){const r=this.#H(e);if(!r.interceptPhase)throw new Y.NoSuchRequestException(`No blocked request found for network id '${e}'`);if(r.interceptPhase&&!t.includes(r.interceptPhase))throw new Y.InvalidArgumentException(`Blocked request for network id '${e}' is in '${r.interceptPhase}' phase`);return r}static validateHeaders(e){for(const t of e){let e;e=t.value.type==="string"?t.value.value:atob(t.value.value);if(e!==e.trim()||e.includes("\n")||e.includes("\0"))throw new Y.InvalidArgumentException(`Header value '${e}' is not acceptable value`)}}static isMethodValid(e){return/^[!#$%&'*+\-.^_`|~a-zA-Z\d]+$/.test(e)}static parseUrlString(e){try{return new URL(e)}catch(t){throw new Y.InvalidArgumentException(`Invalid URL '${e}': ${t}`)}}static parseUrlPatterns(e){return e.map((e=>{switch(e.type){case"string":NetworkProcessor.parseUrlString(e.pattern);return e;case"pattern":if(e.protocol===void 0&&e.hostname===void 0&&e.port===void 0&&e.pathname===void 0&&e.search===void 0)return e;if(e.protocol){e.protocol=unescapeURLPattern(e.protocol);if(!e.protocol.match(/^[a-zA-Z+-.]+$/))throw new Y.InvalidArgumentException("Forbidden characters")}e.hostname&&(e.hostname=unescapeURLPattern(e.hostname));e.port&&(e.port=unescapeURLPattern(e.port));if(e.pathname){e.pathname=unescapeURLPattern(e.pathname);e.pathname[0]!=="/"&&(e.pathname=`/${e.pathname}`);if(e.pathname.includes("#")||e.pathname.includes("?"))throw new Y.InvalidArgumentException("Forbidden characters")}else e.pathname===""&&(e.pathname="/");if(e.search){e.search=unescapeURLPattern(e.search);e.search[0]!=="?"&&(e.search=`?${e.search}`);if(e.search.includes("#"))throw new Y.InvalidArgumentException("Forbidden characters")}if(e.protocol==="")throw new Y.InvalidArgumentException("URL pattern must specify a protocol");if(e.hostname==="")throw new Y.InvalidArgumentException("URL pattern must specify a hostname");if((e.hostname?.length??0)>0){if(e.protocol?.match(/^file/i))throw new Y.InvalidArgumentException("URL pattern protocol cannot be 'file'");if(e.hostname?.includes(":"))throw new Y.InvalidArgumentException("URL pattern hostname must not contain a colon")}if(e.port==="")throw new Y.InvalidArgumentException("URL pattern must specify a port");try{new J.URLPattern(e)}catch(e){throw new Y.InvalidArgumentException(`${e}`)}return e}}))}static wrapInterceptionError(e){return e?.message.includes("Invalid header")?new Y.InvalidArgumentException("Invalid header"):e}}X.NetworkProcessor=NetworkProcessor;function unescapeURLPattern(e){const t=new Set(["(",")","*","{","}"]);let r="";let s=false;for(const n of e){if(!s){if(t.has(n))throw new Y.InvalidArgumentException("Forbidden characters");if(n==="\\"){s=true;continue}}r+=n;s=false}return r}var Q={};Object.defineProperty(Q,"__esModule",{value:true});Q.PermissionsProcessor=void 0;const Z=r;class PermissionsProcessor{#i;constructor(e){this.#i=e}async setPermissions(e){try{const t=e["goog:userContext"]||e.userContext;await this.#i.sendCommand("Browser.setPermission",{origin:e.origin,browserContextId:t&&t!=="default"?t:void 0,permission:{name:e.descriptor.name},setting:e.state})}catch(e){if(e.message==="Permission can't be granted to opaque origins.")return{};throw new Z.InvalidArgumentException(e.message)}return{}}}Q.PermissionsProcessor=PermissionsProcessor;var ee=o;try{"default"in o&&(ee=o.default)}catch(e){}var te={};Object.defineProperty(te,"__esModule",{value:true});te.uuidv4=uuidv4;function bytesToHex(e){return e.reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),"")}function uuidv4(){if("crypto"in globalThis&&"randomUUID"in globalThis.crypto)return globalThis.crypto.randomUUID();const e=new Uint8Array(16);"crypto"in globalThis&&"getRandomValues"in globalThis.crypto?globalThis.crypto.getRandomValues(e):ee.webcrypto.getRandomValues(e);e[6]=e[6]&15|64;e[8]=e[8]&63|128;return[bytesToHex(e.subarray(0,4)),bytesToHex(e.subarray(4,6)),bytesToHex(e.subarray(6,8)),bytesToHex(e.subarray(8,10)),bytesToHex(e.subarray(10,16))].join("-")}var re={};Object.defineProperty(re,"__esModule",{value:true});re.ChannelProxy=void 0;const se=r;const ne=e;const ie=te;class ChannelProxy{#_;#z=(0,ie.uuidv4)();#e;constructor(e,t){this.#_=e;this.#e=t}async init(e,t){const r=await ChannelProxy.#$(e);const s=await ChannelProxy.#V(e,r);void this.#W(e,r,t);return s}async startListenerFromWindow(e,t){try{const r=await this.#G(e);void this.#W(e,r,t)}catch(e){this.#e?.(ne.LogType.debugError,e)}}static#X(){const e=String((()=>{const e=[];let t=null;return{async getMessage(){const r=e.length>0?Promise.resolve():new Promise((e=>{t=e}));await r;return e.shift()},sendMessage(r){e.push(r);if(t!==null){t();t=null}}}}));return`(${e})()`}static async#$(e){const t=await e.cdpClient.sendCommand("Runtime.evaluate",{expression:this.#X(),contextId:e.executionContextId,serializationOptions:{serialization:"idOnly"}});if(t.exceptionDetails||t.result.objectId===void 0)throw new Error("Cannot create channel");return t.result.objectId}static async#V(e,t){const r=await e.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String((e=>e.sendMessage)),arguments:[{objectId:t}],executionContextId:e.executionContextId,serializationOptions:{serialization:"idOnly"}});return r.result.objectId}async#W(e,t,r){for(;;)try{const s=await e.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String((async e=>await e.getMessage())),arguments:[{objectId:t}],awaitPromise:true,executionContextId:e.executionContextId,serializationOptions:{serialization:"deep",maxDepth:this.#_.serializationOptions?.maxObjectDepth??void 0}});if(s.exceptionDetails)throw new Error("Runtime.callFunctionOn in ChannelProxy",{cause:s.exceptionDetails});for(const t of e.associatedBrowsingContexts)r.registerEvent({type:"event",method:se.ChromiumBidi.Script.EventNames.Message,params:{channel:this.#_.channel,data:e.cdpToBidiValue(s,this.#_.ownership??"none"),source:e.source}},t.id)}catch(e){this.#e?.(ne.LogType.debugError,e);break}}async#G(e){const t=await e.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String((e=>{const t=window;if(t[e]===void 0)return new Promise((r=>t[e]=r));const r=t[e];delete t[e];return r})),arguments:[{value:this.#z}],executionContextId:e.executionContextId,awaitPromise:true,serializationOptions:{serialization:"idOnly"}});if(t.exceptionDetails!==void 0||t.result.objectId===void 0)throw new Error(`ChannelHandle not found in window["${this.#z}"]`);return t.result.objectId}getEvalInWindowStr(){const e=String(((e,t)=>{const r=window;if(r[e]===void 0)r[e]=t;else{r[e](t);delete r[e]}return t.sendMessage}));const t=ChannelProxy.#X();return`(${e})('${this.#z}',${t})`}}re.ChannelProxy=ChannelProxy;var oe={};Object.defineProperty(oe,"__esModule",{value:true});oe.PreloadScript=void 0;const ae=te;const ce=re;class PreloadScript{#z=(0,ae.uuidv4)();#Y=[];#J;#Q=new Set;#Z;#ee;#te;get id(){return this.#z}get targetIds(){return this.#Q}constructor(e,t){this.#Z=e.arguments?.map((e=>new ce.ChannelProxy(e.value,t)))??[];this.#J=e.functionDeclaration;this.#ee=e.sandbox;this.#te=e.contexts}get channels(){return this.#Z}get contexts(){return this.#te}#re(){const e=`[${this.channels.map((e=>e.getEvalInWindowStr())).join(", ")}]`;return`(()=>{(${this.#J})(...${e})})()`}async initInTargets(e,t){await Promise.all(Array.from(e).map((e=>this.initInTarget(e,t))))}async initInTarget(e,t){const r=await e.cdpClient.sendCommand("Page.addScriptToEvaluateOnNewDocument",{source:this.#re(),worldName:this.#ee,runImmediately:t});this.#Y.push({target:e,preloadScriptId:r.identifier});this.#Q.add(e.id)}async remove(){await Promise.all([this.#Y.map((async e=>{const t=e.target;const r=e.preloadScriptId;return await t.cdpClient.sendCommand("Page.removeScriptToEvaluateOnNewDocument",{identifier:r})}))])}dispose(e){this.#Y=this.#Y.filter((t=>t.target?.id!==e));this.#Q.delete(e)}}oe.PreloadScript=PreloadScript;var de={};Object.defineProperty(de,"__esModule",{value:true});de.ScriptProcessor=void 0;const ue=r;const le=oe;class ScriptProcessor{#d;#o;#a;#se;#e;constructor(e,t,r,s,n){this.#o=t;this.#a=r;this.#se=s;this.#e=n;this.#d=e;this.#d.addSubscribeHook(ue.ChromiumBidi.Script.EventNames.RealmCreated,this.#ne.bind(this))}#ne(e){const t=this.#o.getContext(e);const r=[t,...this.#o.getContext(e).allChildren];const s=new Set;for(const e of r){const t=this.#a.findRealms({browsingContextId:e.id});for(const e of t)s.add(e)}for(const e of s)this.#d.registerEvent({type:"event",method:ue.ChromiumBidi.Script.EventNames.RealmCreated,params:e.realmInfo},t.id);return Promise.resolve()}async addPreloadScript(e){const t=this.#o.verifyTopLevelContextsList(e.contexts);const r=new le.PreloadScript(e,this.#e);this.#se.add(r);const s=t.size===0?new Set(this.#o.getTopLevelContexts().map((e=>e.cdpTarget))):new Set([...t.values()].map((e=>e.cdpTarget)));await r.initInTargets(s,false);return{script:r.id}}async removePreloadScript(e){const{script:t}=e;const r=this.#se.find({id:t});if(r.length===0)throw new ue.NoSuchScriptException(`No preload script with id '${t}'`);await Promise.all(r.map((e=>e.remove())));this.#se.remove({id:t});return{}}async callFunction(e){const t=await this.#ie(e.target);return await t.callFunction(e.functionDeclaration,e.awaitPromise,e.this,e.arguments,e.resultOwnership,e.serializationOptions,e.userActivation)}async evaluate(e){const t=await this.#ie(e.target);return await t.evaluate(e.expression,e.awaitPromise,e.resultOwnership,e.serializationOptions,e.userActivation)}async disown(e){const t=await this.#ie(e.target);await Promise.all(e.handles.map((async e=>await t.disown(e))));return{}}getRealms(e){e.context!==void 0&&this.#o.getContext(e.context);const t=this.#a.findRealms({browsingContextId:e.context,type:e.type}).map((e=>e.realmInfo));return{realms:t}}async#ie(e){if("context"in e){const t=this.#o.getContext(e.context);return await t.getOrCreateSandbox(e.sandbox)}return this.#a.getRealm({realmId:e.realm})}}de.ScriptProcessor=ScriptProcessor;var he={};Object.defineProperty(he,"__esModule",{value:true});he.SessionProcessor=void 0;const pe=r;class SessionProcessor{#d;#i;#oe;#ae=false;constructor(e,t,r){this.#d=e;this.#i=t;this.#oe=r}status(){return{ready:false,message:"already connected"}}#ce(e){const t=[];for(const r of e.firstMatch??[{}]){const s={...e.alwaysMatch};for(const e of Object.keys(r)){if(s[e]!==void 0)throw new pe.InvalidArgumentException(`Capability ${e} in firstMatch is already defined in alwaysMatch`);s[e]=r[e]}t.push(s)}const r=t.find((e=>e.browserName==="chrome"))??t[0]??{};r.unhandledPromptBehavior=this.#de(r.unhandledPromptBehavior);return r}#de(e){if(e!==void 0){if(typeof e==="object")return e;if(typeof e!=="string")throw new pe.InvalidArgumentException("Unexpected 'unhandledPromptBehavior' type: "+typeof e);switch(e){case"accept":case"accept and notify":return{default:"accept"};case"dismiss":case"dismiss and notify":return{default:"dismiss"};case"ignore":return{default:"ignore"};default:throw new pe.InvalidArgumentException(`Unexpected 'unhandledPromptBehavior' value: ${e}`)}}}async new(e){if(this.#ae)throw new Error("Session has been already created.");this.#ae=true;const t=this.#ce(e.capabilities);await this.#oe(t);const r=await this.#i.sendCommand("Browser.getVersion");return{sessionId:"unknown",capabilities:{...t,acceptInsecureCerts:t.acceptInsecureCerts??false,browserName:r.product,browserVersion:r.revision,platformName:"",setWindowRect:false,webSocketUrl:"",userAgent:r.userAgent}}}async subscribe(e,t=null){await this.#d.subscribe(e.events,e.contexts??[null],t);return{}}async unsubscribe(e,t=null){await this.#d.unsubscribe(e.events,e.contexts??[null],t);return{}}}he.SessionProcessor=SessionProcessor;var ge={};var me=a.Buffer;Object.defineProperty(ge,"__esModule",{value:true});ge.base64ToString=base64ToString;
/**
 * Encodes a string to base64.
 *
 * Uses the native Web API if available, otherwise falls back to a NodeJS Buffer.
 * @param {string} base64Str
 * @return {string}
 */function base64ToString(e){return"atob"in globalThis?globalThis.atob(e):me.from(e,"base64").toString("ascii")}var we={};Object.defineProperty(we,"__esModule",{value:true});we.computeHeadersSize=computeHeadersSize;we.bidiNetworkHeadersFromCdpNetworkHeaders=bidiNetworkHeadersFromCdpNetworkHeaders;we.bidiNetworkHeadersFromCdpNetworkHeadersEntries=bidiNetworkHeadersFromCdpNetworkHeadersEntries;we.cdpNetworkHeadersFromBidiNetworkHeaders=cdpNetworkHeadersFromBidiNetworkHeaders;we.bidiNetworkHeadersFromCdpFetchHeaders=bidiNetworkHeadersFromCdpFetchHeaders;we.cdpFetchHeadersFromBidiNetworkHeaders=cdpFetchHeadersFromBidiNetworkHeaders;we.networkHeaderFromCookieHeaders=networkHeaderFromCookieHeaders;we.cdpAuthChallengeResponseFromBidiAuthContinueWithAuthAction=cdpAuthChallengeResponseFromBidiAuthContinueWithAuthAction;we.cdpToBiDiCookie=cdpToBiDiCookie;we.deserializeByteValue=deserializeByteValue;we.bidiToCdpCookie=bidiToCdpCookie;we.sameSiteBiDiToCdp=sameSiteBiDiToCdp;we.isSpecialScheme=isSpecialScheme;we.matchUrlPattern=matchUrlPattern;we.bidiBodySizeFromCdpPostDataEntries=bidiBodySizeFromCdpPostDataEntries;we.getTiming=getTiming;const fe=s;const ve=ge;const Ce=V;function computeHeadersSize(e){const t=e.reduce(((e,t)=>`${e}${t.name}: ${t.value.value}\r\n`),"");return(new TextEncoder).encode(t).length}function bidiNetworkHeadersFromCdpNetworkHeaders(e){return e?Object.entries(e).map((([e,t])=>({name:e,value:{type:"string",value:t}}))):[]}function bidiNetworkHeadersFromCdpNetworkHeadersEntries(e){return e?e.map((({name:e,value:t})=>({name:e,value:{type:"string",value:t}}))):[]}function cdpNetworkHeadersFromBidiNetworkHeaders(e){if(e!==void 0)return e.reduce(((e,t)=>{e[t.name]=t.value.value;return e}),{})}function bidiNetworkHeadersFromCdpFetchHeaders(e){return e?e.map((({name:e,value:t})=>({name:e,value:{type:"string",value:t}}))):[]}function cdpFetchHeadersFromBidiNetworkHeaders(e){if(e!==void 0)return e.map((({name:e,value:t})=>({name:e,value:t.value})))}function networkHeaderFromCookieHeaders(e){if(e===void 0)return;const t=e.reduce(((e,t,r)=>{r>0&&(e+=";");const s=t.value.type==="base64"?btoa(t.value.value):t.value.value;e+=`${t.name}=${s}`;return e}),"");return{name:"Cookie",value:{type:"string",value:t}}}function cdpAuthChallengeResponseFromBidiAuthContinueWithAuthAction(e){switch(e){case"default":return"Default";case"cancel":return"CancelAuth";case"provideCredentials":return"ProvideCredentials"}}function cdpToBiDiCookie(e){const t={name:e.name,value:{type:"string",value:e.value},domain:e.domain,path:e.path,size:e.size,httpOnly:e.httpOnly,secure:e.secure,sameSite:e.sameSite===void 0?"none":sameSiteCdpToBiDi(e.sameSite),...e.expires>=0?{expiry:e.expires}:void 0};t["goog:session"]=e.session;t["goog:priority"]=e.priority;t["goog:sameParty"]=e.sameParty;t["goog:sourceScheme"]=e.sourceScheme;t["goog:sourcePort"]=e.sourcePort;e.partitionKey!==void 0&&(t["goog:partitionKey"]=e.partitionKey);e.partitionKeyOpaque!==void 0&&(t["goog:partitionKeyOpaque"]=e.partitionKeyOpaque);return t}
/**
 * Decodes a byte value to a string.
 * @param {Network.BytesValue} value
 * @return {string}
 */function deserializeByteValue(e){return e.type==="base64"?(0,ve.base64ToString)(e.value):e.value}function bidiToCdpCookie(e,t){const r=deserializeByteValue(e.cookie.value);const s={name:e.cookie.name,value:r,domain:e.cookie.domain,path:e.cookie.path??"/",secure:e.cookie.secure??false,httpOnly:e.cookie.httpOnly??false,...t.sourceOrigin!==void 0&&{partitionKey:{hasCrossSiteAncestor:false,topLevelSite:t.sourceOrigin}},...e.cookie.expiry!==void 0&&{expires:e.cookie.expiry},...e.cookie.sameSite!==void 0&&{sameSite:sameSiteBiDiToCdp(e.cookie.sameSite)}};e.cookie["goog:url"]!==void 0&&(s.url=e.cookie["goog:url"]);e.cookie["goog:priority"]!==void 0&&(s.priority=e.cookie["goog:priority"]);e.cookie["goog:sameParty"]!==void 0&&(s.sameParty=e.cookie["goog:sameParty"]);e.cookie["goog:sourceScheme"]!==void 0&&(s.sourceScheme=e.cookie["goog:sourceScheme"]);e.cookie["goog:sourcePort"]!==void 0&&(s.sourcePort=e.cookie["goog:sourcePort"]);return s}function sameSiteCdpToBiDi(e){switch(e){case"Strict":return"strict";case"None":return"none";case"Lax":return"lax";default:return"lax"}}function sameSiteBiDiToCdp(e){switch(e){case"strict":return"Strict";case"lax":return"Lax";case"none":return"None"}throw new fe.InvalidArgumentException(`Unknown 'sameSite' value ${e}`)}function isSpecialScheme(e){return["ftp","file","http","https","ws","wss"].includes(e.replace(/:$/,""))}function matchUrlPattern(e,t){switch(e.type){case"string":{const r=new Ce.URLPattern(e.pattern);return new Ce.URLPattern({protocol:r.protocol,hostname:r.hostname,port:r.port,pathname:r.pathname,search:r.search}).test(t)}case"pattern":return new Ce.URLPattern(e).test(t)}}function bidiBodySizeFromCdpPostDataEntries(e){let t=0;for(const r of e)t+=atob(r.bytes??"").length;return t}function getTiming(e){return e?e<0?0:e:0}var be={};Object.defineProperty(be,"__esModule",{value:true});be.StorageProcessor=void 0;const xe=r;const ye=v;const Se=e;const Pe=X;const Ie=we;class StorageProcessor{#i;#o;#e;constructor(e,t,r){this.#o=t;this.#i=e;this.#e=r}async deleteCookies(e){const t=this.#ue(e.partition);let r;try{r=await this.#i.sendCommand("Storage.getCookies",{browserContextId:this.#le(t)})}catch(e){if(this.#he(e))throw new xe.NoSuchUserContextException(e.message);throw e}const s=r.cookies.filter((e=>t.sourceOrigin===void 0||e.partitionKey?.topLevelSite===t.sourceOrigin)).filter((t=>{const r=(0,Ie.cdpToBiDiCookie)(t);return this.#pe(r,e.filter)})).map((e=>({...e,expires:1})));await this.#i.sendCommand("Storage.setCookies",{cookies:s,browserContextId:this.#le(t)});return{partitionKey:t}}async getCookies(e){const t=this.#ue(e.partition);let r;try{r=await this.#i.sendCommand("Storage.getCookies",{browserContextId:this.#le(t)})}catch(e){if(this.#he(e))throw new xe.NoSuchUserContextException(e.message);throw e}const s=r.cookies.filter((e=>t.sourceOrigin===void 0||e.partitionKey?.topLevelSite===t.sourceOrigin)).map((e=>(0,Ie.cdpToBiDiCookie)(e))).filter((t=>this.#pe(t,e.filter)));return{cookies:s,partitionKey:t}}async setCookie(e){const t=this.#ue(e.partition);const r=(0,Ie.bidiToCdpCookie)(e,t);try{await this.#i.sendCommand("Storage.setCookies",{cookies:[r],browserContextId:this.#le(t)})}catch(e){if(this.#he(e))throw new xe.NoSuchUserContextException(e.message);this.#e?.(Se.LogType.debugError,e);throw new xe.UnableToSetCookieException(e.toString())}return{partitionKey:t}}#he(e){return e.message?.startsWith("Failed to find browser context for id")}#le(e){return e.userContext==="default"?void 0:e.userContext}#ge(e){const t=e.context;const r=this.#o.getContext(t);return{userContext:r.userContext}}#me(e){const t=new Map;let r=e.sourceOrigin;if(r!==void 0){const e=Pe.NetworkProcessor.parseUrlString(r);r=e.origin==="null"?e.origin:`${e.protocol}//${e.hostname}`}for(const[r,s]of Object.entries(e))r===void 0||s===void 0||["type","sourceOrigin","userContext"].includes(r)||t.set(r,s);t.size>0&&this.#e?.(Se.LogType.debugInfo,`Unsupported partition keys: ${JSON.stringify(Object.fromEntries(t))}`);const s=e.userContext??"default";return{userContext:s,...r===void 0?{}:{sourceOrigin:r}}}#ue(e){if(e===void 0)return{userContext:"default"};if(e.type==="context")return this.#ge(e);(0,ye.assert)(e.type==="storageKey","Unknown partition type");return this.#me(e)}#pe(e,t){return t===void 0||(t.domain===void 0||t.domain===e.domain)&&(t.name===void 0||t.name===e.name)&&(t.value===void 0||(0,Ie.deserializeByteValue)(t.value)===(0,Ie.deserializeByteValue)(e.value))&&(t.path===void 0||t.path===e.path)&&(t.size===void 0||t.size===e.size)&&(t.httpOnly===void 0||t.httpOnly===e.httpOnly)&&(t.secure===void 0||t.secure===e.secure)&&(t.sameSite===void 0||t.sameSite===e.sameSite)&&(t.expiry===void 0||t.expiry===e.expiry)}}be.StorageProcessor=StorageProcessor;var Ee={};Object.defineProperty(Ee,"__esModule",{value:true});Ee.OutgoingMessage=void 0;let ke=class OutgoingMessage{#we;#fe;constructor(e,t=null){this.#we=e;this.#fe=t}static createFromPromise(e,t){return e.then((e=>e.kind==="success"?{kind:"success",value:new OutgoingMessage(e.value,t)}:e))}static createResolved(e,t){return Promise.resolve({kind:"success",value:new OutgoingMessage(e,t)})}get message(){return this.#we}get channel(){return this.#fe}};Ee.OutgoingMessage=ke;var Te={};Object.defineProperty(Te,"__esModule",{value:true});Te.CommandProcessor=void 0;const Me=r;const Ne=t;const Re=e;const Be=l;const De=h;const Fe=g;const Oe=w;const Ae=j;const qe=X;const Le=Q;const Ue=de;const je=he;const Ke=be;const He=Ee;class CommandProcessor extends Ne.EventEmitter{#ve;#Ce;#be;#xe;#ye;#Se;#Pe;#Ie;#Ee;#ke;#Te;#e;constructor(e,t,r,s,n,i,o,a,c=new Be.BidiNoOpParser,d,u){super();this.#Te=c;this.#e=u;this.#ve=a;this.#Ce=new De.BrowserProcessor(t);this.#be=new Oe.BrowsingContextProcessor(t,s,r);this.#xe=new Fe.CdpProcessor(s,n,e,t);this.#ye=new Ae.InputProcessor(s);this.#Se=new qe.NetworkProcessor(s,o);this.#Pe=new Le.PermissionsProcessor(t);this.#Ie=new Ue.ScriptProcessor(r,s,n,i,u);this.#Ee=new je.SessionProcessor(r,t,d);this.#ke=new Ke.StorageProcessor(t,s,u)}async#Me(e){switch(e.method){case"session.end":break;case"bluetooth.handleRequestDevicePrompt":return await this.#ve.handleRequestDevicePrompt(this.#Te.parseHandleRequestDevicePromptParams(e.params));case"bluetooth.simulateAdapter":return await this.#ve.simulateAdapter(this.#Te.parseSimulateAdapterParameters(e.params));case"bluetooth.simulateAdvertisement":return await this.#ve.simulateAdvertisement(this.#Te.parseSimulateAdvertisementParameters(e.params));case"bluetooth.simulatePreconnectedPeripheral":return await this.#ve.simulatePreconnectedPeripheral(this.#Te.parseSimulatePreconnectedPeripheralParameters(e.params));case"browser.close":return this.#Ce.close();case"browser.createUserContext":return await this.#Ce.createUserContext(e.params);case"browser.getClientWindows":throw new Me.UnknownErrorException(`Method ${e.method} is not implemented.`);case"browser.getUserContexts":return await this.#Ce.getUserContexts();case"browser.removeUserContext":return await this.#Ce.removeUserContext(this.#Te.parseRemoveUserContextParams(e.params));case"browser.setClientWindowState":throw new Me.UnknownErrorException(`Method ${e.method} is not implemented.`);case"browsingContext.activate":return await this.#be.activate(this.#Te.parseActivateParams(e.params));case"browsingContext.captureScreenshot":return await this.#be.captureScreenshot(this.#Te.parseCaptureScreenshotParams(e.params));case"browsingContext.close":return await this.#be.close(this.#Te.parseCloseParams(e.params));case"browsingContext.create":return await this.#be.create(this.#Te.parseCreateParams(e.params));case"browsingContext.getTree":return this.#be.getTree(this.#Te.parseGetTreeParams(e.params));case"browsingContext.handleUserPrompt":return await this.#be.handleUserPrompt(this.#Te.parseHandleUserPromptParams(e.params));case"browsingContext.locateNodes":return await this.#be.locateNodes(this.#Te.parseLocateNodesParams(e.params));case"browsingContext.navigate":return await this.#be.navigate(this.#Te.parseNavigateParams(e.params));case"browsingContext.print":return await this.#be.print(this.#Te.parsePrintParams(e.params));case"browsingContext.reload":return await this.#be.reload(this.#Te.parseReloadParams(e.params));case"browsingContext.setViewport":return await this.#be.setViewport(this.#Te.parseSetViewportParams(e.params));case"browsingContext.traverseHistory":return await this.#be.traverseHistory(this.#Te.parseTraverseHistoryParams(e.params));case"cdp.getSession":return this.#xe.getSession(this.#Te.parseGetSessionParams(e.params));case"cdp.resolveRealm":return this.#xe.resolveRealm(this.#Te.parseResolveRealmParams(e.params));case"cdp.sendCommand":return await this.#xe.sendCommand(this.#Te.parseSendCommandParams(e.params));case"input.performActions":return await this.#ye.performActions(this.#Te.parsePerformActionsParams(e.params));case"input.releaseActions":return await this.#ye.releaseActions(this.#Te.parseReleaseActionsParams(e.params));case"input.setFiles":return await this.#ye.setFiles(this.#Te.parseSetFilesParams(e.params));case"network.addIntercept":return await this.#Se.addIntercept(this.#Te.parseAddInterceptParams(e.params));case"network.continueRequest":return await this.#Se.continueRequest(this.#Te.parseContinueRequestParams(e.params));case"network.continueResponse":return await this.#Se.continueResponse(this.#Te.parseContinueResponseParams(e.params));case"network.continueWithAuth":return await this.#Se.continueWithAuth(this.#Te.parseContinueWithAuthParams(e.params));case"network.failRequest":return await this.#Se.failRequest(this.#Te.parseFailRequestParams(e.params));case"network.provideResponse":return await this.#Se.provideResponse(this.#Te.parseProvideResponseParams(e.params));case"network.removeIntercept":return await this.#Se.removeIntercept(this.#Te.parseRemoveInterceptParams(e.params));case"network.setCacheBehavior":return await this.#Se.setCacheBehavior(this.#Te.parseSetCacheBehavior(e.params));case"permissions.setPermission":return await this.#Pe.setPermissions(this.#Te.parseSetPermissionsParams(e.params));case"script.addPreloadScript":return await this.#Ie.addPreloadScript(this.#Te.parseAddPreloadScriptParams(e.params));case"script.callFunction":return await this.#Ie.callFunction(this.#Te.parseCallFunctionParams(this.#Ne(e.params)));case"script.disown":return await this.#Ie.disown(this.#Te.parseDisownParams(this.#Ne(e.params)));case"script.evaluate":return await this.#Ie.evaluate(this.#Te.parseEvaluateParams(this.#Ne(e.params)));case"script.getRealms":return this.#Ie.getRealms(this.#Te.parseGetRealmsParams(e.params));case"script.removePreloadScript":return await this.#Ie.removePreloadScript(this.#Te.parseRemovePreloadScriptParams(e.params));case"session.new":return await this.#Ee.new(e.params);case"session.status":return this.#Ee.status();case"session.subscribe":return await this.#Ee.subscribe(this.#Te.parseSubscribeParams(e.params),e.channel);case"session.unsubscribe":return await this.#Ee.unsubscribe(this.#Te.parseSubscribeParams(e.params),e.channel);case"storage.deleteCookies":return await this.#ke.deleteCookies(this.#Te.parseDeleteCookiesParams(e.params));case"storage.getCookies":return await this.#ke.getCookies(this.#Te.parseGetCookiesParams(e.params));case"storage.setCookie":return await this.#ke.setCookie(this.#Te.parseSetCookieParams(e.params))}throw new Me.UnknownCommandException(`Unknown command '${e.method}'.`)}#Ne(e){typeof e==="object"&&e&&"target"in e&&typeof e.target==="object"&&e.target&&"context"in e.target&&delete e.target.realm;return e}async processCommand(e){try{const t=await this.#Me(e);const r={type:"success",id:e.id,result:t};this.emit("response",{message:He.OutgoingMessage.createResolved(r,e.channel),event:e.method})}catch(t){if(t instanceof Me.Exception)this.emit("response",{message:He.OutgoingMessage.createResolved(t.toErrorResponse(e.id),e.channel),event:e.method});else{const r=t;this.#e?.(Re.LogType.bidi,r);this.emit("response",{message:He.OutgoingMessage.createResolved(new Me.UnknownErrorException(r.message,r.stack).toErrorResponse(e.id),e.channel),event:e.method})}}}}Te.CommandProcessor=CommandProcessor;var _e={};Object.defineProperty(_e,"__esModule",{value:true});_e.BluetoothProcessor=void 0;class BluetoothProcessor{#d;#o;constructor(e,t){this.#d=e;this.#o=t}async simulateAdapter(e){const t=this.#o.getContext(e.context);await t.cdpTarget.browserCdpClient.sendCommand("BluetoothEmulation.disable");await t.cdpTarget.browserCdpClient.sendCommand("BluetoothEmulation.enable",{state:e.state});return{}}async simulatePreconnectedPeripheral(e){const t=this.#o.getContext(e.context);await t.cdpTarget.browserCdpClient.sendCommand("BluetoothEmulation.simulatePreconnectedPeripheral",{address:e.address,name:e.name,knownServiceUuids:e.knownServiceUuids,manufacturerData:e.manufacturerData});return{}}async simulateAdvertisement(e){const t=this.#o.getContext(e.context);await t.cdpTarget.browserCdpClient.sendCommand("BluetoothEmulation.simulateAdvertisement",{entry:e.scanEntry});return{}}onCdpTargetCreated(e){e.cdpClient.on("DeviceAccess.deviceRequestPrompted",(t=>{this.#d.registerEvent({type:"event",method:"bluetooth.requestDevicePromptUpdated",params:{context:e.id,prompt:t.id,devices:t.devices}},e.id)}))}async handleRequestDevicePrompt(e){const t=this.#o.getContext(e.context);e.accept?await t.cdpTarget.cdpClient.sendCommand("DeviceAccess.selectPrompt",{id:e.prompt,deviceId:e.device}):await t.cdpTarget.cdpClient.sendCommand("DeviceAccess.cancelPrompt",{id:e.prompt});return{}}}_e.BluetoothProcessor=BluetoothProcessor;var ze={};Object.defineProperty(ze,"__esModule",{value:true});ze.Deferred=void 0;class Deferred{#Re=false;#Be;#De;#Fe;#Oe;get isFinished(){return this.#Re}get result(){if(!this.#Re)throw new Error("Deferred is not finished yet");return this.#De}constructor(){this.#Be=new Promise(((e,t)=>{this.#Fe=e;this.#Oe=t}));this.#Be.catch((e=>{}))}then(e,t){return this.#Be.then(e,t)}catch(e){return this.#Be.catch(e)}resolve(e){this.#De=e;if(!this.#Re){this.#Re=true;this.#Fe(e)}}reject(e){if(!this.#Re){this.#Re=true;this.#Oe(e)}}finally(e){return this.#Be.finally(e)}[Symbol.toStringTag]="Promise"}ze.Deferred=Deferred;var $e={};Object.defineProperty($e,"__esModule",{value:true});$e.inchesFromCm=inchesFromCm;function inchesFromCm(e){return e/2.54}var Ve={};Object.defineProperty(Ve,"__esModule",{value:true});Ve.Realm=void 0;const We=r;const Ge=e;const Xe=te;const Ye=re;class Realm{#Ae;#d;#qe;#e;#Le;#Ue;#a;constructor(e,t,r,s,n,i,o){this.#Ae=e;this.#d=t;this.#qe=r;this.#e=s;this.#Le=n;this.#Ue=i;this.#a=o;this.#a.addRealm(this)}cdpToBidiValue(e,t){const r=this.serializeForBiDi(e.result.deepSerializedValue,new Map);if(e.result.objectId){const s=e.result.objectId;if(t==="root"){r.handle=s;this.#a.knownHandlesToRealmMap.set(s,this.realmId)}else void this.#je(s).catch((e=>this.#e?.(Ge.LogType.debugError,e)))}return r}
/**
   * Relies on the CDP to implement proper BiDi serialization, except:
   * * CDP integer property `backendNodeId` is replaced with `sharedId` of
   * `{documentId}_element_{backendNodeId}`;
   * * CDP integer property `weakLocalObjectReference` is replaced with UUID `internalId`
   * using unique-per serialization `internalIdMap`.
   * * CDP type `platformobject` is replaced with `object`.
   * @param deepSerializedValue - CDP value to be converted to BiDi.
   * @param internalIdMap - Map from CDP integer `weakLocalObjectReference` to BiDi UUID
   * `internalId`.
   */serializeForBiDi(e,t){if(Object.hasOwn(e,"weakLocalObjectReference")){const r=e.weakLocalObjectReference;t.has(r)||t.set(r,(0,Xe.uuidv4)());e.internalId=t.get(r);delete e.weakLocalObjectReference}e.type==="node"&&Object.hasOwn(e?.value,"frameId")&&delete e.value.frameId;if(e.type==="platformobject")return{type:"object"};const r=e.value;if(r===void 0)return e;if(["array","set","htmlcollection","nodelist"].includes(e.type))for(const e in r)r[e]=this.serializeForBiDi(r[e],t);if(["object","map"].includes(e.type))for(const e in r)r[e]=[this.serializeForBiDi(r[e][0],t),this.serializeForBiDi(r[e][1],t)];return e}get realmId(){return this.#Ue}get executionContextId(){return this.#qe}get origin(){return this.#Le}get source(){return{realm:this.realmId}}get cdpClient(){return this.#Ae}get baseInfo(){return{realm:this.realmId,origin:this.origin}}async evaluate(e,t,r="none",s={},n=false,i=false){const o=await this.cdpClient.sendCommand("Runtime.evaluate",{contextId:this.executionContextId,expression:e,awaitPromise:t,serializationOptions:Realm.#Ke("deep",s),userGesture:n,includeCommandLineAPI:i});return o.exceptionDetails?await this.#He(o.exceptionDetails,0,r):{realm:this.realmId,result:this.cdpToBidiValue(o,r),type:"success"}}#_e(e){if(this.associatedBrowsingContexts.length===0)this.#d.registerEvent(e,null);else for(const t of this.associatedBrowsingContexts)this.#d.registerEvent(e,t.id)}initialize(){this.#_e({type:"event",method:We.ChromiumBidi.Script.EventNames.RealmCreated,params:this.realmInfo})}async serializeCdpObject(e,t){const r=Realm.#ze(e);const s=await this.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String((e=>e)),awaitPromise:false,arguments:[r],serializationOptions:{serialization:"deep"},executionContextId:this.executionContextId});return this.cdpToBidiValue(s,t)}static#ze(e){return e.objectId!==void 0?{objectId:e.objectId}:e.unserializableValue!==void 0?{unserializableValue:e.unserializableValue}:{value:e.value}}async stringifyObject(e){const{result:t}=await this.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String((e=>String(e))),awaitPromise:false,arguments:[e],returnByValue:true,executionContextId:this.executionContextId});return t.value}async#$e(e){const t=await Promise.all(e.map((async([e,t])=>{let r;r=typeof e==="string"?{value:e}:await this.deserializeForCdp(e);const s=await this.deserializeForCdp(t);return[r,s]})));return t.flat()}async#Ve(e){return await Promise.all(e.map((e=>this.deserializeForCdp(e))))}async#We(e,t,r){const s=e.stackTrace?.callFrames.map((e=>({url:e.url,functionName:e.functionName,lineNumber:e.lineNumber-t,columnNumber:e.columnNumber})))??[];const n=e.exception;return{exception:await this.serializeCdpObject(n,r),columnNumber:e.columnNumber,lineNumber:e.lineNumber-t,stackTrace:{callFrames:s},text:await this.stringifyObject(n)||e.text}}async callFunction(e,t,r={type:"undefined"},s=[],n="none",i={},o=false){const a=`(...args) => {\n      function callFunction(f, args) {\n        const deserializedThis = args.shift();\n        const deserializedArgs = args;\n        return f.apply(deserializedThis, deserializedArgs);\n      }\n      return callFunction((\n        ${e}\n      ), args);\n    }`;const c=[await this.deserializeForCdp(r),...await Promise.all(s.map((async e=>await this.deserializeForCdp(e))))];let d;try{d=await this.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:a,awaitPromise:t,arguments:c,serializationOptions:Realm.#Ke("deep",i),executionContextId:this.executionContextId,userGesture:o})}catch(e){if(e.code===-32e3&&["Could not find object with given id","Argument should belong to the same JavaScript world as target object","Invalid remote object id"].includes(e.message))throw new We.NoSuchHandleException("Handle was not found.");throw e}return d.exceptionDetails?await this.#He(d.exceptionDetails,1,n):{type:"success",result:this.cdpToBidiValue(d,n),realm:this.realmId}}async deserializeForCdp(e){if("handle"in e&&e.handle)return{objectId:e.handle};if("handle"in e||"sharedId"in e)throw new We.NoSuchHandleException("Handle was not found.");switch(e.type){case"undefined":return{unserializableValue:"undefined"};case"null":return{unserializableValue:"null"};case"string":return{value:e.value};case"number":return e.value==="NaN"?{unserializableValue:"NaN"}:e.value==="-0"?{unserializableValue:"-0"}:e.value==="Infinity"?{unserializableValue:"Infinity"}:e.value==="-Infinity"?{unserializableValue:"-Infinity"}:{value:e.value};case"boolean":return{value:Boolean(e.value)};case"bigint":return{unserializableValue:`BigInt(${JSON.stringify(e.value)})`};case"date":return{unserializableValue:`new Date(Date.parse(${JSON.stringify(e.value)}))`};case"regexp":return{unserializableValue:`new RegExp(${JSON.stringify(e.value.pattern)}, ${JSON.stringify(e.value.flags)})`};case"map":{const t=await this.#$e(e.value);const{result:r}=await this.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String(((...e)=>{const t=new Map;for(let r=0;r<e.length;r+=2)t.set(e[r],e[r+1]);return t})),awaitPromise:false,arguments:t,returnByValue:false,executionContextId:this.executionContextId});return{objectId:r.objectId}}case"object":{const t=await this.#$e(e.value);const{result:r}=await this.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String(((...e)=>{const t={};for(let r=0;r<e.length;r+=2){const s=e[r];t[s]=e[r+1]}return t})),awaitPromise:false,arguments:t,returnByValue:false,executionContextId:this.executionContextId});return{objectId:r.objectId}}case"array":{const t=await this.#Ve(e.value);const{result:r}=await this.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String(((...e)=>e)),awaitPromise:false,arguments:t,returnByValue:false,executionContextId:this.executionContextId});return{objectId:r.objectId}}case"set":{const t=await this.#Ve(e.value);const{result:r}=await this.cdpClient.sendCommand("Runtime.callFunctionOn",{functionDeclaration:String(((...e)=>new Set(e))),awaitPromise:false,arguments:t,returnByValue:false,executionContextId:this.executionContextId});return{objectId:r.objectId}}case"channel":{const t=new Ye.ChannelProxy(e.value,this.#e);const r=await t.init(this,this.#d);return{objectId:r}}}throw new Error(`Value ${JSON.stringify(e)} is not deserializable.`)}async#He(e,t,r){return{exceptionDetails:await this.#We(e,t,r),realm:this.realmId,type:"exception"}}static#Ke(e,t){return{serialization:e,additionalParameters:Realm.#Ge(t),...Realm.#Xe(t)}}static#Ge(e){const t={};e.maxDomDepth!==void 0&&(t.maxNodeDepth=e.maxDomDepth===null?1e3:e.maxDomDepth);e.includeShadowTree!==void 0&&(t.includeShadowTree=e.includeShadowTree);return t}static#Xe(e){return e.maxObjectDepth===void 0||e.maxObjectDepth===null?{}:{maxDepth:e.maxObjectDepth}}async#je(e){try{await this.cdpClient.sendCommand("Runtime.releaseObject",{objectId:e})}catch(e){if(!(e.code===-32e3&&e.message==="Invalid remote object id"))throw e}}async disown(e){if(this.#a.knownHandlesToRealmMap.get(e)===this.realmId){await this.#je(e);this.#a.knownHandlesToRealmMap.delete(e)}}dispose(){this.#_e({type:"event",method:We.ChromiumBidi.Script.EventNames.RealmDestroyed,params:{realm:this.realmId}})}}Ve.Realm=Realm;var Je={};Object.defineProperty(Je,"__esModule",{value:true});Je.getSharedId=getSharedId;Je.parseSharedId=parseSharedId;const Qe="_element_";function getSharedId(e,t,r){return`f.${e}.d.${t}.e.${r}`}function parseLegacySharedId(e){const t=e.match(new RegExp(`(.*)${Qe}(.*)`));if(!t)return null;const r=t[1];const s=t[2];if(r===void 0||s===void 0)return null;const n=parseInt(s??"");return isNaN(n)?null:{documentId:r,backendNodeId:n}}function parseSharedId(e){const t=parseLegacySharedId(e);if(t!==null)return{...t,frameId:void 0};const r=e.match(/f\.(.*)\.d\.(.*)\.e\.([0-9]*)/);if(!r)return null;const s=r[1];const n=r[2];const i=r[3];if(s===void 0||n===void 0||i===void 0)return null;const o=parseInt(i??"");return isNaN(o)?null:{frameId:s,documentId:n,backendNodeId:o}}var Ze={};Object.defineProperty(Ze,"__esModule",{value:true});Ze.WindowRealm=void 0;const et=r;const tt=Ve;const rt=Je;class WindowRealm extends tt.Realm{#Ye;#o;sandbox;constructor(e,t,r,s,n,i,o,a,c,d){super(r,s,n,i,o,a,c);this.#Ye=e;this.#o=t;this.sandbox=d;this.initialize()}#Je(e){const t=this.#o.getAllContexts().find((t=>t.navigableId===e));return t?.id??"UNKNOWN"}get browsingContext(){return this.#o.getContext(this.#Ye)}get associatedBrowsingContexts(){return[this.browsingContext]}get realmType(){return"window"}get realmInfo(){return{...this.baseInfo,type:this.realmType,context:this.#Ye,sandbox:this.sandbox}}get source(){return{realm:this.realmId,context:this.browsingContext.id}}serializeForBiDi(e,t){const r=e.value;if(e.type==="node"&&r!==void 0){if(Object.hasOwn(r,"backendNodeId")){let t=this.browsingContext.navigableId??"UNKNOWN";if(Object.hasOwn(r,"loaderId")){t=r.loaderId;delete r.loaderId}e.sharedId=(0,rt.getSharedId)(this.#Je(t),t,r.backendNodeId);delete r.backendNodeId}if(Object.hasOwn(r,"children"))for(const e in r.children)r.children[e]=this.serializeForBiDi(r.children[e],t);Object.hasOwn(r,"shadowRoot")&&r.shadowRoot!==null&&(r.shadowRoot=this.serializeForBiDi(r.shadowRoot,t));r.namespaceURI===""&&(r.namespaceURI=null)}return super.serializeForBiDi(e,t)}async deserializeForCdp(e){if("sharedId"in e&&e.sharedId){const t=(0,rt.parseSharedId)(e.sharedId);if(t===null)throw new et.NoSuchNodeException(`SharedId "${e.sharedId}" was not found.`);const{documentId:r,backendNodeId:s}=t;if(this.browsingContext.navigableId!==r)throw new et.NoSuchNodeException(`SharedId "${e.sharedId}" belongs to different document. Current document is ${this.browsingContext.navigableId}.`);try{const{object:e}=await this.cdpClient.sendCommand("DOM.resolveNode",{backendNodeId:s,executionContextId:this.executionContextId});return{objectId:e.objectId}}catch(t){if(t.code===-32e3&&t.message==="No node with given id found")throw new et.NoSuchNodeException(`SharedId "${e.sharedId}" was not found.`);throw new et.UnknownErrorException(t.message,t.stack)}}return await super.deserializeForCdp(e)}async evaluate(e,t,r,s,n,i){await this.#o.getContext(this.#Ye).targetUnblockedOrThrow();return await super.evaluate(e,t,r,s,n,i)}async callFunction(e,t,r,s,n,i,o){await this.#o.getContext(this.#Ye).targetUnblockedOrThrow();return await super.callFunction(e,t,r,s,n,i,o)}}Ze.WindowRealm=WindowRealm;var st={};var nt;Object.defineProperty(st,"__esModule",{value:true});st.BrowsingContextImpl=void 0;st.serializeOrigin=serializeOrigin;const it=r;const ot=v;const at=ze;const ct=e;const dt=$e;const ut=te;const lt=Ze;class BrowsingContextImpl{static LOGGER_PREFIX=`${ct.LogType.debug}:browsingContext`;#z;userContext;#Qe=null;#Ze=new Set;#o;#et={DOMContentLoaded:new at.Deferred,load:new at.Deferred};#tt={withinDocument:new at.Deferred};#rt;#d;#a;#st;#nt;#it=new at.Deferred;#e;#ot={width:0,height:0};#at;#ct=(0,ut.uuidv4)();#dt;#ut;#lt;#ht;#pt;constructor(e,t,r,s,n,i,o,a,c,d,u){this.#nt=s;this.#z=e;this.#Qe=t;this.userContext=r;this.#d=n;this.#o=i;this.#a=o;this.#pt=d;this.#e=u;this.#rt=a;this.#lt=c}static create(e,t,r,s,n,i,o,a,c,d,u){const l=new nt(e,t,r,s,n,i,o,a,c,d,u);l.#gt();i.addContext(l);l.isTopLevelContext()||l.parent.addChild(l.id);n.registerPromiseEvent(l.targetUnblockedOrThrow().then((()=>({kind:"success",value:{type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.ContextCreated,params:{...l.serializeToBidiValue(),url:a}}})),(e=>({kind:"error",error:e}))),l.id,it.ChromiumBidi.BrowsingContext.EventNames.ContextCreated);return l}static getTimestamp(){return(new Date).getTime()}get navigableId(){return this.#st}get navigationId(){return this.#ct}dispose(e){this.#ut?.reject(new it.UnknownErrorException("navigation canceled by context disposal"));this.#mt();this.#a.deleteRealms({browsingContextId:this.id});this.isTopLevelContext()||this.parent.#Ze.delete(this.id);this.#wt();e&&this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.ContextDestroyed,params:this.serializeToBidiValue()},this.id);this.#d.clearBufferedEvents(this.id);this.#o.deleteContextById(this.id)}get id(){return this.#z}get parentId(){return this.#Qe}set parentId(e){if(this.#Qe===null){this.#Qe=e;this.isTopLevelContext()||this.parent.addChild(this.id)}else this.#e?.(ct.LogType.debugError,"Parent context already set")}get parent(){return this.parentId===null?null:this.#o.getContext(this.parentId)}get directChildren(){return[...this.#Ze].map((e=>this.#o.getContext(e)))}get allChildren(){const e=this.directChildren;return e.concat(...e.map((e=>e.allChildren)))}isTopLevelContext(){return this.#Qe===null}get top(){let e=this;let t=e.parent;while(t){e=t;t=e.parent}return e}addChild(e){this.#Ze.add(e)}#mt(e=false){this.directChildren.map((t=>t.dispose(e)))}get cdpTarget(){return this.#nt}updateCdpTarget(e){this.#nt=e;this.#gt()}get url(){return this.#rt}async lifecycleLoaded(){await this.#et.load}async targetUnblockedOrThrow(){const e=await this.#nt.unblocked;if(e.kind==="error")throw e.error}async getOrCreateSandbox(e){if(e===void 0||e==="")return await this.#it;let t=this.#a.findRealms({browsingContextId:this.id,sandbox:e});if(t.length===0){await this.#nt.cdpClient.sendCommand("Page.createIsolatedWorld",{frameId:this.id,worldName:e});t=this.#a.findRealms({browsingContextId:this.id,sandbox:e});(0,ot.assert)(t.length!==0)}return t[0]}serializeToBidiValue(e=0,t=true){return{context:this.#z,url:this.url,userContext:this.userContext,originalOpener:this.#lt??null,clientWindow:"",children:e>0?this.directChildren.map((t=>t.serializeToBidiValue(e-1,false))):null,...t?{parent:this.#Qe}:{}}}onTargetInfoChanged(e){this.#rt=e.targetInfo.url}#gt(){this.#nt.cdpClient.on("Page.frameNavigated",(e=>{if(this.id===e.frame.id){this.#rt=e.frame.url+(e.frame.urlFragment??"");this.#at=void 0;this.#mt()}}));this.#nt.cdpClient.on("Page.navigatedWithinDocument",(e=>{if(this.id!==e.frameId)return;if(e.navigationType==="historyApi"){this.#rt=e.url;this.#d.registerEvent({type:"event",method:"browsingContext.historyUpdated",params:{context:this.id,url:this.#rt}},this.id);return}this.#at=void 0;const t=nt.getTimestamp();this.#rt=e.url;this.#tt.withinDocument.resolve();e.navigationType==="fragment"&&this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.FragmentNavigated,params:{context:this.id,navigation:this.#ct,timestamp:t,url:this.#rt}},this.id)}));this.#nt.cdpClient.on("Page.frameStartedLoading",(e=>{if(this.id===e.frameId){this.#ct=this.#dt??(0,ut.uuidv4)();this.#dt=void 0;this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.NavigationStarted,params:{context:this.id,navigation:this.#ct,timestamp:nt.getTimestamp(),url:this.#at??"UNKNOWN"}},this.id)}}));this.#nt.cdpClient.on("Page.frameScheduledNavigation",(e=>{this.id===e.frameId&&(this.#at=e.url)}));this.#nt.cdpClient.on("Page.frameRequestedNavigation",(e=>{if(this.id===e.frameId){if(this.#ut!==void 0){this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.NavigationAborted,params:{context:this.id,navigation:this.#ct,timestamp:nt.getTimestamp(),url:this.#rt}},this.id);this.#ut.reject(it.ChromiumBidi.BrowsingContext.EventNames.NavigationAborted);this.#ut=void 0}this.#at=e.url}}));this.#nt.cdpClient.on("Page.lifecycleEvent",(e=>{if(this.id!==e.frameId)return;if(e.name==="init"){this.#ft(e.loaderId);return}if(e.name==="commit"){this.#st=e.loaderId;return}this.#st||(this.#st=e.loaderId);if(e.loaderId!==this.#st)return;const t=nt.getTimestamp();switch(e.name){case"DOMContentLoaded":this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.DomContentLoaded,params:{context:this.id,navigation:this.#ct,timestamp:t,url:this.#rt}},this.id);this.#et.DOMContentLoaded.resolve();break;case"load":this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.Load,params:{context:this.id,navigation:this.#ct,timestamp:t,url:this.#rt}},this.id);this.#et.load.resolve();break}}));this.#nt.cdpClient.on("Runtime.executionContextCreated",(e=>{const{auxData:t,name:r,uniqueId:s,id:n}=e.context;if(!t||t.frameId!==this.id)return;let i;let o;switch(t.type){case"isolated":o=r;this.#it.isFinished||this.#e?.(ct.LogType.debugError,"Unexpectedly, isolated realm created before the default one");i=this.#it.isFinished?this.#it.result.origin:"";break;case"default":i=serializeOrigin(e.context.origin);break;default:return}const a=new lt.WindowRealm(this.id,this.#o,this.#nt.cdpClient,this.#d,n,this.#e,i,s,this.#a,o);if(t.isDefault){this.#it.resolve(a);void Promise.all(this.#nt.getChannels().map((e=>e.startListenerFromWindow(a,this.#d))))}}));this.#nt.cdpClient.on("Runtime.executionContextDestroyed",(e=>{this.#it.isFinished&&this.#it.result.executionContextId===e.executionContextId&&(this.#it=new at.Deferred);this.#a.deleteRealms({cdpSessionId:this.#nt.cdpSessionId,executionContextId:e.executionContextId})}));this.#nt.cdpClient.on("Runtime.executionContextsCleared",(()=>{this.#it.isFinished||this.#it.reject(new it.UnknownErrorException("execution contexts cleared"));this.#it=new at.Deferred;this.#a.deleteRealms({cdpSessionId:this.#nt.cdpSessionId})}));this.#nt.cdpClient.on("Page.javascriptDialogClosed",(e=>{const t=e.result;this.#ht===void 0&&this.#e?.(ct.LogType.debugError,"Unexpectedly no opening prompt event before closing one");this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.UserPromptClosed,params:{context:this.id,accepted:t,type:this.#ht??"UNKNOWN",userText:t&&e.userInput?e.userInput:void 0}},this.id);this.#ht=void 0}));this.#nt.cdpClient.on("Page.javascriptDialogOpening",(e=>{const t=nt.#vt(e.type);this.#ht=t;const r=this.#Ct(t);this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.UserPromptOpened,params:{context:this.id,handler:r,type:t,message:e.message,...e.type==="prompt"?{defaultValue:e.defaultPrompt}:{}}},this.id);switch(r){case"accept":void this.handleUserPrompt(true);break;case"dismiss":void this.handleUserPrompt(false);break;case"ignore":break}}))}static#vt(e){switch(e){case"alert":return"alert";case"beforeunload":return"beforeunload";case"confirm":return"confirm";case"prompt":return"prompt"}}#Ct(e){const t="dismiss";switch(e){case"alert":return this.#pt?.alert??this.#pt?.default??t;case"beforeunload":return this.#pt?.beforeUnload??this.#pt?.default??"accept";case"confirm":return this.#pt?.confirm??this.#pt?.default??t;case"prompt":return this.#pt?.prompt??this.#pt?.default??t}}#ft(e){if(e!==void 0&&this.#st!==e){this.#bt();this.#st=e;this.#mt(true)}else this.#tt.withinDocument.isFinished?this.#tt.withinDocument=new at.Deferred:this.#e?.(nt.LOGGER_PREFIX,"Document changed (navigatedWithinDocument)")}#bt(){this.#et.DOMContentLoaded.isFinished?this.#et.DOMContentLoaded=new at.Deferred:this.#e?.(nt.LOGGER_PREFIX,"Document changed (DOMContentLoaded)");this.#et.load.isFinished?this.#et.load=new at.Deferred:this.#e?.(nt.LOGGER_PREFIX,"Document changed (load)")}#wt(){this.#et.DOMContentLoaded.isFinished||this.#et.DOMContentLoaded.reject(new it.UnknownErrorException("navigation canceled"));this.#et.load.isFinished||this.#et.load.reject(new it.UnknownErrorException("navigation canceled"))}async navigate(e,t){try{new URL(e)}catch{throw new it.InvalidArgumentException(`Invalid URL: ${e}`)}this.#ut?.reject(new it.UnknownErrorException("navigation canceled by concurrent navigation"));await this.targetUnblockedOrThrow();this.#at=e;const r=(0,ut.uuidv4)();this.#dt=r;this.#ut=new at.Deferred;const s=(async()=>{const t=await this.#nt.cdpClient.sendCommand("Page.navigate",{url:e,frameId:this.id});if(t.errorText){this.#at=void 0;this.#d.registerEvent({type:"event",method:it.ChromiumBidi.BrowsingContext.EventNames.NavigationFailed,params:{context:this.id,navigation:r,timestamp:nt.getTimestamp(),url:e}},this.id);throw new it.UnknownErrorException(t.errorText)}this.#ft(t.loaderId);return t})();if(t==="none"){this.#ut?.resolve();this.#ut=void 0;return{navigation:r,url:e}}const n=await s;await Promise.race([this.#xt(t,n.loaderId===void 0),this.#ut]).catch((e=>{if(e!==it.ChromiumBidi.BrowsingContext.EventNames.NavigationAborted)throw e}));this.#ut?.resolve();this.#ut=void 0;return{navigation:r,url:this.#rt}}async#xt(e,t){if(t)await this.#tt.withinDocument;else switch(e){case"none":return;case"interactive":await this.#et.DOMContentLoaded;return;case"complete":await this.#et.load;return}}async reload(e,t){await this.targetUnblockedOrThrow();this.#bt();await this.#nt.cdpClient.sendCommand("Page.reload",{ignoreCache:e});switch(t){case"none":break;case"interactive":await this.#et.DOMContentLoaded;break;case"complete":await this.#et.load;break}return{navigation:this.#ct,url:this.url}}async setViewport(e,t){if(e===null&&t===null)await this.#nt.cdpClient.sendCommand("Emulation.clearDeviceMetricsOverride");else try{let r;r=e===void 0?this.#ot:e===null?{width:0,height:0}:e;this.#ot=r;await this.#nt.cdpClient.sendCommand("Emulation.setDeviceMetricsOverride",{width:this.#ot.width,height:this.#ot.height,deviceScaleFactor:t||0,mobile:false,dontSetVisibleSize:true})}catch(e){if(e.message.startsWith("Width and height values must be positive"))throw new it.UnsupportedOperationException("Provided viewport dimensions are not supported");throw e}}async handleUserPrompt(e,t){await this.#nt.cdpClient.sendCommand("Page.handleJavaScriptDialog",{accept:e??true,promptText:t})}async activate(){await this.#nt.cdpClient.sendCommand("Page.bringToFront")}async captureScreenshot(e){if(!this.isTopLevelContext())throw new it.UnsupportedOperationException(`Non-top-level 'context' (${e.context}) is currently not supported`);const t=getImageFormatParameters(e);await this.#nt.cdpClient.sendCommand("Page.bringToFront");let r=false;let s;e.origin??="viewport";switch(e.origin){case"document":s=String((()=>{const e=document.documentElement;return{x:0,y:0,width:e.scrollWidth,height:e.scrollHeight}}));r=true;break;case"viewport":s=String((()=>{const e=window.visualViewport;return{x:e.pageLeft,y:e.pageTop,width:e.width,height:e.height}}));break}const n=await this.getOrCreateSandbox(void 0);const i=await n.callFunction(s,false);(0,ot.assert)(i.type==="success");const o=deserializeDOMRect(i.result);(0,ot.assert)(o);let a=o;if(e.clip){const t=e.clip;if(e.origin==="viewport"&&t.type==="box"){t.x+=o.x;t.y+=o.y}a=getIntersectionRect(await this.#yt(t),o)}if(a.width===0||a.height===0)throw new it.UnableToCaptureScreenException(`Unable to capture screenshot with zero dimensions: width=${a.width}, height=${a.height}`);return await this.#nt.cdpClient.sendCommand("Page.captureScreenshot",{clip:{...a,scale:1},...t,captureBeyondViewport:r})}async print(e){if(!this.isTopLevelContext())throw new it.UnsupportedOperationException("Printing of non-top level contexts is not supported");const t={};e.background!==void 0&&(t.printBackground=e.background);e.margin?.bottom!==void 0&&(t.marginBottom=(0,dt.inchesFromCm)(e.margin.bottom));e.margin?.left!==void 0&&(t.marginLeft=(0,dt.inchesFromCm)(e.margin.left));e.margin?.right!==void 0&&(t.marginRight=(0,dt.inchesFromCm)(e.margin.right));e.margin?.top!==void 0&&(t.marginTop=(0,dt.inchesFromCm)(e.margin.top));e.orientation!==void 0&&(t.landscape=e.orientation==="landscape");e.page?.height!==void 0&&(t.paperHeight=(0,dt.inchesFromCm)(e.page.height));e.page?.width!==void 0&&(t.paperWidth=(0,dt.inchesFromCm)(e.page.width));if(e.pageRanges!==void 0){for(const t of e.pageRanges){if(typeof t==="number")continue;const e=t.split("-");if(e.length<1||e.length>2)throw new it.InvalidArgumentException(`Invalid page range: ${t} is not a valid integer range.`);if(e.length===1){void parseInteger(e[0]??"");continue}let r;let s;const[n="",i=""]=e;r=n===""?1:parseInteger(n);s=i===""?Number.MAX_SAFE_INTEGER:parseInteger(i);if(r>s)throw new it.InvalidArgumentException(`Invalid page range: ${n} > ${i}`)}t.pageRanges=e.pageRanges.join(",")}e.scale!==void 0&&(t.scale=e.scale);e.shrinkToFit!==void 0&&(t.preferCSSPageSize=!e.shrinkToFit);try{const e=await this.#nt.cdpClient.sendCommand("Page.printToPDF",t);return{data:e.data}}catch(e){if(e.message==="invalid print parameters: content area is empty")throw new it.UnsupportedOperationException(e.message);throw e}}async#yt(e){switch(e.type){case"box":return{x:e.x,y:e.y,width:e.width,height:e.height};case"element":{const t=await this.getOrCreateSandbox(void 0);const r=await t.callFunction(String((e=>e instanceof Element)),false,{type:"undefined"},[e.element]);if(r.type==="exception")throw new it.NoSuchElementException(`Element '${e.element.sharedId}' was not found`);(0,ot.assert)(r.result.type==="boolean");if(!r.result.value)throw new it.NoSuchElementException(`Node '${e.element.sharedId}' is not an Element`);{const r=await t.callFunction(String((e=>{const t=e.getBoundingClientRect();return{x:t.x,y:t.y,height:t.height,width:t.width}})),false,{type:"undefined"},[e.element]);(0,ot.assert)(r.type==="success");const s=deserializeDOMRect(r.result);if(!s)throw new it.UnableToCaptureScreenException(`Could not get bounding box for Element '${e.element.sharedId}'`);return s}}}}async close(){await this.#nt.cdpClient.sendCommand("Page.close")}async traverseHistory(e){if(e===0)return;const t=await this.#nt.cdpClient.sendCommand("Page.getNavigationHistory");const r=t.entries[t.currentIndex+e];if(!r)throw new it.NoSuchHistoryEntryException(`No history entry at delta ${e}`);await this.#nt.cdpClient.sendCommand("Page.navigateToHistoryEntry",{entryId:r.id})}async toggleModulesIfNeeded(){await Promise.all([this.#nt.toggleNetworkIfNeeded(),this.#nt.toggleDeviceAccessIfNeeded()])}async locateNodes(e){return await this.#St(await this.#it,e.locator,e.startNodes??[],e.maxNodeCount,e.serializationOptions)}async#Pt(e,t,r,s){switch(t.type){case"css":return{functionDeclaration:String(((e,t,...r)=>{const locateNodesUsingCss=t=>{if(!(t instanceof HTMLElement||t instanceof Document||t instanceof DocumentFragment))throw new Error("startNodes in css selector should be HTMLElement, Document or DocumentFragment");return[...t.querySelectorAll(e)]};r=r.length>0?r:[document];const s=r.map((e=>locateNodesUsingCss(e))).flat(1);return t===0?s:s.slice(0,t)})),argumentsLocalValues:[{type:"string",value:t.value},{type:"number",value:r??0},...s]};case"xpath":return{functionDeclaration:String(((e,t,...r)=>{const s=new XPathEvaluator;const n=s.createExpression(e);const locateNodesUsingXpath=e=>{const t=n.evaluate(e,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);const r=[];for(let e=0;e<t.snapshotLength;e++)r.push(t.snapshotItem(e));return r};r=r.length>0?r:[document];const i=r.map((e=>locateNodesUsingXpath(e))).flat(1);return t===0?i:i.slice(0,t)})),argumentsLocalValues:[{type:"string",value:t.value},{type:"number",value:r??0},...s]};case"innerText":if(t.value==="")throw new it.InvalidSelectorException("innerText locator cannot be empty");return{functionDeclaration:String(((e,t,r,s,n,...i)=>{const o=r?e.toUpperCase():e;const locateNodesUsingInnerText=(e,s)=>{const n=[];if(e instanceof DocumentFragment||e instanceof Document){const t=[...e.children];t.forEach((e=>n.push(...locateNodesUsingInnerText(e,s))));return n}if(!(e instanceof HTMLElement))return[];const i=e;const a=r?i.innerText?.toUpperCase():i.innerText;if(!a.includes(o))return[];const c=[];for(const e of i.children)e instanceof HTMLElement&&c.push(e);if(c.length===0)t&&a===o?n.push(i):t||n.push(i);else{const e=s<=0?[]:c.map((e=>locateNodesUsingInnerText(e,s-1))).flat(1);e.length===0?t&&a!==o||n.push(i):n.push(...e)}return n};i=i.length>0?i:[document];const a=i.map((e=>locateNodesUsingInnerText(e,n))).flat(1);return s===0?a:a.slice(0,s)})),argumentsLocalValues:[{type:"string",value:t.value},{type:"boolean",value:t.matchType!=="partial"},{type:"boolean",value:t.ignoreCase===true},{type:"number",value:r??0},{type:"number",value:t.maxDepth??1e3},...s]};case"accessibility":{if(!t.value.name&&!t.value.role)throw new it.InvalidSelectorException("Either name or role has to be specified");await Promise.all([this.#nt.cdpClient.sendCommand("Accessibility.enable"),this.#nt.cdpClient.sendCommand("Accessibility.getRootAXNode")]);const n=await e.evaluate("({getAccessibleName, getAccessibleRole})",false,"root",void 0,false,true);if(n.type!=="success")throw new Error("Could not get bindings");if(n.result.type!=="object")throw new Error("Could not get bindings");return{functionDeclaration:String(((e,t,r,s,...n)=>{const i=[];let o=false;function collect(e,t){if(!o)for(const n of e){let e=true;if(t.role){const s=r.getAccessibleRole(n);t.role!==s&&(e=false)}if(t.name){const s=r.getAccessibleName(n);t.name!==s&&(e=false)}if(e){if(s!==0&&i.length===s){o=true;break}i.push(n)}const a=[];for(const e of n.children)e instanceof HTMLElement&&a.push(e);collect(a,t)}}n=n.length>0?n:Array.from(document.documentElement.children).filter((e=>e instanceof HTMLElement));collect(n,{role:t,name:e});return i})),argumentsLocalValues:[{type:"string",value:t.value.name||""},{type:"string",value:t.value.role||""},{handle:n.result.handle},{type:"number",value:r??0},...s]}}}}async#St(e,t,r,s,n){const i=await this.#Pt(e,t,s,r);n={...n,maxObjectDepth:1};const o=await e.callFunction(i.functionDeclaration,false,{type:"undefined"},i.argumentsLocalValues,"none",n);if(o.type!=="success"){this.#e?.(nt.LOGGER_PREFIX,"Failed locateNodesByLocator",o);if(o.exceptionDetails.text?.endsWith("is not a valid selector.")||o.exceptionDetails.text?.endsWith("is not a valid XPath expression."))throw new it.InvalidSelectorException(`Not valid selector ${typeof t.value==="string"?t.value:JSON.stringify(t.value)}`);if(o.exceptionDetails.text==="Error: startNodes in css selector should be HTMLElement, Document or DocumentFragment")throw new it.InvalidArgumentException("startNodes in css selector should be HTMLElement, Document or DocumentFragment");throw new it.UnknownErrorException(`Unexpected error in selector script: ${o.exceptionDetails.text}`)}if(o.result.type!=="array")throw new it.UnknownErrorException(`Unexpected selector script result type: ${o.result.type}`);const a=o.result.value.map((e=>{if(e.type!=="node")throw new it.UnknownErrorException(`Unexpected selector script result element: ${e.type}`);return e}));return{nodes:a}}}st.BrowsingContextImpl=BrowsingContextImpl;nt=BrowsingContextImpl;function serializeOrigin(e){["://",""].includes(e)&&(e="null");return e}function getImageFormatParameters(e){const{quality:t,type:r}=e.format??{type:"image/png"};switch(r){case"image/png":return{format:"png"};case"image/jpeg":return{format:"jpeg",...t===void 0?{}:{quality:Math.round(t*100)}};case"image/webp":return{format:"webp",...t===void 0?{}:{quality:Math.round(t*100)}}}throw new it.InvalidArgumentException(`Image format '${r}' is not a supported format`)}function deserializeDOMRect(e){if(e.type!=="object"||e.value===void 0)return;const t=e.value.find((([e])=>e==="x"))?.[1];const r=e.value.find((([e])=>e==="y"))?.[1];const s=e.value.find((([e])=>e==="height"))?.[1];const n=e.value.find((([e])=>e==="width"))?.[1];return t?.type==="number"&&r?.type==="number"&&s?.type==="number"&&n?.type==="number"?{x:t.value,y:r.value,width:n.value,height:s.value}:void 0}function normalizeRect(e){return{...e.width<0?{x:e.x+e.width,width:-e.width}:{x:e.x,width:e.width},...e.height<0?{y:e.y+e.height,height:-e.height}:{y:e.y,height:e.height}}}function getIntersectionRect(e,t){e=normalizeRect(e);t=normalizeRect(t);const r=Math.max(e.x,t.x);const s=Math.max(e.y,t.y);return{x:r,y:s,width:Math.max(Math.min(e.x+e.width,t.x+t.width)-r,0),height:Math.max(Math.min(e.y+e.height,t.y+t.height)-s,0)}}function parseInteger(e){e=e.trim();if(!/^[0-9]+$/.test(e))throw new it.InvalidArgumentException(`Invalid integer: ${e}`);return parseInt(e)}var ht={};Object.defineProperty(ht,"__esModule",{value:true});ht.WorkerRealm=void 0;const pt=Ve;class WorkerRealm extends pt.Realm{#It;#Et;constructor(e,t,r,s,n,i,o,a,c){super(e,t,r,s,n,o,a);this.#Et=i;this.#It=c;this.initialize()}get associatedBrowsingContexts(){return this.#Et.flatMap((e=>e.associatedBrowsingContexts))}get realmType(){return this.#It}get source(){return{realm:this.realmId,context:this.associatedBrowsingContexts[0]?.id}}get realmInfo(){const e=this.#Et.map((e=>e.realmId));const{realmType:t}=this;switch(t){case"dedicated-worker":{const r=e[0];if(r===void 0||e.length!==1)throw new Error("Dedicated worker must have exactly one owner");return{...this.baseInfo,type:t,owners:[r]}}case"service-worker":case"shared-worker":return{...this.baseInfo,type:t}}}}ht.WorkerRealm=WorkerRealm;var gt={};Object.defineProperty(gt,"__esModule",{value:true});gt.logMessageFormatter=logMessageFormatter;gt.getRemoteValuesText=getRemoteValuesText;const mt=v;const wt=["%s","%d","%i","%f","%o","%O","%c"];function isFormatSpecifier(e){return wt.some((t=>e.includes(t)))}
/**
 * @param args input remote values to be format printed
 * @return parsed text of the remote values in specific format
 */function logMessageFormatter(e){let t="";const r=e[0].value.toString();const s=e.slice(1,void 0);const n=r.split(new RegExp(wt.map((e=>`(${e})`)).join("|"),"g"));for(const r of n)if(r!==void 0&&r!=="")if(isFormatSpecifier(r)){const n=s.shift();(0,mt.assert)(n,`Less value is provided: "${getRemoteValuesText(e,false)}"`);r==="%s"?t+=stringFromArg(n):r==="%d"||r==="%i"?n.type==="bigint"||n.type==="number"||n.type==="string"?t+=parseInt(n.value.toString(),10):t+="NaN":r==="%f"?n.type==="bigint"||n.type==="number"||n.type==="string"?t+=parseFloat(n.value.toString()):t+="NaN":t+=toJson(n)}else t+=r;if(s.length>0)throw new Error(`More value is provided: "${getRemoteValuesText(e,false)}"`);return t}
/**
 * @param arg input remote value to be parsed
 * @return parsed text of the remote value
 *
 * input: {"type": "number", "value": 1}
 * output: 1
 *
 * input: {"type": "string", "value": "abc"}
 * output: "abc"
 *
 * input: {"type": "object",  "value": [["id", {"type": "number", "value": 1}]]}
 * output: '{"id": 1}'
 *
 * input: {"type": "object", "value": [["font-size", {"type": "string", "value": "20px"}]]}
 * output: '{"font-size": "20px"}'
 */function toJson(e){if(e.type!=="array"&&e.type!=="bigint"&&e.type!=="date"&&e.type!=="number"&&e.type!=="object"&&e.type!=="string")return stringFromArg(e);if(e.type==="bigint")return`${e.value.toString()}n`;if(e.type==="number")return e.value.toString();if(["date","string"].includes(e.type))return JSON.stringify(e.value);if(e.type==="object")return`{${e.value.map((e=>`${JSON.stringify(e[0])}:${toJson(e[1])}`)).join(",")}}`;if(e.type==="array")return`[${e.value?.map((e=>toJson(e))).join(",")??""}]`;throw Error(`Invalid value type: ${e}`)}function stringFromArg(e){if(!Object.hasOwn(e,"value"))return e.type;switch(e.type){case"string":case"number":case"boolean":case"bigint":return String(e.value);case"regexp":return`/${e.value.pattern}/${e.value.flags??""}`;case"date":return new Date(e.value).toString();case"object":return`Object(${e.value?.length??""})`;case"array":return`Array(${e.value?.length??""})`;case"map":return`Map(${e.value?.length})`;case"set":return`Set(${e.value?.length})`;default:return e.type}}function getRemoteValuesText(e,t){const r=e[0];return r?r.type==="string"&&isFormatSpecifier(r.value.toString())&&t?logMessageFormatter(e):e.map((e=>stringFromArg(e))).join(" "):""}var ft={};var vt;Object.defineProperty(ft,"__esModule",{value:true});ft.LogManager=void 0;const Ct=r;const bt=e;const xt=gt;function getBidiStackTrace(e){const t=e?.callFrames.map((e=>({columnNumber:e.columnNumber,functionName:e.functionName,lineNumber:e.lineNumber,url:e.url})));return t?{callFrames:t}:void 0}function getLogLevel(e){return["error","assert"].includes(e)?"error":["debug","trace"].includes(e)?"debug":["warn","warning"].includes(e)?"warn":"info"}function getLogMethod(e){switch(e){case"warning":return"warn";case"startGroup":return"group";case"startGroupCollapsed":return"groupCollapsed";case"endGroup":return"groupEnd"}return e}class LogManager{#d;#a;#nt;#e;constructor(e,t,r,s){this.#nt=e;this.#a=t;this.#d=r;this.#e=s}static create(e,t,r,s){const n=new vt(e,t,r,s);n.#kt();return n}async#Tt(e,t){switch(e.type){case"undefined":return{type:"undefined"};case"boolean":return{type:"boolean",value:e.value};case"string":return{type:"string",value:e.value};case"number":return{type:"number",value:e.unserializableValue??e.value};case"bigint":if(e.unserializableValue!==void 0&&e.unserializableValue[e.unserializableValue.length-1]==="n")return{type:e.type,value:e.unserializableValue.slice(0,-1)};break;case"object":if(e.subtype==="null")return{type:"null"};break;default:break}return await t.serializeCdpObject(e,"none")}#kt(){this.#nt.cdpClient.on("Runtime.consoleAPICalled",(e=>{const t=this.#a.findRealm({cdpSessionId:this.#nt.cdpSessionId,executionContextId:e.executionContextId});if(t===void 0){this.#e?.(bt.LogType.cdp,e);return}const r=Promise.all(e.args.map((e=>this.#Tt(e,t))));for(const s of t.associatedBrowsingContexts)this.#d.registerPromiseEvent(r.then((r=>({kind:"success",value:{type:"event",method:Ct.ChromiumBidi.Log.EventNames.LogEntryAdded,params:{level:getLogLevel(e.type),source:t.source,text:(0,xt.getRemoteValuesText)(r,true),timestamp:Math.round(e.timestamp),stackTrace:getBidiStackTrace(e.stackTrace),type:"console",method:getLogMethod(e.type),args:r}}})),(e=>({kind:"error",error:e}))),s.id,Ct.ChromiumBidi.Log.EventNames.LogEntryAdded)}));this.#nt.cdpClient.on("Runtime.exceptionThrown",(e=>{const t=this.#a.findRealm({cdpSessionId:this.#nt.cdpSessionId,executionContextId:e.exceptionDetails.executionContextId});if(t!==void 0)for(const r of t.associatedBrowsingContexts)this.#d.registerPromiseEvent(vt.#Mt(e,t).then((r=>({kind:"success",value:{type:"event",method:Ct.ChromiumBidi.Log.EventNames.LogEntryAdded,params:{level:"error",source:t.source,text:r,timestamp:Math.round(e.timestamp),stackTrace:getBidiStackTrace(e.exceptionDetails.stackTrace),type:"javascript"}}})),(e=>({kind:"error",error:e}))),r.id,Ct.ChromiumBidi.Log.EventNames.LogEntryAdded);else this.#e?.(bt.LogType.cdp,e)}))}static async#Mt(e,t){return e.exceptionDetails.exception?t===void 0?JSON.stringify(e.exceptionDetails.exception):await t.stringifyObject(e.exceptionDetails.exception):e.exceptionDetails.text}}ft.LogManager=LogManager;vt=LogManager;var yt={};Object.defineProperty(yt,"__esModule",{value:true});yt.CdpTarget=void 0;const St=n;const Pt=ze;const It=e;const Et=st;const kt=ft;class CdpTarget{#z;#Ae;#i;#Nt;#a;#d;#se;#o;#Rt;#j;#Bt=new Pt.Deferred;#pt;#e;#Dt=false;#Ft=false;#Ot=false;#At={request:false,response:false,auth:false};static create(e,t,r,s,n,i,o,a,c,d,u,l){const h=new CdpTarget(e,t,r,s,i,n,o,a,c,d,u,l);kt.LogManager.create(h,n,i,l);h.#qt();void h.#Lt();return h}constructor(e,t,r,s,n,i,o,a,c,d,u,l){this.#z=e;this.#Ae=t;this.#i=r;this.#Nt=s;this.#d=n;this.#a=i;this.#se=o;this.#j=c;this.#o=a;this.#Rt=d;this.#pt=u;this.#e=l}get unblocked(){return this.#Bt}get id(){return this.#z}get cdpClient(){return this.#Ae}get parentCdpClient(){return this.#Nt}get browserCdpClient(){return this.#i}get cdpSessionId(){return this.#Ae.sessionId}async#Lt(){try{await Promise.all([this.#Ae.sendCommand("Page.enable"),this.#Ae.sendCommand("Page.getFrameTree").then((e=>this.#Ut(e.frameTree))),this.#Ae.sendCommand("Runtime.enable"),this.#Ae.sendCommand("Page.setLifecycleEventsEnabled",{enabled:true}),this.#Ae.sendCommand("Page.setPrerenderingAllowed",{isAllowed:!this.#Rt}).catch((()=>{})),this.toggleNetworkIfNeeded(),this.#Ae.sendCommand("Target.setAutoAttach",{autoAttach:true,waitForDebuggerOnStart:true,flatten:true}),this.#jt(),this.#Ae.sendCommand("Runtime.runIfWaitingForDebugger"),this.#Nt.sendCommand("Runtime.runIfWaitingForDebugger"),this.toggleDeviceAccessIfNeeded()])}catch(e){this.#e?.(It.LogType.debugError,"Failed to unblock target",e);if(!this.#Ae.isCloseError(e)){this.#Bt.resolve({kind:"error",error:e});return}}this.#Bt.resolve({kind:"success",value:void 0})}#Ut(e){const t=e.frame;const r=this.#o.findContext(t.id);r!==void 0&&r.parentId===null&&t.parentId!==null&&t.parentId!==void 0&&(r.parentId=t.parentId);if(r===void 0&&t.parentId!==void 0){const e=this.#o.getContext(t.parentId);Et.BrowsingContextImpl.create(t.id,t.parentId,e.userContext,e.cdpTarget,this.#d,this.#o,this.#a,t.url,void 0,this.#pt,this.#e)}e.childFrames?.map((e=>this.#Ut(e)))}async toggleFetchIfNeeded(){const e=this.#j.getInterceptionStages(this.topLevelId);if(!this.#Ot||this.#At.request===e.request&&this.#At.response===e.response&&this.#At.auth===e.auth)return;const t=[];this.#At=e;(e.request||e.auth)&&t.push({urlPattern:"*",requestStage:"Request"});e.response&&t.push({urlPattern:"*",requestStage:"Response"});if(t.length)await this.#Ae.sendCommand("Fetch.enable",{patterns:t,handleAuthRequests:e.auth});else{const e=this.#j.getRequestsByTarget(this).filter((e=>e.interceptPhase));void Promise.allSettled(e.map((e=>e.waitNextPhase))).then((async()=>{const e=this.#j.getRequestsByTarget(this).filter((e=>e.interceptPhase));return e.length?await this.toggleFetchIfNeeded():await this.#Ae.sendCommand("Fetch.disable")})).catch((e=>{this.#e?.(It.LogType.bidi,"Disable failed",e)}))}}async toggleNetworkIfNeeded(){const e=this.isSubscribedTo(St.BiDiModule.Network);if(e!==this.#Ot){this.#Ot=e;try{await Promise.all([this.#Ae.sendCommand(e?"Network.enable":"Network.disable").then((async()=>await this.toggleSetCacheDisabled())),this.toggleFetchIfNeeded()])}catch(t){this.#e?.(It.LogType.debugError,t);this.#Ot=!e;if(!this.#Kt(t))throw t}}}async toggleSetCacheDisabled(e){const t=this.#j.defaultCacheBehavior==="bypass";const r=e??t;if(this.#Ot&&this.#Ft!==r){this.#Ft=r;try{await this.#Ae.sendCommand("Network.setCacheDisabled",{cacheDisabled:r})}catch(e){this.#e?.(It.LogType.debugError,e);this.#Ft=!r;if(!this.#Kt(e))throw e}}}async toggleDeviceAccessIfNeeded(){const e=this.isSubscribedTo(St.BiDiModule.Bluetooth);if(this.#Dt!==e){this.#Dt=e;try{await this.#Ae.sendCommand(e?"DeviceAccess.enable":"DeviceAccess.disable")}catch(t){this.#e?.(It.LogType.debugError,t);this.#Dt=!e;if(!this.#Kt(t))throw t}}}#Kt(e){const t=e;return t.code===-32001&&t.message==="Session with given id not found."||this.#Ae.isCloseError(e)}#qt(){this.#Ae.on("*",((e,t)=>{typeof e==="string"&&this.#d.registerEvent({type:"event",method:`cdp.${e}`,params:{event:e,params:t,session:this.cdpSessionId}},this.id)}))}async#Ht(e){this.#Ot=e;try{await this.#Ae.sendCommand(e?"Network.enable":"Network.disable")}catch{this.#Ot=!e}}async#_t(e){const t=[];(e.request||e.auth)&&t.push({urlPattern:"*",requestStage:"Request"});e.response&&t.push({urlPattern:"*",requestStage:"Response"});if(this.#Ot&&t.length){const r=this.#At;this.#At=e;try{await this.#Ae.sendCommand("Fetch.enable",{patterns:t,handleAuthRequests:e.auth})}catch{this.#At=r}}}async#zt(){const e=this.#j.getRequestsByTarget(this).filter((e=>e.interceptPhase));if(e.length===0){this.#At={request:false,response:false,auth:false};await this.#Ae.sendCommand("Fetch.disable")}}async toggleNetwork(){const e=this.#j.getInterceptionStages(this.topLevelId);const t=Object.values(e).some((e=>e));const r=this.#At.request!==e.request||this.#At.response!==e.response||this.#At.auth!==e.auth;const s=this.isSubscribedTo(St.BiDiModule.Network);const n=this.#Ot!==s;this.#e?.(It.LogType.debugInfo,"Toggle Network",`Fetch (${t}) ${r}`,`Network (${s}) ${n}`);s&&n&&await this.#Ht(true);t&&r&&await this.#_t(e);!t&&r&&await this.#zt();s||!n||t||r||await this.#Ht(false)}getChannels(){return this.#se.find().flatMap((e=>e.channels))}async#jt(){await Promise.all(this.#se.find({targetId:this.topLevelId,global:true}).map((e=>e.initInTarget(this,true))))}get topLevelId(){return this.#o.findTopLevelContextId(this.id)??this.id}isSubscribedTo(e){return this.#d.subscriptionManager.isSubscribedTo(e,this.topLevelId)}}yt.CdpTarget=CdpTarget;var Tt={};Object.defineProperty(Tt,"__esModule",{value:true});Tt.CdpTargetManager=void 0;const Mt=e;const Nt=st;const Rt=ht;const Bt=yt;const Dt={service_worker:"service-worker",shared_worker:"shared-worker",worker:"dedicated-worker"};class CdpTargetManager{#i;#c;#$t=new Set;#Vt;#d;#o;#j;#ve;#se;#a;#Wt;#e;#pt;#Rt;constructor(e,t,r,s,n,i,o,a,c,d,u,l,h){this.#c=e;this.#i=t;this.#$t.add(r);this.#Vt=r;this.#d=s;this.#o=n;this.#se=c;this.#j=o;this.#ve=a;this.#a=i;this.#Wt=d;this.#Rt=u;this.#pt=l;this.#e=h;this.#qt(t)}#qt(e){e.on("Target.attachedToTarget",(t=>{this.#Gt(t,e)}));e.on("Target.detachedFromTarget",this.#Xt.bind(this));e.on("Target.targetInfoChanged",this.#Yt.bind(this));e.on("Inspector.targetCrashed",(()=>{this.#Jt(e)}));e.on("Page.frameAttached",this.#Qt.bind(this));e.on("Page.frameDetached",this.#Zt.bind(this));e.on("Page.frameSubtreeWillBeDetached",this.#er.bind(this))}#Qt(e){const t=this.#o.findContext(e.parentFrameId);t!==void 0&&Nt.BrowsingContextImpl.create(e.frameId,e.parentFrameId,t.userContext,t.cdpTarget,this.#d,this.#o,this.#a,"about:blank",void 0,this.#pt,this.#e)}#Zt(e){e.reason!=="swap"&&this.#o.findContext(e.frameId)?.dispose(true)}#er(e){this.#o.findContext(e.frameId)?.dispose(true)}#Gt(e,t){const{sessionId:r,targetInfo:s}=e;const n=this.#c.getCdpClient(r);const detach=async()=>{await n.sendCommand("Runtime.runIfWaitingForDebugger").then((()=>t.sendCommand("Target.detachFromTarget",e))).catch((e=>this.#e?.(Mt.LogType.debugError,e)))};if(this.#Vt===s.targetId){void detach();return}const i=s.type==="service_worker"?`${t.sessionId}_${s.targetId}`:s.targetId;if(!this.#$t.has(i)){this.#$t.add(i);switch(s.type){case"tab":this.#qt(n);void(async()=>{await n.sendCommand("Target.setAutoAttach",{autoAttach:true,waitForDebuggerOnStart:true,flatten:true})})();return;case"page":case"iframe":{const e=this.#tr(n,t,s);const r=this.#o.findContext(s.targetId);if(r&&s.type==="iframe")r.updateCdpTarget(e);else{const r=this.#rr(s,t.sessionId);const n=s.browserContextId&&s.browserContextId!==this.#Wt?s.browserContextId:"default";Nt.BrowsingContextImpl.create(s.targetId,r,n,e,this.#d,this.#o,this.#a,s.url===""?"about:blank":s.url,s.openerFrameId??s.openerId,this.#pt,this.#e)}return}case"service_worker":case"worker":{const e=this.#a.findRealm({cdpSessionId:t.sessionId});if(!e){void detach();return}const r=this.#tr(n,t,s);this.#sr(Dt[s.type],r,e);return}case"shared_worker":{const e=this.#tr(n,t,s);this.#sr(Dt[s.type],e);return}}void detach()}}#rr(e,t){if(e.type!=="iframe")return null;const r=e.openerFrameId??e.openerId;return r!==void 0?r:t!==void 0?this.#o.findContextBySession(t)?.id??null:null}#tr(e,t,r){this.#qt(e);const s=Bt.CdpTarget.create(r.targetId,e,this.#i,t,this.#a,this.#d,this.#se,this.#o,this.#j,this.#Rt,this.#pt,this.#e);this.#j.onCdpTargetCreated(s);this.#ve.onCdpTargetCreated(s);return s}#nr=new Map;#sr(e,t,r){t.cdpClient.on("Runtime.executionContextCreated",(s=>{const{uniqueId:n,id:i,origin:o}=s.context;const a=new Rt.WorkerRealm(t.cdpClient,this.#d,i,this.#e,(0,Nt.serializeOrigin)(o),r?[r]:[],n,this.#a,e);this.#nr.set(t.cdpSessionId,a)}))}#Xt({sessionId:e,targetId:t}){t&&this.#se.find({targetId:t}).map((e=>{e.dispose(t)}));const r=this.#o.findContextBySession(e);if(r){r.dispose(true);return}const s=this.#nr.get(e);s&&this.#a.deleteRealms({cdpSessionId:s.cdpClient.sessionId})}#Yt(e){const t=this.#o.findContext(e.targetInfo.targetId);t&&t.onTargetInfoChanged(e)}#Jt(e){const t=this.#a.findRealms({cdpSessionId:e.sessionId});for(const e of t)e.dispose()}}Tt.CdpTargetManager=CdpTargetManager;var Ft={};Object.defineProperty(Ft,"__esModule",{value:true});Ft.BrowsingContextStorage=void 0;const Ot=r;const At=t;class BrowsingContextStorage{#te=new Map;#ir=new At.EventEmitter;getTopLevelContexts(){return this.getAllContexts().filter((e=>e.isTopLevelContext()))}getAllContexts(){return Array.from(this.#te.values())}deleteContextById(e){this.#te.delete(e)}deleteContext(e){this.#te.delete(e.id)}addContext(e){this.#te.set(e.id,e);this.#ir.emit("added",{browsingContext:e})}waitForContext(e){return new Promise((t=>{const listener=r=>{if(r.browsingContext.id===e){this.#ir.off("added",listener);t(r.browsingContext)}};this.#ir.on("added",listener)}))}hasContext(e){return this.#te.has(e)}findContext(e){return this.#te.get(e)}findTopLevelContextId(e){if(e===null)return null;const t=this.findContext(e);const r=t?.parentId??null;return r===null?e:this.findTopLevelContextId(r)}findContextBySession(e){for(const t of this.#te.values())if(t.cdpTarget.cdpSessionId===e)return t}getContext(e){const t=this.findContext(e);if(t===void 0)throw new Ot.NoSuchFrameException(`Context ${e} not found`);return t}verifyTopLevelContextsList(e){const t=new Set;if(!e)return t;for(const r of e){const e=this.getContext(r);if(!e.isTopLevelContext())throw new Ot.InvalidArgumentException(`Non top-level context '${r}' given.`);t.add(e)}return t}}Ft.BrowsingContextStorage=BrowsingContextStorage;var qt={};var Lt;Object.defineProperty(qt,"__esModule",{value:true});qt.NetworkRequest=void 0;const Ut=r;const jt=v;const Kt=ze;const Ht=e;const _t=we;const zt=/(?<=realm=").*(?=")/;class NetworkRequest{static unknownParameter="UNKNOWN";#z;#or;#ar;#cr=false;#dr;#ur={};#lr;#hr;#pr={};#d;#j;#nt;#e;#gr={[Ut.ChromiumBidi.Network.EventNames.AuthRequired]:false,[Ut.ChromiumBidi.Network.EventNames.BeforeRequestSent]:false,[Ut.ChromiumBidi.Network.EventNames.FetchError]:false,[Ut.ChromiumBidi.Network.EventNames.ResponseCompleted]:false,[Ut.ChromiumBidi.Network.EventNames.ResponseStarted]:false};waitNextPhase=new Kt.Deferred;constructor(e,t,r,s,n=0,i){this.#z=e;this.#d=t;this.#j=r;this.#nt=s;this.#dr=n;this.#e=i}get id(){return this.#z}get fetchId(){return this.#or}get interceptPhase(){return this.#ar}get url(){const e=this.#ur.info?.request.urlFragment??this.#ur.paused?.request.urlFragment??"";const t=this.#pr.info?.url??this.#pr.paused?.request.url??this.#lr?.url??this.#ur.auth?.request.url??this.#ur.info?.request.url??this.#ur.paused?.request.url??Lt.unknownParameter;return`${t}${e}`}get redirectCount(){return this.#dr}get cdpTarget(){return this.#nt}get cdpClient(){return this.#nt.cdpClient}isRedirecting(){return Boolean(this.#ur.info)}#mr(){return this.url.startsWith("data:")}get#wr(){return this.#lr?.method??this.#ur.info?.request.method??this.#ur.paused?.request.method??this.#ur.auth?.request.method??this.#pr.paused?.request.method}get#ct(){return this.#ur.info&&this.#ur.info.loaderId&&this.#ur.info.loaderId===this.#ur.info.requestId?this.#j.getNavigationId(this.#y??void 0):null}get#fr(){let e=[];this.#ur.extraInfo&&(e=this.#ur.extraInfo.associatedCookies.filter((({blockedReasons:e})=>!Array.isArray(e)||e.length===0)).map((({cookie:e})=>(0,_t.cdpToBiDiCookie)(e))));return e}get#vr(){let e=0;e=typeof this.#lr?.bodySize==="number"?this.#lr.bodySize:(0,_t.bidiBodySizeFromCdpPostDataEntries)(this.#ur.info?.request.postDataEntries??[]);return e}get#y(){return this.#pr.paused?.frameId??this.#ur.info?.frameId??this.#ur.paused?.frameId??this.#ur.auth?.frameId??null}get#Cr(){return this.#hr?.statusCode??this.#pr.paused?.responseStatusCode??this.#pr.extraInfo?.statusCode??this.#pr.info?.status}get#br(){let e=[];e=this.#lr?.headers?this.#lr.headers:[...(0,_t.bidiNetworkHeadersFromCdpNetworkHeaders)(this.#ur.info?.request.headers),...(0,_t.bidiNetworkHeadersFromCdpNetworkHeaders)(this.#ur.extraInfo?.headers)];return e}get#xr(){if(!this.#pr.info)return;if(!(this.#Cr===401||this.#Cr===407))return;const e=this.#Cr===401?"WWW-Authenticate":"Proxy-Authenticate";const t=[];for(const[r,s]of Object.entries(this.#pr.info.headers))r.localeCompare(e,void 0,{sensitivity:"base"})===0&&t.push({scheme:s.split(" ").at(0)??"",realm:s.match(zt)?.at(0)??""});return t}get#yr(){return{timeOrigin:(0,_t.getTiming)(this.#pr.info?.timing?.requestTime),requestTime:(0,_t.getTiming)(this.#pr.info?.timing?.requestTime),redirectStart:0,redirectEnd:0,fetchStart:(0,_t.getTiming)(this.#pr.info?.timing?.requestTime),dnsStart:(0,_t.getTiming)(this.#pr.info?.timing?.dnsStart),dnsEnd:(0,_t.getTiming)(this.#pr.info?.timing?.dnsEnd),connectStart:(0,_t.getTiming)(this.#pr.info?.timing?.connectStart),connectEnd:(0,_t.getTiming)(this.#pr.info?.timing?.connectEnd),tlsStart:(0,_t.getTiming)(this.#pr.info?.timing?.sslStart),requestStart:(0,_t.getTiming)(this.#pr.info?.timing?.sendStart),responseStart:(0,_t.getTiming)(this.#pr.info?.timing?.receiveHeadersStart),responseEnd:(0,_t.getTiming)(this.#pr.info?.timing?.receiveHeadersEnd)}}#Sr(){this.waitNextPhase.resolve();this.waitNextPhase=new Kt.Deferred}#Pr(e){return this.#nt.isSubscribedTo(`network.${e}`)?this.#j.getInterceptsForPhase(this,e):new Set}#Ir(e){return this.#Pr(e).size>0}handleRedirect(e){this.#pr.hasExtraInfo=false;this.#pr.info=e.redirectResponse;this.#Er({wasRedirected:true})}#Er(e={}){const t=e.wasRedirected||e.hasFailed||this.#mr()||Boolean(this.#ur.extraInfo)||this.#cr||Boolean(this.#pr.info&&!this.#pr.hasExtraInfo);const r=this.#mr()||this.#cr;const s=!r&&this.#Ir("beforeRequestSent");const n=!s||s&&Boolean(this.#ur.paused);Boolean(this.#ur.info)&&(s?n:t)&&this.#kr(this.#Tr.bind(this));const i=Boolean(this.#pr.extraInfo)||this.#cr||Boolean(this.#pr.info&&!this.#pr.hasExtraInfo);const o=!r&&this.#Ir("responseStarted");(this.#pr.info||o&&Boolean(this.#pr.paused))&&this.#kr(this.#Mr.bind(this));const a=!o||o&&Boolean(this.#pr.paused);if(Boolean(this.#pr.info)&&i&&a){this.#kr(this.#Nr.bind(this));this.#j.deleteRequest(this.id)}}onRequestWillBeSentEvent(e){this.#ur.info=e;this.#Er()}onRequestWillBeSentExtraInfoEvent(e){this.#ur.extraInfo=e;this.#Er()}onResponseReceivedExtraInfoEvent(e){if(!(e.statusCode>=300&&e.statusCode<=399&&this.#ur.info&&e.headers.location===this.#ur.info.request.url)){this.#pr.extraInfo=e;this.#Er()}}onResponseReceivedEvent(e){this.#pr.hasExtraInfo=e.hasExtraInfo;this.#pr.info=e.response;this.#Er()}onServedFromCache(){this.#cr=true;this.#Er()}onLoadingFailedEvent(e){this.#Er({hasFailed:true});this.#kr((()=>({method:Ut.ChromiumBidi.Network.EventNames.FetchError,params:{...this.#Rr(),errorText:e.errorText}})))}async failRequest(e){(0,jt.assert)(this.#or,"Network Interception not set-up.");await this.cdpClient.sendCommand("Fetch.failRequest",{requestId:this.#or,errorReason:e});this.#ar=void 0}onRequestPaused(e){this.#or=e.requestId;if(e.responseStatusCode||e.responseErrorReason){this.#pr.paused=e;this.#Ir("responseStarted")&&!this.#gr[Ut.ChromiumBidi.Network.EventNames.ResponseStarted]&&this.#or!==this.id?this.#ar="responseStarted":void this.#Br()}else{this.#ur.paused=e;this.#Ir("beforeRequestSent")&&!this.#gr[Ut.ChromiumBidi.Network.EventNames.BeforeRequestSent]&&this.#or!==this.id?this.#ar="beforeRequestSent":void this.#Dr()}this.#Er()}onAuthRequired(e){this.#or=e.requestId;this.#ur.auth=e;this.#Ir("authRequired")&&this.#or!==this.id?this.#ar="authRequired":void this.#Fr({response:"Default"});this.#kr((()=>({method:Ut.ChromiumBidi.Network.EventNames.AuthRequired,params:{...this.#Rr("authRequired"),response:this.#Or()}})))}async continueRequest(e={}){const t=this.#Ar(e.headers,e.cookies);const r=(0,_t.cdpFetchHeadersFromBidiNetworkHeaders)(t);const s=getCdpBodyFromBiDiBytesValue(e.body);await this.#Dr({url:e.url,method:e.method,headers:r,postData:s});this.#lr={url:e.url,method:e.method,headers:e.headers,cookies:e.cookies,bodySize:getSizeFromBiDiBytesValue(e.body)}}async#Dr(e={}){(0,jt.assert)(this.#or,"Network Interception not set-up.");await this.cdpClient.sendCommand("Fetch.continueRequest",{requestId:this.#or,url:e.url,method:e.method,headers:e.headers,postData:e.postData});this.#ar=void 0}async continueResponse(e={}){if(this.interceptPhase==="authRequired"){if(!e.credentials)return await this.#Fr({response:"ProvideCredentials"});await Promise.all([this.waitNextPhase,await this.#Fr({response:"ProvideCredentials",username:e.credentials.username,password:e.credentials.password})])}if(this.#ar==="responseStarted"){const t=this.#Ar(e.headers,e.cookies);const r=(0,_t.cdpFetchHeadersFromBidiNetworkHeaders)(t);await this.#Br({responseCode:e.statusCode??this.#pr.paused?.responseStatusCode,responsePhrase:e.reasonPhrase??this.#pr.paused?.responseStatusText,responseHeaders:r??this.#pr.paused?.responseHeaders});this.#hr={statusCode:e.statusCode,headers:t}}}async#Br({responseCode:e,responsePhrase:t,responseHeaders:r}={}){(0,jt.assert)(this.#or,"Network Interception not set-up.");await this.cdpClient.sendCommand("Fetch.continueResponse",{requestId:this.#or,responseCode:e,responsePhrase:t,responseHeaders:r});this.#ar=void 0}async continueWithAuth(e){let t;let r;if(e.action==="provideCredentials"){const{credentials:s}=e;t=s.username;r=s.password}const s=(0,_t.cdpAuthChallengeResponseFromBidiAuthContinueWithAuthAction)(e.action);await this.#Fr({response:s,username:t,password:r})}async provideResponse(e){(0,jt.assert)(this.#or,"Network Interception not set-up.");if(this.interceptPhase==="authRequired")return await this.#Fr({response:"ProvideCredentials"});if(!e.body&&!e.headers)return await this.#Dr();const t=this.#Ar(e.headers,e.cookies);const r=(0,_t.cdpFetchHeadersFromBidiNetworkHeaders)(t);const s=e.statusCode??this.#Cr??200;await this.cdpClient.sendCommand("Fetch.fulfillRequest",{requestId:this.#or,responseCode:s,responsePhrase:e.reasonPhrase,responseHeaders:r,body:getCdpBodyFromBiDiBytesValue(e.body)});this.#ar=void 0}dispose(){this.waitNextPhase.reject(new Error("waitNextPhase disposed"))}async#Fr(e){(0,jt.assert)(this.#or,"Network Interception not set-up.");await this.cdpClient.sendCommand("Fetch.continueWithAuth",{requestId:this.#or,authChallengeResponse:e});this.#ar=void 0}#kr(e){let t;try{t=e()}catch(e){this.#e?.(Ht.LogType.debugError,e);return}if(!(this.#qr()||this.#gr[t.method]&&t.method!==Ut.ChromiumBidi.Network.EventNames.AuthRequired)){this.#Sr();this.#gr[t.method]=true;this.#d.registerEvent(Object.assign(t,{type:"event"}),this.#y)}}#Rr(e){const t={isBlocked:false};if(e){const r=this.#Pr(e);t.isBlocked=r.size>0;t.isBlocked&&(t.intercepts=[...r])}return{context:this.#y,navigation:this.#ct,redirectCount:this.#dr,request:this.#Lr(),timestamp:Math.round((0,_t.getTiming)(this.#ur.info?.wallTime)*1e3),...t}}#Or(){this.#pr.info?.fromDiskCache&&(this.#pr.extraInfo=void 0);const e=[...(0,_t.bidiNetworkHeadersFromCdpNetworkHeaders)(this.#pr.info?.headers),...(0,_t.bidiNetworkHeadersFromCdpNetworkHeaders)(this.#pr.extraInfo?.headers)];const t=this.#xr;return{url:this.url,protocol:this.#pr.info?.protocol??"",status:this.#Cr??-1,statusText:this.#pr.info?.statusText||this.#pr.paused?.responseStatusText||"",fromCache:this.#pr.info?.fromDiskCache||this.#pr.info?.fromPrefetchCache||this.#cr,headers:this.#hr?.headers??e,mimeType:this.#pr.info?.mimeType||"",bytesReceived:this.#pr.info?.encodedDataLength||0,headersSize:(0,_t.computeHeadersSize)(e),bodySize:0,content:{size:0},...t?{authChallenges:t}:{},"goog:securityDetails":this.#pr.info?.securityDetails}}#Lr(){const e=this.#br;return{request:this.#z,url:this.url,method:this.#wr??Lt.unknownParameter,headers:e,cookies:this.#fr,headersSize:(0,_t.computeHeadersSize)(e),bodySize:this.#vr,timings:this.#yr,"goog:postData":this.#ur.info?.request?.postData,"goog:hasPostData":this.#ur.info?.request?.hasPostData,"goog:resourceType":this.#ur.info?.type}}#Tr(){(0,jt.assert)(this.#ur.info,"RequestWillBeSentEvent is not set");return{method:Ut.ChromiumBidi.Network.EventNames.BeforeRequestSent,params:{...this.#Rr("beforeRequestSent"),initiator:{type:Lt.#Ur(this.#ur.info.initiator.type),columnNumber:this.#ur.info.initiator.columnNumber,lineNumber:this.#ur.info.initiator.lineNumber,stackTrace:this.#ur.info.initiator.stack,request:this.#ur.info.initiator.requestId}}}}#Mr(){return{method:Ut.ChromiumBidi.Network.EventNames.ResponseStarted,params:{...this.#Rr("responseStarted"),response:this.#Or()}}}#Nr(){return{method:Ut.ChromiumBidi.Network.EventNames.ResponseCompleted,params:{...this.#Rr(),response:this.#Or()}}}#qr(){const e="/favicon.ico";return this.#ur.paused?.request.url.endsWith(e)??this.#ur.info?.request.url.endsWith(e)??false}#Ar(e,t){if(!e&&!t)return;let r=e;const s=(0,_t.networkHeaderFromCookieHeaders)(t);s&&!r&&(r=this.#br);if(s&&r){r.filter((e=>e.name.localeCompare("cookie",void 0,{sensitivity:"base"})!==0));r.push(s)}return r}static#Ur(e){switch(e){case"parser":case"script":case"preflight":return e;default:return"other"}}}qt.NetworkRequest=NetworkRequest;Lt=NetworkRequest;function getCdpBodyFromBiDiBytesValue(e){let t;e?.type==="string"?t=btoa(e.value):e?.type==="base64"&&(t=e.value);return t}function getSizeFromBiDiBytesValue(e){return e?.type==="string"?e.value.length:e?.type==="base64"?atob(e.value).length:0}var $t={};Object.defineProperty($t,"__esModule",{value:true});$t.NetworkStorage=void 0;const Vt=r;const Wt=te;const Gt=qt;const Xt=we;class NetworkStorage{#o;#d;#e;#jr=new Map;#Kr=new Map;#Hr="default";constructor(e,t,r,s){this.#o=t;this.#d=e;r.on("Target.detachedFromTarget",(({sessionId:e})=>{this.disposeRequestMap(e)}));this.#e=s}#_r(e,t,r){let s=this.getRequestById(e);if(s)return s;s=new Gt.NetworkRequest(e,this.#d,this,t,r,this.#e);this.addRequest(s);return s}onCdpTargetCreated(e){const t=e.cdpClient;const r=[["Network.requestWillBeSent",t=>{const r=this.getRequestById(t.requestId);if(r&&r.isRedirecting()){r.handleRedirect(t);this.deleteRequest(t.requestId);this.#_r(t.requestId,e,r.redirectCount+1).onRequestWillBeSentEvent(t)}else this.#_r(t.requestId,e).onRequestWillBeSentEvent(t)}],["Network.requestWillBeSentExtraInfo",t=>{this.#_r(t.requestId,e).onRequestWillBeSentExtraInfoEvent(t)}],["Network.responseReceived",t=>{this.#_r(t.requestId,e).onResponseReceivedEvent(t)}],["Network.responseReceivedExtraInfo",t=>{this.#_r(t.requestId,e).onResponseReceivedExtraInfoEvent(t)}],["Network.requestServedFromCache",t=>{this.#_r(t.requestId,e).onServedFromCache()}],["Network.loadingFailed",t=>{this.#_r(t.requestId,e).onLoadingFailedEvent(t)}],["Fetch.requestPaused",t=>{this.#_r(t.networkId??t.requestId,e).onRequestPaused(t)}],["Fetch.authRequired",t=>{let r=this.getRequestByFetchId(t.requestId);r||(r=this.#_r(t.requestId,e));r.onAuthRequired(t)}]];for(const[e,s]of r)t.on(e,s)}getInterceptionStages(e){const t={request:false,response:false,auth:false};for(const r of this.#Kr.values())if(!r.contexts||r.contexts.includes(e)){t.request||=r.phases.includes("beforeRequestSent");t.response||=r.phases.includes("responseStarted");t.auth||=r.phases.includes("authRequired")}return t}getInterceptsForPhase(e,t){if(e.url===Gt.NetworkRequest.unknownParameter)return new Set;const r=new Set;for(const[s,n]of this.#Kr.entries())if(n.phases.includes(t)&&(!n.contexts||n.contexts.includes(e.cdpTarget.topLevelId)))if(n.urlPatterns.length!==0){for(const t of n.urlPatterns)if((0,Xt.matchUrlPattern)(t,e.url)){r.add(s);break}}else r.add(s);return r}disposeRequestMap(e){for(const t of this.#jr.values())if(t.cdpClient.sessionId===e){this.#jr.delete(t.id);t.dispose()}}addIntercept(e){const t=(0,Wt.uuidv4)();this.#Kr.set(t,e);return t}removeIntercept(e){if(!this.#Kr.has(e))throw new Vt.NoSuchInterceptException(`Intercept '${e}' does not exist.`);this.#Kr.delete(e)}getRequestsByTarget(e){const t=[];for(const r of this.#jr.values())r.cdpTarget===e&&t.push(r);return t}getRequestById(e){return this.#jr.get(e)}getRequestByFetchId(e){for(const t of this.#jr.values())if(t.fetchId===e)return t}addRequest(e){this.#jr.set(e.id,e)}deleteRequest(e){this.#jr.delete(e)}getNavigationId(e){return e===void 0?null:this.#o.findContext(e)?.navigationId??null}set defaultCacheBehavior(e){this.#Hr=e}get defaultCacheBehavior(){return this.#Hr}}$t.NetworkStorage=NetworkStorage;var Yt={};Object.defineProperty(Yt,"__esModule",{value:true});Yt.PreloadScriptStorage=void 0;class PreloadScriptStorage{#zr=new Set;find(e){return e?[...this.#zr].filter((t=>e.id!==void 0&&e.id===t.id||(!(e.targetId===void 0||!t.targetIds.has(e.targetId))||!(e.global===void 0||!(e.global&&t.contexts===void 0||!e.global&&t.contexts!==void 0))))):[...this.#zr]}add(e){this.#zr.add(e)}remove(e){for(const t of this.find(e))this.#zr.delete(t)}}Yt.PreloadScriptStorage=PreloadScriptStorage;var Jt={};Object.defineProperty(Jt,"__esModule",{value:true});Jt.RealmStorage=void 0;const Qt=r;const Zt=Ze;class RealmStorage{#$r=new Map;#Vr=new Map;get knownHandlesToRealmMap(){return this.#$r}addRealm(e){this.#Vr.set(e.realmId,e)}findRealms(e){return Array.from(this.#Vr.values()).filter((t=>(e.realmId===void 0||e.realmId===t.realmId)&&(!(e.browsingContextId!==void 0&&!t.associatedBrowsingContexts.map((e=>e.id)).includes(e.browsingContextId))&&((e.sandbox===void 0||t instanceof Zt.WindowRealm&&e.sandbox===t.sandbox)&&((e.executionContextId===void 0||e.executionContextId===t.executionContextId)&&((e.origin===void 0||e.origin===t.origin)&&((e.type===void 0||e.type===t.realmType)&&(e.cdpSessionId===void 0||e.cdpSessionId===t.cdpClient.sessionId))))))))}findRealm(e){const t=this.findRealms(e);if(t.length===1)return t[0]}getRealm(e){const t=this.findRealm(e);if(t===void 0)throw new Qt.NoSuchFrameException(`Realm ${JSON.stringify(e)} not found`);return t}deleteRealms(e){this.findRealms(e).map((e=>{e.dispose();this.#Vr.delete(e.realmId);Array.from(this.knownHandlesToRealmMap.entries()).filter((([,t])=>t===e.realmId)).map((([e])=>this.knownHandlesToRealmMap.delete(e)))}))}}Jt.RealmStorage=RealmStorage;var er={};Object.defineProperty(er,"__esModule",{value:true});er.Buffer=void 0;class Buffer{#Wr;#Gr=[];#Xr;
/**
   * @param capacity The buffer capacity.
   * @param onItemRemoved Delegate called for each removed element.
   */
constructor(e,t){this.#Wr=e;this.#Xr=t}get(){return this.#Gr}add(e){this.#Gr.push(e);while(this.#Gr.length>this.#Wr){const e=this.#Gr.shift();e!==void 0&&this.#Xr?.(e)}}}er.Buffer=Buffer;var tr={};Object.defineProperty(tr,"__esModule",{value:true});tr.DefaultMap=void 0;class DefaultMap extends Map{#Yr;constructor(e,t){super(t);this.#Yr=e}get(e){this.has(e)||this.set(e,this.#Yr(e));return super.get(e)}}tr.DefaultMap=DefaultMap;var rr={};Object.defineProperty(rr,"__esModule",{value:true});rr.distinctValues=distinctValues;rr.deterministicJSONStringify=deterministicJSONStringify;
/**
 * Returns an array of distinct values. Order is not guaranteed.
 * @param values - The values to filter. Should be JSON-serializable.
 * @return - An array of distinct values.
 */function distinctValues(e){const t=new Map;for(const r of e)t.set(deterministicJSONStringify(r),r);return Array.from(t.values())}
/**
 * Returns a stringified version of the object with keys sorted. This is required to
 * ensure that the stringified version of an object is deterministic independent of the
 * order of keys.
 * @param obj
 * @return {string}
 */function deterministicJSONStringify(e){return JSON.stringify(normalizeObject(e))}function normalizeObject(e){if(e===void 0||e===null||Array.isArray(e)||typeof e!=="object")return e;const t={};for(const r of Object.keys(e).sort()){const s=e[r];t[r]=normalizeObject(s)}return t}var sr={};Object.defineProperty(sr,"__esModule",{value:true});sr.IdWrapper=void 0;class IdWrapper{static#Jr=0;#z;constructor(){this.#z=++IdWrapper.#Jr}get id(){return this.#z}}sr.IdWrapper=IdWrapper;var nr={};Object.defineProperty(nr,"__esModule",{value:true});nr.isCdpEvent=isCdpEvent;nr.assertSupportedEvent=assertSupportedEvent;const ir=r;function isCdpEvent(e){return e.split(".").at(0)?.startsWith(ir.ChromiumBidi.BiDiModule.Cdp)??false}function assertSupportedEvent(e){if(!ir.ChromiumBidi.EVENT_NAMES.has(e)&&!isCdpEvent(e))throw new ir.InvalidArgumentException(`Unknown event: ${e}`)}var or={};Object.defineProperty(or,"__esModule",{value:true});or.SubscriptionManager=void 0;or.cartesianProduct=cartesianProduct;or.unrollEvents=unrollEvents;const ar=r;const cr=nr;function cartesianProduct(...e){return e.reduce(((e,t)=>e.flatMap((e=>t.map((t=>[e,t].flat()))))))}function unrollEvents(e){const t=new Set;function addEvents(e){for(const r of e)t.add(r)}for(const r of e)switch(r){case ar.ChromiumBidi.BiDiModule.Bluetooth:addEvents(Object.values(ar.ChromiumBidi.Bluetooth.EventNames));break;case ar.ChromiumBidi.BiDiModule.BrowsingContext:addEvents(Object.values(ar.ChromiumBidi.BrowsingContext.EventNames));break;case ar.ChromiumBidi.BiDiModule.Log:addEvents(Object.values(ar.ChromiumBidi.Log.EventNames));break;case ar.ChromiumBidi.BiDiModule.Network:addEvents(Object.values(ar.ChromiumBidi.Network.EventNames));break;case ar.ChromiumBidi.BiDiModule.Script:addEvents(Object.values(ar.ChromiumBidi.Script.EventNames));break;default:t.add(r)}return[...t.values()]}class SubscriptionManager{#Qr=0;#Zr=new Map;#o;constructor(e){this.#o=e}getChannelsSubscribedToEvent(e,t){const r=Array.from(this.#Zr.keys()).map((r=>({priority:this.#es(e,t,r),channel:r}))).filter((({priority:e})=>e!==null));return r.sort(((e,t)=>e.priority-t.priority)).map((({channel:e})=>e))}#es(e,t,r){const s=this.#Zr.get(r);if(s===void 0)return null;const n=this.#o.findTopLevelContextId(t);const i=[...new Set([null,n])];const o=i.map((t=>{const r=s.get(t)?.get(e);if((0,cr.isCdpEvent)(e)){const e=s.get(t)?.get(ar.ChromiumBidi.BiDiModule.Cdp);return r&&e?Math.min(r,e):r??e}return r})).filter((e=>e!==void 0));return o.length===0?null:Math.min(...o)}
/**
   * @param module BiDi+ module
   * @param contextId `null` == globally subscribed
   *
   * @returns
   */isSubscribedTo(e,t=null){const r=this.#o.findTopLevelContextId(t);for(const t of this.#Zr.values())for(const[s,n]of t.entries())if(r===s||s===null)for(const t of n.keys())if(t===e||t===e.split(".").at(0)||t.split(".").at(0)===e)return true;return false}
/**
   * Subscribes to event in the given context and channel.
   * @param {EventNames} event
   * @param {BrowsingContext.BrowsingContext | null} contextId
   * @param {BidiPlusChannel} channel
   * @return {SubscriptionItem[]} List of
   * subscriptions. If the event is a whole module, it will return all the specific
   * events. If the contextId is null, it will return all the top-level contexts which were
   * not subscribed before the command.
   */subscribe(e,t,r){t=this.#o.findTopLevelContextId(t);switch(e){case ar.ChromiumBidi.BiDiModule.BrowsingContext:return Object.values(ar.ChromiumBidi.BrowsingContext.EventNames).map((e=>this.subscribe(e,t,r))).flat();case ar.ChromiumBidi.BiDiModule.Log:return Object.values(ar.ChromiumBidi.Log.EventNames).map((e=>this.subscribe(e,t,r))).flat();case ar.ChromiumBidi.BiDiModule.Network:return Object.values(ar.ChromiumBidi.Network.EventNames).map((e=>this.subscribe(e,t,r))).flat();case ar.ChromiumBidi.BiDiModule.Script:return Object.values(ar.ChromiumBidi.Script.EventNames).map((e=>this.subscribe(e,t,r))).flat();case ar.ChromiumBidi.BiDiModule.Bluetooth:return Object.values(ar.ChromiumBidi.Bluetooth.EventNames).map((e=>this.subscribe(e,t,r))).flat();default:}this.#Zr.has(r)||this.#Zr.set(r,new Map);const s=this.#Zr.get(r);s.has(t)||s.set(t,new Map);const n=s.get(t);const i=(t===null?this.#o.getTopLevelContexts().map((e=>e.id)):[t]).filter((t=>!this.isSubscribedTo(e,t)));n.has(e)||n.set(e,this.#Qr++);return i.map((t=>({event:e,contextId:t})))}unsubscribeAll(e,t,r){for(const e of t)e!==null&&this.#o.getContext(e);const s=cartesianProduct(unrollEvents(e),t);s.map((([e,t])=>this.#ts(e,t,r))).forEach((e=>e()))}unsubscribe(e,t,r){this.unsubscribeAll([e],[t],r)}#ts(e,t,r){t=this.#o.findTopLevelContextId(t);if(!this.#Zr.has(r))throw new ar.InvalidArgumentException(`Cannot unsubscribe from ${e}, ${t===null?"null":t}. No subscription found.`);const s=this.#Zr.get(r);if(!s.has(t))throw new ar.InvalidArgumentException(`Cannot unsubscribe from ${e}, ${t===null?"null":t}. No subscription found.`);const n=s.get(t);if(!n.has(e))throw new ar.InvalidArgumentException(`Cannot unsubscribe from ${e}, ${t===null?"null":t}. No subscription found.`);return()=>{n.delete(e);n.size===0&&s.delete(e);s.size===0&&this.#Zr.delete(r)}}}or.SubscriptionManager=SubscriptionManager;var dr={};var ur;Object.defineProperty(dr,"__esModule",{value:true});dr.EventManager=void 0;const lr=r;const hr=er;const pr=tr;const gr=rr;const mr=t;const wr=sr;const fr=Ee;const vr=nr;const Cr=or;class EventWrapper{#rs=new wr.IdWrapper;#ss;#ns;constructor(e,t){this.#ns=e;this.#ss=t}get id(){return this.#rs.id}get contextId(){return this.#ss}get event(){return this.#ns}}const br=new Map([[lr.ChromiumBidi.Log.EventNames.LogEntryAdded,100]]);class EventManager extends mr.EventEmitter{#is=new pr.DefaultMap((()=>new Set));#os=new Map;#as=new Map;#cs;#o;#ds;constructor(e){super();this.#o=e;this.#cs=new Cr.SubscriptionManager(e);this.#ds=new pr.DefaultMap((()=>[]))}get subscriptionManager(){return this.#cs}static#us(e,t){return JSON.stringify({eventName:e,browsingContext:t})}addSubscribeHook(e,t){this.#ds.get(e).push(t)}registerEvent(e,t){this.registerPromiseEvent(Promise.resolve({kind:"success",value:e}),t,e.method)}registerPromiseEvent(e,t,r){const s=new EventWrapper(e,t);const n=this.#cs.getChannelsSubscribedToEvent(r,t);this.#ls(s,r);for(const t of n){this.emit("event",{message:fr.OutgoingMessage.createFromPromise(e,t),event:r});this.#hs(s,t,r)}}async subscribe(e,t,r){for(const t of e)(0,vr.assertSupportedEvent)(t);for(const e of t)e!==null&&this.#o.getContext(e);const s=[];for(const n of e)for(const e of t){s.push(...this.#cs.subscribe(n,e,r));for(const t of this.#ps(n,e,r)){this.emit("event",{message:fr.OutgoingMessage.createFromPromise(t.event,r),event:n});this.#hs(t,r,n)}}(0,gr.distinctValues)(s).forEach((({contextId:e,event:t})=>{this.#ds.get(t).forEach((t=>t(e)))}));await this.toggleModulesIfNeeded()}async unsubscribe(e,t,r){for(const t of e)(0,vr.assertSupportedEvent)(t);this.#cs.unsubscribeAll(e,t,r);await this.toggleModulesIfNeeded()}async toggleModulesIfNeeded(){await Promise.all(this.#o.getAllContexts().map((async e=>await e.toggleModulesIfNeeded())))}clearBufferedEvents(e){for(const t of br.keys()){const r=ur.#us(t,e);this.#os.delete(r)}}#ls(e,t){if(!br.has(t))return;const r=ur.#us(t,e.contextId);this.#os.has(r)||this.#os.set(r,new hr.Buffer(br.get(t)));this.#os.get(r).add(e);this.#is.get(t).add(e.contextId)}#hs(e,t,r){if(!br.has(r))return;const s=ur.#us(r,e.contextId);const n=Math.max(this.#as.get(s)?.get(t)??0,e.id);const i=this.#as.get(s);i?i.set(t,n):this.#as.set(s,new Map([[t,n]]))}#ps(e,t,r){const s=ur.#us(e,t);const n=this.#as.get(s)?.get(r)??-Infinity;const i=this.#os.get(s)?.get().filter((e=>e.id>n))??[];t===null&&Array.from(this.#is.get(e).keys()).filter((e=>e!==null&&this.#o.hasContext(e))).map((t=>this.#ps(e,t,r))).forEach((e=>i.push(...e)));return i.sort(((e,t)=>e.id-t.id))}}dr.EventManager=EventManager;ur=EventManager;var xr={};Object.defineProperty(xr,"__esModule",{value:true});xr.BidiServer=void 0;const yr=t;const Sr=e;const Pr=c;const Ir=Te;const Er=_e;const kr=Tt;const Tr=Ft;const Mr=$t;const Nr=Yt;const Rr=Jt;const Br=dr;let Dr=class BidiServer extends yr.EventEmitter{#gs;#ms;#ws;#d;#o=new Tr.BrowsingContextStorage;#a=new Rr.RealmStorage;#se=new Nr.PreloadScriptStorage;#ve;#e;#fs=e=>{void this.#ws.processCommand(e).catch((e=>{this.#e?.(Sr.LogType.debugError,e)}))};#vs=async e=>{const t=e.message;e.channel!==null&&(t.channel=e.channel);await this.#ms.sendMessage(t)};constructor(e,t,r,s,n,i,o){super();this.#e=o;this.#gs=new Pr.ProcessingQueue(this.#vs,this.#e);this.#ms=e;this.#ms.setOnMessage(this.#fs);this.#d=new Br.EventManager(this.#o);const a=new Mr.NetworkStorage(this.#d,this.#o,r,o);this.#ve=new Er.BluetoothProcessor(this.#d,this.#o);this.#ws=new Ir.CommandProcessor(t,r,this.#d,this.#o,this.#a,this.#se,a,this.#ve,i,(async e=>{await r.sendCommand("Security.setIgnoreCertificateErrors",{ignore:e.acceptInsecureCerts??false});new kr.CdpTargetManager(t,r,s,this.#d,this.#o,this.#a,a,this.#ve,this.#se,n,e?.["goog:prerenderingDisabled"]??false,e?.unhandledPromptBehavior,o);await r.sendCommand("Target.setDiscoverTargets",{discover:true});await r.sendCommand("Target.setAutoAttach",{autoAttach:true,waitForDebuggerOnStart:true,flatten:true,filter:[{type:"page",exclude:true},{}]});await this.#Cs()}),this.#e);this.#d.on("event",(({message:e,event:t})=>{this.emitOutgoingMessage(e,t)}));this.#ws.on("response",(({message:e,event:t})=>{this.emitOutgoingMessage(e,t)}))}static async createAndStart(e,t,r,s,n,i){const[{browserContextIds:o},{targetInfos:a}]=await Promise.all([r.sendCommand("Target.getBrowserContexts"),r.sendCommand("Target.getTargets")]);let c="default";for(const e of a)if(e.browserContextId&&!o.includes(e.browserContextId)){c=e.browserContextId;break}const d=new BidiServer(e,t,r,s,c,n,i);return d}emitOutgoingMessage(e,t){this.#gs.add(e,t)}close(){this.#ms.close()}async#Cs(){await Promise.all(this.#o.getTopLevelContexts().map((e=>e.lifecycleLoaded())))}};xr.BidiServer=Dr;var Fr={};Object.defineProperty(Fr,"__esModule",{value:true});Fr.OutgoingMessage=Fr.EventEmitter=Fr.BidiServer=void 0;var Or=xr;Object.defineProperty(Fr,"BidiServer",{enumerable:true,get:function(){return Or.BidiServer}});var Ar=t;Object.defineProperty(Fr,"EventEmitter",{enumerable:true,get:function(){return Ar.EventEmitter}});var qr=Ee;Object.defineProperty(Fr,"OutgoingMessage",{enumerable:true,get:function(){return qr.OutgoingMessage}});const Lr=Fr.__esModule,Ur=Fr.OutgoingMessage,jr=Fr.EventEmitter,Kr=Fr.BidiServer;export{Kr as BidiServer,jr as EventEmitter,Ur as OutgoingMessage,Lr as __esModule,Fr as default};

