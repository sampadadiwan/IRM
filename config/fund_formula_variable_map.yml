common_variables:
  ctx:
    - fund
    - fund_formula
    - allocation_run_id
    - bulk_insert_records
    - commitment_cache
    - end_date
    - sample
    - start_date
    - user_id
    - formula_index
    - formula_count
    - explain
    - form_type_id
    - allocation_run
  instance_variables:
    - "@fund"
    - "@start_date"
    - "@end_date"
    - "@remittances_collected"
    - "@remittances_called"
    - "@remittance_capital_fees"
    - "@remittance_other_fees"
    - "@distributions"
    - "@income_before_start_date"
    - "@expense_before_start_date"
    - "@units"
    - "@start_of_financial_year"
    # Dynamically generated from AccountEntry names (e.g., "Setup Fees" -> @setup_fees)
    - "@setup_fees"
    - "@management_fees"
    - "@total_capital_committed"

rules:
  GenerateCustomField:
    ctx: []
    instance_variables: [] # Inherits common_variables
    derived:
      - fund_unit_settings
      - capital_commitment
      - fund_unit_setting
      - ae

  AllocateAccountEntry:
    ctx:
      - name_or_entry_type
      - grouped
    instance_variables: [] # Inherits common_variables
    derived:
      - account_entries
      - individual_account_entries
      - parent
      - fund_account_entry
      - sub_ctx
      - ae

  AllocateAccountEntry-Name:
    inherits: AllocateAccountEntry

  AllocateAccountEntryIndividual-Name:
    inherits: AllocateAccountEntry

  AllocateAccountEntry-EntryType:
    inherits: AllocateAccountEntry

  AllocateAccountEntryIndividual-EntryType:
    inherits: AllocateAccountEntry

  AllocateMasterFundAccountEntry-Name:
    ctx:
      - name_or_entry_type
      - grouped
      - exchange_rate
    instance_variables: [] # Inherits common_variables
    derived:
      - master_fund_account_entries
      - master_fund_account_entries_by_folio
      - capital_commitment
      - master_aggregate_entry
      - feeder_aggregate_entry
      - account_entry
      - feeder_account_entry
      - parent
      - ae

  AllocateMasterFundAccountEntry-EntryType:
    inherits: AllocateMasterFundAccountEntry-Name

  AllocateMasterFundAccountEntryIndividual-Name:
    inherits: AllocateMasterFundAccountEntry-Name

  AllocateMasterFundAccountEntryIndividual-EntryType:
    inherits: AllocateMasterFundAccountEntry-Name

  CumulateAccountEntry:
    ctx: []
    instance_variables: [] # Inherits common_variables
    derived:
      - bulk_records
      - capital_commitment
      - cumulative_ae

  GenerateAccountEntry:
    ctx: []
    instance_variables: [] # Inherits common_variables
    derived:
      - fund_unit_settings
      - account_entry_names
      - capital_commitment
      - fund_unit_setting
      - entry_names
      - account_entry_name
      - name_prefix
      - ae

  AllocateAggregatePortfolios:
    ctx:
      - as_of_apis
    instance_variables: [] # Inherits common_variables
    derived:
      - orig_api
      - api
      - capital_commitment
      - ae

  AllocatePortfolioInvestment:
    ctx: []
    instance_variables: [] # Inherits common_variables
    derived:
      - portfolio_investments
      - capital_commitment
      - portfolio_investment
      - ae

  Percentage:
    ctx: []
    instance_variables: [] # Inherits common_variables
    derived:
      - field_name
      - total
      - count
      - cc_map
      - capital_commitment
      - last_ae
      - amount_cents
      - percentage
      - account_entry

  GeneratePortfolioNumbersForFund:
    ctx: []
    instance_variables: [] # Inherits common_variables
    derived:
      - portfolio_companies
      - fields
      - portfolio_company
      - aggregate_portfolio_investment
      - name
      - field
      - ae

  AllocateForPortfolioCompany:
    ctx:
      - for_folios
    instance_variables: [] # Inherits common_variables
    derived:
      - bulk_records
      - fund_ids
      - portfolio_companies
      - account_entry_names
      - portfolio_company
      - capital_commitments
      - capital_commitment
      - account_entry_name
      - ae
      - parent_name

  AllocateForPortfolioCompany-Folio:
    inherits: AllocateForPortfolioCompany